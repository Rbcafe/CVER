{
  "id": 1681275,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xNjgxMjc1",
  "url": "https://hackerone.com/reports/1681275",
  "title": "Dependecy Confusion via Lookup Request Forwarding to PyPi.org",
  "state": "Closed",
  "substate": "informative",
  "readable_substate": "Informative",
  "created_at": "2022-08-26T12:09:55.415Z",
  "submitted_at": "2022-08-26T12:09:55.451Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "usd-responsible-disclosure",
    "url": "/usd-responsible-disclosure",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/nggpko4d6iex28g2fmophdqsg576/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98?response-content-disposition=inline%3B%20filename%3D%22usd-logo.png%22%3B%20filename%2A%3DUTF-8%27%27usd-logo.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ7M54J673%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T142941Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQD%2FaXkHLiTu6JAlK%2F%2FJnx7CoOwtccnG75tgpYUKRnE3xgIhANREYBTpCaW3JM29ZZx8LW0d5%2BVqFzsx8ObXtUngWgMGKrEFCHcQAxoMMDEzNjE5Mjc0ODQ5IgzwBTCJ7KBGPnaqS%2FQqjgW%2BcrdfIx%2FSKxGuk6AHYcF%2FIRcvLyvZdIzwBqUcKAjP1Ior%2FMqJ33yw8cq8JXOrhT3SiP%2FwM%2Bu53Kuxy8H4MN5GBSEgiuQuG9nlkTsMSDNUsrTzPunwnriT%2BxkmzARMn5ZVPc%2BhTCcYbRF8UjxBFk0hq%2FmJsuMpTaHx7%2Fxrx6%2BPmTQBxbg23iAZF%2Fmgez%2FQ2HU40CJkcQww3886u2Rv%2FTY1NnCacfJtgYyToNbHWjQSUBN3BTsjWMDL5iQrcaeEmy9jTN1cBb5E%2BthOTBZ52d8dKMXI7EfAJmd2jsi0Ux8bAoDIgy8SrRd%2F0A0Nt6YeJJIm4VnVuWJ7wMWhQYMqhXPTxbxr2ANUslwzc%2BlOd39q7aLj1zAc5w3OnoZ9C74gcepXCJ92JP9%2FQDVjhiP2vXnj77JhlvEBMSJ1sDVGA3bzPKweK9dO5kmudF8K0gLugT2w7mboMx%2BWUEL94bfsth5Cr3%2BxRK%2FmDk1N8drxhcqT9pEoB7uhRHWjm5DjKzhxX%2FxpNEKuBgcBT%2FS5Q36%2FEBBcqdj8XuOl6U67CloKyunrrCSLhTFUaFHWCV%2BD%2BTNnGJ6jCn6%2Bd6OPn%2FZfKFCmhesLQicESfEP7vHbPUbnJ3tEwrS2UXMYBpH7KGj%2FTtPckuJyKgqLNn3Oq8VDPuJQVEMHRZweP%2Fakpvr8i2%2FNvwEQ8cCR7afoYqwI4zdKjqJgB7gULg3g2%2BTI6Swrsk3ygociks6FlHqYrBQ1Ic7elsq7b59POu8SYbpJd22D27eMK20HZzu7e%2FQOFeAELWUavctR67eOKXgPPOtktzshLAVvQU7CsYPcMEKxXdEEDesgLF%2By25RCmxQ7TW%2FnC04UIMsikew1kVRdz695f3pAIREw9eetrgY6sAFt5e%2FgBb3z6GUCPSY%2BbSpvu9318kCiOKXdmT8p52LNQRSkPxHFLhbrjTKuUqpurg1d3yQ%2B54ohHL%2FGB2jRPrX7qid5WdlXO42XDSEK0e2DQkICwpWfF9dhPwkvWoqnjmBr%2BZqGJOAD%2BDKfqMr9EVwgYEKWaPjJYoY9K5062IbgoYAcuYAxM2I2rDtSBCHlbaJlRKGx9j2%2FOO74MzSF65C7Em0o7VM2NP6pIOsd16f4tQ%3D%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=7e3c965f0eddaaf114f4379725d9bcbd5f4d52da5c111e92dcf977cd4ca082b0"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 264,
    "url": "https://hackerone.com/gitlab",
    "handle": "gitlab",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/f0hovtq73f9ap815a0r1w42bocp4/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/f0hovtq73f9ap815a0r1w42bocp4/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "GitLab",
      "twitter_handle": "gitlab",
      "website": "https://about.gitlab.com",
      "about": "A single application for the entire software development lifecycle."
    }
  },
  "has_bounty?": false,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": true,
  "disclosed_at": "2022-11-21T03:49:27.733Z",
  "bug_reporter_agreed_on_going_public_at": "2022-10-20T13:02:44.675Z",
  "team_member_agreed_on_going_public_at": "2022-11-21T03:49:27.550Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "### Summary\n\n*pip* is probably the most popular *Python* package manager and can be used to install packages from the publicly\navailable *Python Package Index* (*PyPi*) at [pypi.org](https://pypi.org) or form internal package repositories. In the beginning of 2021,\na vulnerability type called *Dependency Confusion* attracted some attention in the information security scene. Several\nhigh profiled companies were identified to accidentally load internal dependencies from the public available index\nat *PyPi*. This could have allowed any *PyPi* user to register packages with the accidentally requested names\nand to achieve remote code execution on the affected systems.\n\nThe underlying reason for the vulnerability was the usage of the `--extra-index-url` parameter when installing packages\nvia *pip*. This parameter adds additional packages sources where *pip* checks for the desired installation candidate. That\nbeing said, the publicly available index at *PyPi* remains within the sources and will be used if the requested version\nof the desired package can be found. In case of no version was specified, *pip* installs the most recent version it finds\namong all configured repositories.\n\nAfter the *Dependency Confusion* got publicly known, the general recommendation was to use `--index-url` instead of\n`--extra-index-url`, which replaces [pypi.org](https://pypi.org) as the default package registry. *GitLab*, however, still advises it's\nusers to use `--extra-index-url` within the web overview of a projects package registry. Therefore, users that are not\naware of *Dependency Confusion*, might accidentally install internal *GitLab* packages from the publicly available index\nat *PyPi*.\n\nMoreover, with version `14.2`, *GitLab* made even usage of `--index-url` not fail save. According to the\n[documentation](https://docs.gitlab.com/ee/user/admin_area/settings/continuous_integration.html#pypi-forwarding):\n\n> In GitLab 14.2 and later, when a PyPI package is not found in the Package Registry, the request is forwarded to pypi.org.\n\nThis configuration can lead to dangerous side effects when installing  internal packages with other internal dependencies\nor when using `--index-url` with another internal URL in the `--extra-index-url` parameter. *GitLab* defines package registries on\nthe project and group level. If package dependecies cross these project or group boundaries, dependecy confusion is possible.\n\n### Steps to reproduce\n\nFirst, we create a simple python project `usd-example-package` and make it available over the projects package\nregistry within *GitLab*. Viewing the webpage of the newly created package, it shows the following installation command:\n\n{F1885321}\n\nAs one can see, the suggested install command uses the `--extra-index-url` by default, which makes it vulnerable to\ndependency confusion.\n\nNow lets go one step further. Within our example package, we add an internal dependency `usd-example-dependecy`. This\ndependency is contained within another project and we add `--extra-index-url` to include this within the repository sources.\nThe installation command now looks like this:\n\n```console\n$ pip install usd-example-project --index-url https://gitlab.example.com/api/v4/projects/10/packages/pypi/simple --extra-index-url https://gitlab.example.com/api/v4/projects/11/packages/pypi/simple\n```\n\nSince `--index-url` was used, [pypi.org](https://pypi.org) should not be considered when searching for packages and the installation command\nshould be safe, right? Well, after launching the command, *pip* first loads `usd-example-project` from the URL specified\nas `--index-url`:\n\n```http\nGET /api/v4/projects/10/packages/pypi/simple/usd-example-dependecy/ HTTP/1.1\nHost: gitlab.example.com\n```\n\nAfterwards, the `--extra-index-url` is checked as described above, but since it belongs to our internal\ntrusted *GitLab* instance, this should be fine:\n\n```http\nGET /api/v4/projects/11/packages/pypi/simple/usd-example-project/ HTTP/1.1\nHost: gitlab.example.com\n```\n\nHowever, since `usd-example-package` is only distributed within the project\nwith ID 10, the registry for project ID 11 will not find the requested package and forward the request to *PyPi*:\n\n```http\nHTTP/1.1 302 Found\nLocation: https://pypi.org/simple/usd-example-project/\n```\n\nNow, although we used `--index-url`, we are again vulnerable to dependency confusion.\n\n### Fix\n\nThe reported issue should be fixed by making the following adjustments:\n\n1. The insecure installation command suggested by the repository webpages should be replaced. Instead of `--extra-index-url`,\n   the `--index-url` command line option should be chosen.\n2. Forwarding of requests for unknown packages to [pypi.org](https://pypi.org) should be disabled by default. This setting can have dangerous side\n   effects and should not be enabled by default. Administrators that understand the consequences could still enable the feature\n   for their instance.\n\nWe are aware that automatic forwarding of unknown packages to *PyPi* increases the usability of internal package registries\nquite a lot. Installation of internal tools and dependencies usually also requires installation of packages that are available\non *PyPi*. Restricting the index to an internal repository makes automatic installation of these external dependencies fail,\nwhich creates some additional installation effort. That being said, the accidental installation of potentially malicious software\nfrom a public package registry represents a high security risk for organisations and should be classified as more important as\nusability.\n\nAnother possible solution would be to only allow forwarding requests to *PyPi* for packages that are not available within the\nwhole internal *GitLab* instance.\n\n### References\n\n* https://medium.com/@alex.birsan/dependency-confusion-4a5d60fec610\n* https://docs.gitlab.com/ee/user/packages/pypi_repository/\n* https://docs.gitlab.com/ee/user/admin_area/settings/continuous_integration.html#pypi-forwarding\n\n### Credits\nThis security vulnerability was identified by [Tobias Neitzel](https://twitter.com/qtc_de) of [usd AG](https://www.usd.de/).\n\n## Impact\n\nDependency Confusion can lead to remote code execution (RCE) on systems that use the insecure installation command. This usually affects developer machines or GitLab runners, but also endusers can be affected.",
  "weakness": {
    "id": 145,
    "name": "Misconfiguration"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [
    {
      "id": 1885321,
      "file_name": "usd-2022-0042.png",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/i7a8mrphqr3cof6eyirer158ooj5?response-content-disposition=attachment%3B%20filename%3D%22usd-2022-0042.png%22%3B%20filename%2A%3DUTF-8%27%27usd-2022-0042.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ7M54J673%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T142941Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQD%2FaXkHLiTu6JAlK%2F%2FJnx7CoOwtccnG75tgpYUKRnE3xgIhANREYBTpCaW3JM29ZZx8LW0d5%2BVqFzsx8ObXtUngWgMGKrEFCHcQAxoMMDEzNjE5Mjc0ODQ5IgzwBTCJ7KBGPnaqS%2FQqjgW%2BcrdfIx%2FSKxGuk6AHYcF%2FIRcvLyvZdIzwBqUcKAjP1Ior%2FMqJ33yw8cq8JXOrhT3SiP%2FwM%2Bu53Kuxy8H4MN5GBSEgiuQuG9nlkTsMSDNUsrTzPunwnriT%2BxkmzARMn5ZVPc%2BhTCcYbRF8UjxBFk0hq%2FmJsuMpTaHx7%2Fxrx6%2BPmTQBxbg23iAZF%2Fmgez%2FQ2HU40CJkcQww3886u2Rv%2FTY1NnCacfJtgYyToNbHWjQSUBN3BTsjWMDL5iQrcaeEmy9jTN1cBb5E%2BthOTBZ52d8dKMXI7EfAJmd2jsi0Ux8bAoDIgy8SrRd%2F0A0Nt6YeJJIm4VnVuWJ7wMWhQYMqhXPTxbxr2ANUslwzc%2BlOd39q7aLj1zAc5w3OnoZ9C74gcepXCJ92JP9%2FQDVjhiP2vXnj77JhlvEBMSJ1sDVGA3bzPKweK9dO5kmudF8K0gLugT2w7mboMx%2BWUEL94bfsth5Cr3%2BxRK%2FmDk1N8drxhcqT9pEoB7uhRHWjm5DjKzhxX%2FxpNEKuBgcBT%2FS5Q36%2FEBBcqdj8XuOl6U67CloKyunrrCSLhTFUaFHWCV%2BD%2BTNnGJ6jCn6%2Bd6OPn%2FZfKFCmhesLQicESfEP7vHbPUbnJ3tEwrS2UXMYBpH7KGj%2FTtPckuJyKgqLNn3Oq8VDPuJQVEMHRZweP%2Fakpvr8i2%2FNvwEQ8cCR7afoYqwI4zdKjqJgB7gULg3g2%2BTI6Swrsk3ygociks6FlHqYrBQ1Ic7elsq7b59POu8SYbpJd22D27eMK20HZzu7e%2FQOFeAELWUavctR67eOKXgPPOtktzshLAVvQU7CsYPcMEKxXdEEDesgLF%2By25RCmxQ7TW%2FnC04UIMsikew1kVRdz695f3pAIREw9eetrgY6sAFt5e%2FgBb3z6GUCPSY%2BbSpvu9318kCiOKXdmT8p52LNQRSkPxHFLhbrjTKuUqpurg1d3yQ%2B54ohHL%2FGB2jRPrX7qid5WdlXO42XDSEK0e2DQkICwpWfF9dhPwkvWoqnjmBr%2BZqGJOAD%2BDKfqMr9EVwgYEKWaPjJYoY9K5062IbgoYAcuYAxM2I2rDtSBCHlbaJlRKGx9j2%2FOO74MzSF65C7Em0o7VM2NP6pIOsd16f4tQ%3D%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=5836b2758e2820f9b0eb11569c4bcbb580dcaff814b228e5a188262dee13b167",
      "file_size": 37692,
      "type": "image/png",
      "moderated": null
    }
  ],
  "allow_singular_disclosure_at": null,
  "vote_count": 4,
  "voters": [
    "zy9ard3",
    "dnelsaka",
    "shivammusic",
    "abhi6900"
  ],
  "structured_scope": {
    "databaseId": 39022,
    "asset_type": "OTHER",
    "asset_identifier": "Your Own GitLab Instance",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
