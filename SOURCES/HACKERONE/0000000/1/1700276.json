{
  "id": 1700276,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xNzAwMjc2",
  "url": "https://hackerone.com/reports/1700276",
  "title": "Take over subdomains of r2.dev using R2 custom domains",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "medium",
  "readable_substate": "Resolved",
  "created_at": "2022-09-14T16:05:12.737Z",
  "submitted_at": "2022-09-14T16:05:12.886Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "albertspedersen",
    "url": "/albertspedersen",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/57i177382uzbptw7rg8wpc509mll/ede8cd84a64d5392a2bb88ecb598721116469c27c015c2caa77148f11e211d58"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 41,
    "url": "https://hackerone.com/cloudflare",
    "handle": "cloudflare",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/000/041/a819f0d518a4854df667be26210167805f38a6a4_original.png/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/000/000/041/a819f0d518a4854df667be26210167805f38a6a4_original.png/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Cloudflare Public Bug Bounty",
      "twitter_handle": "cloudflare",
      "website": "https://www.cloudflare.com/disclosure",
      "about": "Help us build a better Internet"
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": true,
  "disclosed_at": "2022-09-28T12:49:46.895Z",
  "bug_reporter_agreed_on_going_public_at": "2022-09-15T13:07:37.600Z",
  "team_member_agreed_on_going_public_at": "2022-09-28T12:49:46.795Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "> **███████** ████ [████ █████████]██████████████████ ███ ██████████\n\nIt is possible to take over any subdomain of `r2.dev` (possible also the base domain) and have it serve the contents of an R2 bucket in your account.\n\n### Requirements\n\nAccess to R2 public buckets in the dashboard is currently behind a flag. The server-side check for access to R2 public buckets was recently removed, so you can just use an mitmproxy script to toggle the flag client-side.\n\n```py\nimport json\nimport mitmproxy\nimport re\n\n\nclass R2PublicBuckets:\n\tasync def response(self, flow: mitmproxy.http.HTTPFlow):\n\t\tif re.match(r'https?://dash\\.cloudflare\\.com/api/v4/accounts/[0-9a-f]{32}/flags', flow.request.url):\n\t\t\tdata = json.loads(flow.response.text)\n\t\t\tdata['result']['workers']['r2_publicbuckets'] = True\n\t\t\tflow.response.text = json.dumps(data, separators=(',', ':'))\n\naddons = [\n\tR2PublicBuckets()\n]\n```\n\n### Steps\n\n1. Add `r2.dev` to your Cloudflare account and follow the steps until you're asked to complete zone ownership verification.\n\n2. Create an R2 bucket if you don't already have one and add e.g. `albert.r2.dev` as a custom domain in the \"Domain Access\" section.\n\n{F1926348}\n\n3. Wait a few seconds and then refresh the page. The custom domain should now show \"Status: Active\". In case \"Access to Bucket\" is \"Not allowed\", click the three dots besides the domain and then \"Enable domain\".\n\n{F1926346}\n\n4. Visit the custom domain and notice how it serves content from your R2 bucket.\n\n{F1926347}\n\nAdditionally, this vulnerability can also be used to *block* another domain from being used as an R2 custom domain. Simply repeat step one and two for the target zone/domain. If the user tries to add the domain as a custom domain for their R2 bucket, the API will throw an error and the custom domain will be activated in your account. The target domain will then serve the contents of your bucket until the user deletes the custom domain (which will show \"Status: Error\") on their end. An example of this is https://r2.walshy.dev/.\n\n### Cause\n\nThis vulnerability exists because the API does not check if the zone is active before adding the specified domain as an SSL for SaaS custom hostname. I presume taking over subdomains of `r2.dev` is only possible because they're in the same zone as the fallback origin, and/or there's already a CNAME record on `*.r2.dev` pointing to the fallback origin (`public.r2.dev`).\n\n## Impact\n\nEvery R2 bucket has a `pub-<public_id>.r2.dev` subdomain which, when public bucket access is enabled, will serve the contents of the bucket. This vulnerability can be used to take over those subdomains and instead have them serve content from your bucket.",
  "bounty_amount": "1125.0",
  "formatted_bounty": "$1,125",
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [
    {
      "id": 1926346,
      "file_name": "custom-domain-active.png",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/9ln06v2v2i8shfa2w7m2vrb0wcht?response-content-disposition=attachment%3B%20filename%3D%22custom-domain-active.png%22%3B%20filename%2A%3DUTF-8%27%27custom-domain-active.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQSGD4AUG7%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T143027Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQDpFrYOsYB5%2FZnNgefzkV44NzOEteiLNr5fTaq13l6JbwIhAOtMLRNQibBBBQxVAxTqTJbMe1i9E5%2B1umZpNEn1KLyWKrIFCHcQAxoMMDEzNjE5Mjc0ODQ5IgyMBkX2hVh%2BhOexaD0qjwWIVul16aokM%2B%2Bk3syXpumdmzjMxBJZIlILTLHDJJHPrp2ZulcJH5q8hr9%2Bpzae%2FyLNUn3QxArdyG9%2Bs%2FxGCEp4uZNVh%2BRETskKt1TTkBBRYx15m1k85ya0qUhv5MdFnIOgnN%2BUWZz1KczjvI%2F9gU0cFH5qy0jkk0I0a6XKsrqTyUBwjrz3RWZzAEvvKYZjHVOrSfeF4C%2BLkz%2BCi%2B7CB11hXtvApsy6s5ePqH91wth7AZHeZAfYwp4Jnbh1p8KmbK30Q47o97dgiNK9E0ES5ZpULPKTxo%2FhRByGRQHuR396JknClT4rG1WurwWjsEx1iTWp3%2BIyTzoS79dILDtAL%2F4k6kS82%2BTv041OCmlhT2B%2Ft31QPcmKZ6jmLgkpliqLSmJDm90SuNY88u223KuIbsJpgJHAObccd017eHct%2FkVwHEB%2BWYeet8ZAMA08ytFzqBv2hcgKOkqLW5Es9oxAzTSbck%2BQRB6jSoC0NgXimudsmbneFbg7yF0Y4IBopwxKtxzDjFFgbqtU9cifZxLTARKETqFVYNINfaUl1vUUUvvkTDk0CNMbrAubZXn7s0fQcUJiBZyRPwXoLHa175h9cNhBU%2FOLVWTdnO4PBAbW3lSNaGkkw83zfmu4x1evle4xFNUDEFXt%2FCNtrb5Xuz1UPtXUEMIsbJZyfLVfMsZqnXu3XD%2BgaLXVFeOtUZvtS%2BIOszbnbTkQRmQ1C%2BxZYiTZYZZuq2Txxz0OVd%2FxefqHFQPV1seIRusOsVC4oy1XhH0CCINVqoCeaTiePOtTAuKY03KLGUc6WfkNBXO%2BiVaNwyTB8btNWytKGGVTY2wswL4EamHwyISg4jCGjpNEMarw6vV5fAIj9BUCtLwnocnN45LiMPXura4GOrABXhfw1V%2BVbu3djc3Jv5AaOf2JhHj80K2MUdzk1WSbySNmDeWK9ok%2FYyzcrq0MY0OW%2Bl8NMAkgeiT3MzBHvXRej72j35zM40rM4yOAw%2BPSNL4BdRz0Hdu5xBbq9Ne4xLyjRbZ4%2FFXajcCr8XcRm47GzUGEyrM2FhYCbhQkAe3yQa%2FttcE2P8mDMzi6ernjG0nfaKdYSIZw8giUSplPOv6L5R2e48BOSJBGCcNI6hcDZtM%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=67627b3783a86109c7bab57a3b6c03e62617fad793900e7ca8a2984d7d8ea0c9",
      "file_size": 7406,
      "type": "image/png",
      "moderated": null
    },
    {
      "id": 1926347,
      "file_name": "visit-custom-domain.png",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/7b594roqld8ynelsy8vbse1gmdug?response-content-disposition=attachment%3B%20filename%3D%22visit-custom-domain.png%22%3B%20filename%2A%3DUTF-8%27%27visit-custom-domain.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQSGD4AUG7%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T143027Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQDpFrYOsYB5%2FZnNgefzkV44NzOEteiLNr5fTaq13l6JbwIhAOtMLRNQibBBBQxVAxTqTJbMe1i9E5%2B1umZpNEn1KLyWKrIFCHcQAxoMMDEzNjE5Mjc0ODQ5IgyMBkX2hVh%2BhOexaD0qjwWIVul16aokM%2B%2Bk3syXpumdmzjMxBJZIlILTLHDJJHPrp2ZulcJH5q8hr9%2Bpzae%2FyLNUn3QxArdyG9%2Bs%2FxGCEp4uZNVh%2BRETskKt1TTkBBRYx15m1k85ya0qUhv5MdFnIOgnN%2BUWZz1KczjvI%2F9gU0cFH5qy0jkk0I0a6XKsrqTyUBwjrz3RWZzAEvvKYZjHVOrSfeF4C%2BLkz%2BCi%2B7CB11hXtvApsy6s5ePqH91wth7AZHeZAfYwp4Jnbh1p8KmbK30Q47o97dgiNK9E0ES5ZpULPKTxo%2FhRByGRQHuR396JknClT4rG1WurwWjsEx1iTWp3%2BIyTzoS79dILDtAL%2F4k6kS82%2BTv041OCmlhT2B%2Ft31QPcmKZ6jmLgkpliqLSmJDm90SuNY88u223KuIbsJpgJHAObccd017eHct%2FkVwHEB%2BWYeet8ZAMA08ytFzqBv2hcgKOkqLW5Es9oxAzTSbck%2BQRB6jSoC0NgXimudsmbneFbg7yF0Y4IBopwxKtxzDjFFgbqtU9cifZxLTARKETqFVYNINfaUl1vUUUvvkTDk0CNMbrAubZXn7s0fQcUJiBZyRPwXoLHa175h9cNhBU%2FOLVWTdnO4PBAbW3lSNaGkkw83zfmu4x1evle4xFNUDEFXt%2FCNtrb5Xuz1UPtXUEMIsbJZyfLVfMsZqnXu3XD%2BgaLXVFeOtUZvtS%2BIOszbnbTkQRmQ1C%2BxZYiTZYZZuq2Txxz0OVd%2FxefqHFQPV1seIRusOsVC4oy1XhH0CCINVqoCeaTiePOtTAuKY03KLGUc6WfkNBXO%2BiVaNwyTB8btNWytKGGVTY2wswL4EamHwyISg4jCGjpNEMarw6vV5fAIj9BUCtLwnocnN45LiMPXura4GOrABXhfw1V%2BVbu3djc3Jv5AaOf2JhHj80K2MUdzk1WSbySNmDeWK9ok%2FYyzcrq0MY0OW%2Bl8NMAkgeiT3MzBHvXRej72j35zM40rM4yOAw%2BPSNL4BdRz0Hdu5xBbq9Ne4xLyjRbZ4%2FFXajcCr8XcRm47GzUGEyrM2FhYCbhQkAe3yQa%2FttcE2P8mDMzi6ernjG0nfaKdYSIZw8giUSplPOv6L5R2e48BOSJBGCcNI6hcDZtM%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=6291aeb3692abb095922c5d4c0e5ad1685e0e1419cb90f8c12f70440cfa5f03c",
      "file_size": 36891,
      "type": "image/png",
      "moderated": null
    },
    {
      "id": 1926348,
      "file_name": "add-custom-domain.png",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/hnucg39ob10ykt5pxteq0v3qtkgq?response-content-disposition=attachment%3B%20filename%3D%22add-custom-domain.png%22%3B%20filename%2A%3DUTF-8%27%27add-custom-domain.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQSGD4AUG7%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T143027Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQDpFrYOsYB5%2FZnNgefzkV44NzOEteiLNr5fTaq13l6JbwIhAOtMLRNQibBBBQxVAxTqTJbMe1i9E5%2B1umZpNEn1KLyWKrIFCHcQAxoMMDEzNjE5Mjc0ODQ5IgyMBkX2hVh%2BhOexaD0qjwWIVul16aokM%2B%2Bk3syXpumdmzjMxBJZIlILTLHDJJHPrp2ZulcJH5q8hr9%2Bpzae%2FyLNUn3QxArdyG9%2Bs%2FxGCEp4uZNVh%2BRETskKt1TTkBBRYx15m1k85ya0qUhv5MdFnIOgnN%2BUWZz1KczjvI%2F9gU0cFH5qy0jkk0I0a6XKsrqTyUBwjrz3RWZzAEvvKYZjHVOrSfeF4C%2BLkz%2BCi%2B7CB11hXtvApsy6s5ePqH91wth7AZHeZAfYwp4Jnbh1p8KmbK30Q47o97dgiNK9E0ES5ZpULPKTxo%2FhRByGRQHuR396JknClT4rG1WurwWjsEx1iTWp3%2BIyTzoS79dILDtAL%2F4k6kS82%2BTv041OCmlhT2B%2Ft31QPcmKZ6jmLgkpliqLSmJDm90SuNY88u223KuIbsJpgJHAObccd017eHct%2FkVwHEB%2BWYeet8ZAMA08ytFzqBv2hcgKOkqLW5Es9oxAzTSbck%2BQRB6jSoC0NgXimudsmbneFbg7yF0Y4IBopwxKtxzDjFFgbqtU9cifZxLTARKETqFVYNINfaUl1vUUUvvkTDk0CNMbrAubZXn7s0fQcUJiBZyRPwXoLHa175h9cNhBU%2FOLVWTdnO4PBAbW3lSNaGkkw83zfmu4x1evle4xFNUDEFXt%2FCNtrb5Xuz1UPtXUEMIsbJZyfLVfMsZqnXu3XD%2BgaLXVFeOtUZvtS%2BIOszbnbTkQRmQ1C%2BxZYiTZYZZuq2Txxz0OVd%2FxefqHFQPV1seIRusOsVC4oy1XhH0CCINVqoCeaTiePOtTAuKY03KLGUc6WfkNBXO%2BiVaNwyTB8btNWytKGGVTY2wswL4EamHwyISg4jCGjpNEMarw6vV5fAIj9BUCtLwnocnN45LiMPXura4GOrABXhfw1V%2BVbu3djc3Jv5AaOf2JhHj80K2MUdzk1WSbySNmDeWK9ok%2FYyzcrq0MY0OW%2Bl8NMAkgeiT3MzBHvXRej72j35zM40rM4yOAw%2BPSNL4BdRz0Hdu5xBbq9Ne4xLyjRbZ4%2FFXajcCr8XcRm47GzUGEyrM2FhYCbhQkAe3yQa%2FttcE2P8mDMzi6ernjG0nfaKdYSIZw8giUSplPOv6L5R2e48BOSJBGCcNI6hcDZtM%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=f304a7b7bc515423d578c03e58e1e746b8f368c274cba2a4b27429ff1922d187",
      "file_size": 42438,
      "type": "image/png",
      "moderated": null
    }
  ],
  "allow_singular_disclosure_at": null,
  "vote_count": 26,
  "voters": [
    "dninjadave",
    "n1m0",
    "zy9ard3",
    "hrithikbot",
    "ashrafabdelrazik",
    "khizer47",
    "kerolesmagdy",
    "pishangshedappp",
    "shivammusic",
    "hariharan-s",
    "and 16 more..."
  ],
  "severity": {
    "rating": "medium",
    "author_type": "User"
  },
  "structured_scope": {
    "databaseId": 103824,
    "asset_type": "OTHER",
    "asset_identifier": "Cloudflare R2",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "id": 195006,
      "category": "team",
      "content": "The Cloudflare R2 Custom Domain feature could be used to take over any subdomain of r2.dev without being verified.\nThe Cloudflare Custom Domain feature allows the customer to configure a CNAME pointing to the r2.dev bucket URL.\nThis attack was possible due to lack of domain validation when the user adds a domain to the account.\nA control has been implemented to verify that the R2 Custom Domain added has been verified and belongs to the same Cloudflare account. \nAfter investigation, it was concluded that there is no evidence of abuse of this issue by anyone other than the researcher and there was no impact to any customer.",
      "user": {
        "id": 1982881,
        "username": "y0ka1",
        "name": "Jonathan N",
        "bio": "",
        "cleared": false,
        "verified": false,
        "website": null,
        "location": "",
        "created_at": "2021-09-24T07:51:07.909Z",
        "url": "https://hackerone.com/y0ka1",
        "hackerone_triager": false,
        "hackerone_employee": false,
        "user_type": "company",
        "profile_picture_urls": {
          "small": "/assets/avatars/default-25f7248a18bdf9e2dc8310319b148d66cff430fa0fade6c5f25fee1b8d7f27ed.png",
          "medium": "/assets/avatars/default-25f7248a18bdf9e2dc8310319b148d66cff430fa0fade6c5f25fee1b8d7f27ed.png",
          "xtralarge": "/assets/avatars/default-25f7248a18bdf9e2dc8310319b148d66cff430fa0fade6c5f25fee1b8d7f27ed.png"
        }
      },
      "can_view?": true,
      "can_create?": false,
      "attachments": []
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
