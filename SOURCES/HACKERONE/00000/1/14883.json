{
  "id": 14883,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xNDg4Mw==",
  "url": "https://hackerone.com/reports/14883",
  "title": "[mobile.twitter.com / twitter.com] CSRF protection bypass",
  "state": "Closed",
  "substate": "resolved",
  "readable_substate": "Resolved",
  "created_at": "2014-06-03T14:36:02.177Z",
  "submitted_at": "2014-06-03T14:36:02.177Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "bobrov",
    "url": "/bobrov",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/002/205/e865d3ffcef54eba49cba80bd59502a347519715_original.jpeg/ede8cd84a64d5392a2bb88ecb598721116469c27c015c2caa77148f11e211d58"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 61,
    "url": "https://hackerone.com/x",
    "handle": "x",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/ikx4ept298unt534kpz4am2bd4zs/3c7b305354c9073c106ae3d1701798defaaf5be844fb8fdfa49ca62f991a2c2c",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/ikx4ept298unt534kpz4am2bd4zs/f4a495c04fdb224bac8ec64587537e511aa8c4925e7955bee0a19e0ed7d891dc"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "X (Formerly Twitter)",
      "twitter_handle": "XSecurity",
      "website": "https://x.com",
      "about": "X helps you create and share ideas and information instantly, without barriers."
    }
  },
  "has_bounty?": false,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": true,
  "disclosed_at": "2015-05-04T16:09:44.389Z",
  "bug_reporter_agreed_on_going_public_at": "2015-05-04T08:05:42.656Z",
  "team_member_agreed_on_going_public_at": "2015-05-04T16:09:43.946Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "I shall explain all the steps to create the final PoC in order to be more clear.\r\n\r\nPart 1. Cookie Injection via Google Analytics\r\n\r\n1) Google Analytics sets the cookie to track user source:\r\n123456.123456789.11.2.utmcsr=[HOST]|utmccn=(referral)|utmcmd=referral|utmcct=[PATH]\r\nFor example:\r\n123456.123456789.11.2.utmcsr=blackfan.ru|utmccn=(referral)|utmcmd=referral|utmcct=/path/\r\n2) User fully controls path in Referer and it is not filtered before being put in __utmz\r\n\r\n\r\nPart 2. Cookie parsing peculiarities by different web servers\r\n\r\n1) A typical Cookie sent by a web browser looks like this: \r\nCookie: param1=value1; param2=value2;\r\n2) Many web servers accept cookies delimited not only by semicolons but also by commas: \r\nCookie: param1=value2, param2=value2 \r\nCookie: param1=value2,param2=value2\r\n3) If there are several cookies with the same name different web servers may use only the first occurrence or the last one\r\n\r\n\r\nPart 3. Cookie handling peculiarities in different web browsers \r\n\r\n1) For all the web browsers except Safari characters of space, comma, and [ \\ ] can be used as cookie values (Safari accept cookies delimited by commas)\r\n2) Chrome handles only a limited number of cookie-attributes, e.g.: \r\nSet-Cookie: test=test; domain=.google.com; domain=.google.com; domain=.google.com; domain=.google.com; domain=.google.com; domain=.google.com; domain=.google.com; domain=.google.com; domain=.google.com; domain=.google.com; domain=.google.com; domain=.google.com; domain=.google.com; domain=.google.com; domain=.google.com; domain=blah.blah.blah.google.com;\r\nwill set cookie for .google.com but not for blah.blah.blah.google.com\r\n\r\n\r\nCombining all these facts:\r\n\r\nProvided that:\r\n1) a site uses Google Analytics\r\nand\r\n2) this site is hosted by a web server that has some of the aforementioned cookie parsing peculiarities \r\nand\r\n3) this site implements Cookie based CSRF protection (a value in Cookie and some request parameter must be equal)\r\n\r\nThen:\r\n1) We can set new arbitrary cookies or redefine the values of existing ones\r\n2) This site is vulnerable to CSRF protection bypass\r\n\r\n\r\nThe principal problem of __utmz cookie is that it is set for six months and is not refreshed. This problem can be solved in Google Chrome if you find a subdomain with Google Analytics and rewrite attribute «domain» using the peculiarity that has been described in part 3 with the value «.site.com».\r\n\r\nIn other browsers the vulnerability can be exploited by cookie injection at the moment of __utmz refreshing.\r\n\r\n\r\nVulnerability exploitation on twitter.com with Google Chrome:\r\n\r\n1) A user authenticates on twitter.com\r\n2) We make him visit the link below assuming that he has not visited translate.twitter.com and he doesn’t have __utmz set on this subdomain: \r\nhttp://blackfan.ru/r/,m5_csrf_tkn=x,;domain=.twitter.com;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;?r=http://translate.twitter.com/ \r\nCookie is rewritten with new path and domain, as a result cookie is set for .twitter.com: \r\n__utmz=90378079.1401435337.1.1.utmcsr=bf.am|utmccn=(referral)|utmcmd=referral|utmcct=/r/,m5_csrf_tkn=x,\r\n3) At this moment user of desktop version of the site does not have cookie on mobile.twitter.com, that is why this request to the web server will make it believe that cookie __utmz consists of two cookies and CSRF token equals to «x» \r\n4) Submit «compose tweet» form using CSRF-token «x» on mobile.twitter.com\r\n\r\n\r\nPoC:\r\nFollow @Black2Fan\r\nhttp://blackfan.ru/twitterbugbounty/03f75200fdb99239ff35d1d317303857_follow.html\r\n\r\nTweet \"wut -.-\"\r\nhttp://blackfan.ru/twitterbugbounty/485d0a1204ff970e702aabb5f0379d73_tweet.html",
  "weakness": {
    "id": 45,
    "name": "Cross-Site Request Forgery (CSRF)"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2015-06-03T08:05:43.082Z",
  "allow_singular_disclosure_after": -274505021.0430518,
  "singular_disclosure_allowed": true,
  "vote_count": 4,
  "voters": [
    "bobrov",
    "dxin301",
    "h4x0r_dz",
    "shivammusic"
  ],
  "structured_scope": null,
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
