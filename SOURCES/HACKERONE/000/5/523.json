{
  "id": 523,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC81MjM=",
  "url": "https://hackerone.com/reports/523",
  "title": "PHP openssl_x509_parse() Memory Corruption Vulnerability",
  "state": "Closed",
  "substate": "resolved",
  "readable_substate": "Resolved",
  "created_at": "2013-11-30T23:00:00.000Z",
  "submitted_at": "2013-11-30T23:00:00.000Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "sesser",
    "url": "/sesser",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/002/019/5fb844ae631311d29fcfc7d8e088a6e7358526db_original.jpeg/ede8cd84a64d5392a2bb88ecb598721116469c27c015c2caa77148f11e211d58"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 54349,
    "url": "https://hackerone.com/ibb",
    "handle": "ibb",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ2JWCBEGQ%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T112329Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQC%2FUOBUX4k3hk3E%2Be6snO9LPeTekkyoO2NoMEQpFLXEBwIhAJtkXXn5eL0ikTtvqv%2F2fgGtuhZUPvLulWFuhYzEiLfuKrAFCG8QAxoMMDEzNjE5Mjc0ODQ5Igx%2BsOWizWfx0tzigpsqjQUuFNaEEdzMHGeLBy6s%2Bkoye8hS0hWPfE4WrdAunw9kpHYBx3YQZH%2FutD5pqzkJ0%2FpSWNbJpNfcWoCwQfdsMFN%2F3JTaogDPpUe%2FUAwScnqabVUL9jhgbAfxzoi6vdePXcWwC3rPpDdJZOWII30adweaKN3r73pvMjzWQOzrFwQRQ2qqkd6ueKTpUI%2Fv4YvwK2UEvpnWlXVfdWza8QTDZ%2BVAhjMIgYhtNwiWvsrwTlWirEbz9gqK%2FzOzBvugRZ98k6lTo4fLL9%2F23SfytoJCVdDDIwGtU9XGeEckRTNfnCgQgTT%2FZaoU54aipxAM0Bk2%2FOy9qyQgNo%2Bc4a%2BtxjohyY6lmRwPOUw0Pc6tciCZLAfzTSCwKGLeWeoHYecu2a8TObYqts0FTVzlDxQi0dXbDKcGkreaslLTdMzFIWj7k%2FvKf0zZ7SIjn5wlEWYmpN6UNwCGxRlHEIiWuB874izqCmy7qw9LCJb0ZLpm1%2FSPsUBljWnIWg8YKhR5G%2BlRT4AnTpGmbQ1duSnA4UOAFqFF9ooGKFMwleUudDqIrFYn0NrgGkKuZ0FyHukrzdoftt2m1CLmNvKjrzoE0ES2uqov8Tj9QQRIEQFjtg7I5ZpK9maHPpHk4CLN0O0Y4rauWiSIHQif1cMtqKARg%2BcskG0crI1mZl2Me%2BZZ8g9Jr6A9TO%2BG6B%2BAuHvyOlBnEQo9ApBQ4g3JZp7uSyRCH7wyxu5avVfWBP0kR4X6PVPNS2njxovFuRYhrsoaOxr5qCj6HG4uUNqbsm3ZbdAMFLxXzT5KEhmDSNZSAkWhXSd3CbLn6PLU3H1wZKL%2BRTr3YWP6V%2BPBJOgG3%2F1%2FtAW8La4mIXOfKOuKrxAT6UJ%2F3ezUbaPUnzCVlKyuBjqwAYUQRBNZktTPJUzRxaZYc7FlEKaYCo56JYwdR1VwuNznpSAuwrJmZ8ZvnXNFJPLlJdcNccsiJ5fTCzfeWcf9BpY1wSj3EzyoYZKwzbfX52pXogACNTVaQkOfGOJAlQQWdAcneFKpYzmbv463sdm5nxdVudTTpGAS2KhfaCeHX8P%2BR4cx6Nfp5GhC4hDj4dSg1VosbQKNMaotjyBFcyuRuboj987f2kN16pdIanTNBi4a&X-Amz-SignedHeaders=host&X-Amz-Signature=ec6f99bc7c43e47a75f6794d0369871de4deb34f77729db8daa78fe2d45b24e3",
      "medium": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ2JWCBEGQ%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T112329Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQC%2FUOBUX4k3hk3E%2Be6snO9LPeTekkyoO2NoMEQpFLXEBwIhAJtkXXn5eL0ikTtvqv%2F2fgGtuhZUPvLulWFuhYzEiLfuKrAFCG8QAxoMMDEzNjE5Mjc0ODQ5Igx%2BsOWizWfx0tzigpsqjQUuFNaEEdzMHGeLBy6s%2Bkoye8hS0hWPfE4WrdAunw9kpHYBx3YQZH%2FutD5pqzkJ0%2FpSWNbJpNfcWoCwQfdsMFN%2F3JTaogDPpUe%2FUAwScnqabVUL9jhgbAfxzoi6vdePXcWwC3rPpDdJZOWII30adweaKN3r73pvMjzWQOzrFwQRQ2qqkd6ueKTpUI%2Fv4YvwK2UEvpnWlXVfdWza8QTDZ%2BVAhjMIgYhtNwiWvsrwTlWirEbz9gqK%2FzOzBvugRZ98k6lTo4fLL9%2F23SfytoJCVdDDIwGtU9XGeEckRTNfnCgQgTT%2FZaoU54aipxAM0Bk2%2FOy9qyQgNo%2Bc4a%2BtxjohyY6lmRwPOUw0Pc6tciCZLAfzTSCwKGLeWeoHYecu2a8TObYqts0FTVzlDxQi0dXbDKcGkreaslLTdMzFIWj7k%2FvKf0zZ7SIjn5wlEWYmpN6UNwCGxRlHEIiWuB874izqCmy7qw9LCJb0ZLpm1%2FSPsUBljWnIWg8YKhR5G%2BlRT4AnTpGmbQ1duSnA4UOAFqFF9ooGKFMwleUudDqIrFYn0NrgGkKuZ0FyHukrzdoftt2m1CLmNvKjrzoE0ES2uqov8Tj9QQRIEQFjtg7I5ZpK9maHPpHk4CLN0O0Y4rauWiSIHQif1cMtqKARg%2BcskG0crI1mZl2Me%2BZZ8g9Jr6A9TO%2BG6B%2BAuHvyOlBnEQo9ApBQ4g3JZp7uSyRCH7wyxu5avVfWBP0kR4X6PVPNS2njxovFuRYhrsoaOxr5qCj6HG4uUNqbsm3ZbdAMFLxXzT5KEhmDSNZSAkWhXSd3CbLn6PLU3H1wZKL%2BRTr3YWP6V%2BPBJOgG3%2F1%2FtAW8La4mIXOfKOuKrxAT6UJ%2F3ezUbaPUnzCVlKyuBjqwAYUQRBNZktTPJUzRxaZYc7FlEKaYCo56JYwdR1VwuNznpSAuwrJmZ8ZvnXNFJPLlJdcNccsiJ5fTCzfeWcf9BpY1wSj3EzyoYZKwzbfX52pXogACNTVaQkOfGOJAlQQWdAcneFKpYzmbv463sdm5nxdVudTTpGAS2KhfaCeHX8P%2BR4cx6Nfp5GhC4hDj4dSg1VosbQKNMaotjyBFcyuRuboj987f2kN16pdIanTNBi4a&X-Amz-SignedHeaders=host&X-Amz-Signature=f90886ac0cf6f8332125ea102b317f0624d3c23725cfade5eab1682a0453cc85"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Internet Bug Bounty",
      "twitter_handle": "",
      "website": "https://www.hackerone.com/internet-bug-bounty",
      "about": "The Internet Bug Bounty rewards security research into vulnerabilities impacting Open Source Software Projects."
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [
    "CVE-2013-6420"
  ],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2013-12-13T00:00:00.000Z",
  "bug_reporter_agreed_on_going_public_at": null,
  "team_member_agreed_on_going_public_at": "2013-12-12T23:00:00.000Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "#Overview:\n\nQuote from http://www.php.net\n> \"PHP is a widely-used general-purpose scripting language that is especially suited for Web development and can be embedded into HTML.\"\n\nThe PHP function openssl_x509_parse() uses a helper function called asn1_time_to_time_t() to convert timestamps from ASN1 string format into integer timestamp values. The parser within this helper function is not binary safe and can therefore be tricked to write up to five NUL bytes outside of an allocated buffer.\n\nThis problem can be triggered by x509 certificates that contain NUL bytes in their notBefore and notAfter timestamp fields and leads to a memory corruption that might result in arbitrary code execution.\n\nDepending on how openssl_x509_parse() is used within a PHP application the attack requires either a malicious cert signed by a compromised/malicious CA or can be carried out with a self-signed cert.\n\n#Details:\n\nThe PHP function openssl_x509_parse() is used by PHP applications to parse additional information out of x509 certificates, usually to harden SSL encrypted communication channels against MITM attacks. In the wild we have seen the following use cases for this function:\n\n   * output certificate debugging information\n     (e.g. cacert.org/analyse.php)\n   * webmail application with SMIME support\n   * client certificate handling\n   * certificate pinning\n   * verification of other certificate properties\n     (e.g. a default Wordpress install if ext/curl is not loaded)\n\nWhen we backported security fixes for some previous security vulnerabilities in PHP's openssl to PHP 4.4.9 as part of our PHP security backport services that we provide to customers, we performed a quick audit of openssl_x509_parse() and all the functions it calls, which led to the discovery of a memory corruption vulnerability.\n\nWithin the function openssl_x509_parse() the helper function asn1_time_to_time_t() is called two times to parse the notBefore and notAfter ASN1 string timestamps from the cert into integer time_t values as you can see below:\n\n```\nadd_assoc_long(return_value, \"validFrom_time_t\", asn1_time_to_time_t(X509_get_notBefore(cert) TSRMLS_CC));\nadd_assoc_long(return_value, \"validTo_time_t\", asn1_time_to_time_t(X509_get_notAfter(cert) TSRMLS_CC));\n```\n\nWhen you take a look into this helper function you will see that it only contains a quickly hacked parser that was never really improved since its introduction in PHP 4.0.6. The author of this parser was even aware of its hackishness as you can see from the error message contained in the code:\n\n```\nstatic time_t asn1_time_to_time_t(ASN1_UTCTIME * timestr TSRMLS_DC) /* {{{ */ {\n  /*\n     This is how the time string is formatted:\n     snprintf(p, sizeof(p), \"%02d%02d%02d%02d%02d%02dZ\",ts->tm_year%100, ts->tm_mon+1,ts->tm_mday,ts->tm_hour,ts->tm_min,ts->tm_sec);\n  */\n\n  time_t ret;\n  struct tm thetime;\n  char * strbuf;\n  char * thestr;\n  long gmadjust = 0;\n\n  if (timestr->length < 13) {\n    php_error_docref(NULL TSRMLS_CC, E_WARNING, \"extension author too lazy to parse %s correctly\", timestr->data);\n    return (time_t)-1;\n  }\n```\n\nHowever the actual problem of the code should become obvious when you read the rest of the parsing code that attempts to first duplicate the timestamp string and then parses the timestamp by going through the copy in reverse order and writing five NUL bytes into the duplicated string.\n\n```\nstrbuf = estrdup((char *)timestr->data);\n\nmemset(&thetime, 0, sizeof(thetime));\n\n/* we work backwards so that we can use atoi more easily */\n\nthestr = strbuf + timestr->length - 3;\n\nthetime.tm_sec = atoi(thestr);\n*thestr = '\\0';\nthestr -= 2;\nthetime.tm_min = atoi(thestr);\n*thestr = '\\0';\nthestr -= 2;\nthetime.tm_hour = atoi(thestr);\n*thestr = '\\0';\nthestr -= 2;\nthetime.tm_mday = atoi(thestr);\n*thestr = '\\0';\nthestr -= 2;\nthetime.tm_mon = atoi(thestr)-1;\n*thestr = '\\0';\nthestr -= 2;\nthetime.tm_year = atoi(thestr);\n```\n\nThe problem with this code is that ASN1 strings can contain NUL bytes, while the parser is not binary safe. This means if a timestamp string inside a x509 certificate contains a NUL byte at e.g. position 13 the estrdup() will only allocate 14 bytes for a copy of the string, but the parser will attempt to write five NUL bytes to memory addressed by the ASN1 length of the string. If the real string length is longer than 16 bytes this will result in writes of NUL bytes outside of the allocated buffer.\n\nBecause of PHP's deterministic heap memory layout that can be controlled a lot by sending e.g. POST variables and using duplicate variable names to poke memory holes this vulnerability must be considered exploitable. However the actual exploit will depend a lot on how the PHP application uses openssl_x509_parse() and a lot of other factors.\n\nDepending on which of the actual use cases the function is used for by an application, an attacker can trigger the memory corruption with a self-signed certificate. An example for this is the public analyse.php x509 cert debugging script provided by CACert on their webserver.\n\nOther applications like Wordpress use openssl_x509_parse() to further verify SSL certificates whenever Wordpress connects to a HTTPS URL (in case ext/curl is not loaded which is the default for several linux distributions). Because the parsing only happens after the initial SSL connection is established this can only be abused by attackers controlling a malicious trusted cert. However recent disclosures of alleged NSA capabilities, the French incident and disclosures about fully compromised trusted CAs in the past years have shown that this capability might be in the reach of malicious attackers.\n\n#Proof of Concept:\n\nThe following x509 certificate demonstrates the out of bounds write:\n\n```\n-----BEGIN CERTIFICATE-----\nMIIEpDCCA4ygAwIBAgIJAJzu8r6u6eBcMA0GCSqGSIb3DQEBBQUAMIHDMQswCQYD\nVQQGEwJERTEcMBoGA1UECAwTTm9yZHJoZWluLVdlc3RmYWxlbjEQMA4GA1UEBwwH\nS8ODwrZsbjEUMBIGA1UECgwLU2VrdGlvbkVpbnMxHzAdBgNVBAsMFk1hbGljaW91\ncyBDZXJ0IFNlY3Rpb24xITAfBgNVBAMMGG1hbGljaW91cy5zZWt0aW9uZWlucy5k\nZTEqMCgGCSqGSIb3DQEJARYbc3RlZmFuLmVzc2VyQHNla3Rpb25laW5zLmRlMHUY\nZDE5NzAwMTAxMDAwMDAwWgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\nAAAAAAAXDTE0MTEyODExMzkzNVowgcMxCzAJBgNVBAYTAkRFMRwwGgYDVQQIDBNO\nb3JkcmhlaW4tV2VzdGZhbGVuMRAwDgYDVQQHDAdLw4PCtmxuMRQwEgYDVQQKDAtT\nZWt0aW9uRWluczEfMB0GA1UECwwWTWFsaWNpb3VzIENlcnQgU2VjdGlvbjEhMB8G\nA1UEAwwYbWFsaWNpb3VzLnNla3Rpb25laW5zLmRlMSowKAYJKoZIhvcNAQkBFhtz\ndGVmYW4uZXNzZXJAc2VrdGlvbmVpbnMuZGUwggEiMA0GCSqGSIb3DQEBAQUAA4IB\nDwAwggEKAoIBAQDDAf3hl7JY0XcFniyEJpSSDqn0OqBr6QP65usJPRt/8PaDoqBu\nwEYT/Na+6fsgPjC0uK9DZgWg2tHWWoanSblAMoz5PH6Z+S4SHRZ7e2dDIjPjdhjh\n0mLg2UMO5yp0V797Ggs9lNt6JRfH81MN2obXWs4NtztLMuD6egqpr8dDbr34aOs8\npkdui5UawTZksy5pLPHq5cMhFGm06v65CLo0V2Pd9+KAokPrPcN5KLKebz7mLpk6\nSMeEXOKP4idEqxyQ7O7fBuHMedsQhu+prY3si3BUyKfQtP5CZnX2bp0wKHxX12DX\n1nfFIt9DbGvHTcyOuN+nZLPBm3vWxntyIIvVAgMBAAGjQjBAMAkGA1UdEwQCMAAw\nEQYJYIZIAYb4QgEBBAQDAgeAMAsGA1UdDwQEAwIFoDATBgNVHSUEDDAKBggrBgEF\nBQcDAjANBgkqhkiG9w0BAQUFAAOCAQEAG0fZYYCTbdj1XYc+1SnoaPR+vI8C8CaD\n8+0UYhdnyU4gga0BAcDrY9e94eEAu6ZqycF6FjLqXXdAboppWocr6T6GD1x33Ckl\nVArzG/KxQohGD2JeqkhIMlDomxHO7ka39+Oa8i2vWLVyjU8AZvWMAruHa4EENyG7\nlW2AagaFKFCr9TnXTfrdxGVEbv7KVQ6bdhg5p5SjpWH1+Mq03uR3ZXPBYdyV8319\no0lVj1KFI2DCL/liWisJRoof+1cR35Ctd0wYBcpB6TZslMcOPl76dwKwJgeJo2Qg\nZsfmc2vC1/qOlNuNq/0TzzkVGv8ETT3CgaU+UXe4XOVvkccebJn2dg==\n-----END CERTIFICATE-----\n```\n\nFull Advisory: [http://www.sektioneins.de/advisories/advisory-012013-php-openssl_x509_parse-memory-corruption-vulnerability.html](http://www.sektioneins.de/advisories/advisory-012013-php-openssl_x509_parse-memory-corruption-vulnerability.html)\n",
  "weakness": {
    "id": 70,
    "name": "Code Injection"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2014-01-11T23:00:00.000Z",
  "allow_singular_disclosure_after": -318342209.43960106,
  "singular_disclosure_allowed": true,
  "vote_count": 13,
  "voters": [
    "taha",
    "sw33tlie",
    "jensec",
    "tess",
    "salahhasoneh",
    "moshakes",
    "h4x0r_dz",
    "aporlorxl23",
    "geeknik",
    "eveeez",
    "and 3 more..."
  ],
  "structured_scope": {
    "databaseId": 84120,
    "asset_type": "OTHER",
    "asset_identifier": "PHP",
    "max_severity": "none"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
