{
  "id": 816637,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC84MTY2Mzc=",
  "url": "https://hackerone.com/reports/816637",
  "title": "CVE-2020-10938-buffer overflow/out-of-bounds write in compress.c:HuffmanDecodeImage()",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "critical",
  "readable_substate": "Resolved",
  "created_at": "2020-03-11T10:27:42.187Z",
  "submitted_at": "2020-03-11T10:27:42.187Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "nathaniellives",
    "url": "/nathaniellives",
    "profile_picture_urls": {
      "small": "/assets/avatars/default-25f7248a18bdf9e2dc8310319b148d66cff430fa0fade6c5f25fee1b8d7f27ed.png"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 54349,
    "url": "https://hackerone.com/ibb",
    "handle": "ibb",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ4S26OA6W%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T133951Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIBrwAoewzxY3bz1ssFSdtEyK39n4ige2HCt%2FqgWXMxo6AiEA8W9QZL7h8ed7oBtuSQFGPQDGjUswee0LimM2YHTA1jMqsgUIdhADGgwwMTM2MTkyNzQ4NDkiDIMSY8w9rHi0W5K3diqPBbjGizLrTlN6ZGbFF9LhBmPFJ1m5swtpZ7QtuQ1ecm6xRS32Vw6P29QnZ1nCvXxHRHo6hca4PRPlC%2F0SuWjzk0o8NKsd8UrMzywQ79MxoK3cqCgX8WV8kEyJZ1wthUKdW7fS3ASByTHh9EDJx35aAAaV%2FjyX21PDJbVpBrxSai%2BI8NCYDMrESdXzFg96JAx0%2FwVm%2BdX91kGoUyEspJy20Nir3f1bZWjC7MdtcCOSsjRRpflXb4gfaH%2BL1WT1rmstsNmGjj3W3W7TeYhR6pZtPFJdtb6k%2FghNKP4k29rXq2vgyXJX%2BVcohZ1zGAdsXYKgnKO2Y3m%2BPX7s9J%2BEwjIpNQnCTqqMY1fdtAuglpVQs9wOIOz5AsX%2F3fV3pu%2FvQSQRA8Du6Cj%2BeC4F1CXAi0KT8j%2B0b0OBcdCMFF7x0ZDWnp2IvcnhJbnULpfzrU3BcnLBK5G1w73sljokf7mqqRRV2mJeZ0Ksp5PbOgcxO2a9zF3%2F8KWFXZX25btNrQCkx2iy6DjaS4wWdbHTtaTyA9KPaMdPFCZK0C8QMd1EIcXXBkK42tdRHldBFv0Qtop0xhubZI7kmNI9gIAuHZhtoU%2F051v4TKLQUh2TAOI42M0%2BTEJLZph2o6AOjkFRtLNFt7YY1LhWRiyVjOtaBUNN8WQ3Qh3vWd2mGOGt3XUF8k06PdeLUGh8KHoKU7J50qkgwAmhpZgQn9UvombEZfjpL9rMdjKsr48SewAEp5ii613cBEjgvmV9GqfxRnaBt9%2BBnmZqq%2Bqdlb6QUuoAocNShZpYRVRCujWv0rbK5%2BJsewBiul9SD4qpCHDP0iLsOH3MbGI4L4Vl8HvxUyotCrHJVcTbSu85yQg3fmRmZR%2FKVxNQjZkwy8atrgY6sQF65KaBWFLOPDup9JZh9E6aRNnp6nOc2RJjfDBuEZqnqO%2FE0eIR6%2FMnB5jQvVkuHRSmXTStKVhFSTodnbxf6Jx%2FV%2Bb7oAvc4YN%2FjwysEYMAdJ7G1ipFcWKNk%2Fy8IJiu93NTzXgZ%2BUcmX9FJKhedbl1puxNoeG9%2FJnYsNGqtzqjFHuyw9oeW7ona11lhu%2Bwq%2BU434QKAOt%2FmsX3wWtY1amD8a%2F8TawrYCNcXdx0m%2F%2FsKhD8%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=72ba27bb91f0d00188ef856de28535a8965047feb60d264e107a0a074bf80d68",
      "medium": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ4S26OA6W%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T133951Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIBrwAoewzxY3bz1ssFSdtEyK39n4ige2HCt%2FqgWXMxo6AiEA8W9QZL7h8ed7oBtuSQFGPQDGjUswee0LimM2YHTA1jMqsgUIdhADGgwwMTM2MTkyNzQ4NDkiDIMSY8w9rHi0W5K3diqPBbjGizLrTlN6ZGbFF9LhBmPFJ1m5swtpZ7QtuQ1ecm6xRS32Vw6P29QnZ1nCvXxHRHo6hca4PRPlC%2F0SuWjzk0o8NKsd8UrMzywQ79MxoK3cqCgX8WV8kEyJZ1wthUKdW7fS3ASByTHh9EDJx35aAAaV%2FjyX21PDJbVpBrxSai%2BI8NCYDMrESdXzFg96JAx0%2FwVm%2BdX91kGoUyEspJy20Nir3f1bZWjC7MdtcCOSsjRRpflXb4gfaH%2BL1WT1rmstsNmGjj3W3W7TeYhR6pZtPFJdtb6k%2FghNKP4k29rXq2vgyXJX%2BVcohZ1zGAdsXYKgnKO2Y3m%2BPX7s9J%2BEwjIpNQnCTqqMY1fdtAuglpVQs9wOIOz5AsX%2F3fV3pu%2FvQSQRA8Du6Cj%2BeC4F1CXAi0KT8j%2B0b0OBcdCMFF7x0ZDWnp2IvcnhJbnULpfzrU3BcnLBK5G1w73sljokf7mqqRRV2mJeZ0Ksp5PbOgcxO2a9zF3%2F8KWFXZX25btNrQCkx2iy6DjaS4wWdbHTtaTyA9KPaMdPFCZK0C8QMd1EIcXXBkK42tdRHldBFv0Qtop0xhubZI7kmNI9gIAuHZhtoU%2F051v4TKLQUh2TAOI42M0%2BTEJLZph2o6AOjkFRtLNFt7YY1LhWRiyVjOtaBUNN8WQ3Qh3vWd2mGOGt3XUF8k06PdeLUGh8KHoKU7J50qkgwAmhpZgQn9UvombEZfjpL9rMdjKsr48SewAEp5ii613cBEjgvmV9GqfxRnaBt9%2BBnmZqq%2Bqdlb6QUuoAocNShZpYRVRCujWv0rbK5%2BJsewBiul9SD4qpCHDP0iLsOH3MbGI4L4Vl8HvxUyotCrHJVcTbSu85yQg3fmRmZR%2FKVxNQjZkwy8atrgY6sQF65KaBWFLOPDup9JZh9E6aRNnp6nOc2RJjfDBuEZqnqO%2FE0eIR6%2FMnB5jQvVkuHRSmXTStKVhFSTodnbxf6Jx%2FV%2Bb7oAvc4YN%2FjwysEYMAdJ7G1ipFcWKNk%2Fy8IJiu93NTzXgZ%2BUcmX9FJKhedbl1puxNoeG9%2FJnYsNGqtzqjFHuyw9oeW7ona11lhu%2Bwq%2BU434QKAOt%2FmsX3wWtY1amD8a%2F8TawrYCNcXdx0m%2F%2FsKhD8%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=5bd023b515345d56cf295f3223ad9c2d4a2eab5814ce0b9e5c832f64ef9a7af6"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Internet Bug Bounty",
      "twitter_handle": "",
      "website": "https://www.hackerone.com/internet-bug-bounty",
      "about": "The Internet Bug Bounty rewards security research into vulnerabilities impacting Open Source Software Projects."
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [
    "CVE-2020-10938"
  ],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2021-08-22T03:54:00.533Z",
  "bug_reporter_agreed_on_going_public_at": null,
  "team_member_agreed_on_going_public_at": "2021-07-23T03:53:57.744Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "Hello,\n  \n There is an out-of-bounds write that is likely exploitable while performing Huffman decoding of Fax images.\n The technical details are as follows.\n  \n # Type: integer underflow produces out of bounds heap/etc write\n # Platform: 32-bit\n # Details:\n  \n```\n 390 MagickExport MagickPassFail HuffmanDecodeImage(Image *image)\n 391 {\n 392 const HuffmanTable\n 393 *entry;\n 394\n [...]\n 412\n 413 long\n 414 count,\n 415 y;\n 416\n [...]\n 420 register long\n 421 i,\n 422 x;\n 423\n [...]\n 462 InitializeHashTable(mw_hash,TWTable,MWHashA,MWHashB);\n 463 InitializeHashTable(mw_hash,MWTable,MWHashA,MWHashB);\n 464 InitializeHashTable(mw_hash,EXTable,MWHashA,MWHashB);\n 465 InitializeHashTable(mb_hash,TBTable,MBHashA,MBHashB);\n 466 InitializeHashTable(mb_hash,MBTable,MBHashA,MBHashB);\n 467 InitializeHashTable(mb_hash,EXTable,MBHashA,MBHashB);\n  ```\n Basic initialization; of specific note are that the variables 'x' and 'count' are signed. On a 64-bit\n platform, assuming GCC or similar, it is 8 bytes in length and of course 4 bytes in length on 32-bit. There\n is nothing inherently restricting this to 32-bit other than practicalities of the file size as there is a\n need to have backing data to trigger the vulnerability. On 64-bit platforms this equates to a file size that\n exceeds the default maximums, whereas on 32-bit the attached Proof-of-Concept out-of-bounds write trigger\n only requires a file of a few megabytes-- which to my understanding can be reduced by wrapping the file in\n compression.\n  \n Additionally, the Huffman hash tables have code lengths that range between 0 and 2560.\n  \n ``` \n 495 color=True;\n 496 code=0;\n 497 count=0;\n 498 length=0;\n 499 runlength=0;\n 500 x=0;\n 501 for ( ; ; )\n 502 {\n 503 if (byte == EOF)\n 504 break;\n 505 if (x >= (long) image->columns)\n 506 {\n 507 while (runlength < 11)\n 508 InputBit(bit);\n 509 do { InputBit(bit); } while (bit == 0);\n 510 break;\n 511 }\n 512 bail=False;\n 513 do\n 514 {\n 515 if (runlength < 11)\n 516 InputBit(bit)\n 517 else\n 518 {\n 519 InputBit(bit);\n 520 if (bit)\n 521 {\n 522 null_lines++;\n 523 if (x != 0)\n 524 null_lines=0;\n 525 bail=True;\n 526 break;\n 527 }\n 528 }\n 529 code=(code << 1)+bit;\n 530 length++;\n 531 } while (code <= 0);\n 532 if (bail)\n 533 break;\n 534 if (length > 13)\n 535 {\n 536 while (runlength < 11)\n 537 InputBit(bit);\n 538 do\n 539 {\n 540 InputBit(bit);\n 541 } while (bit == 0);\n 542 break;\n 543 }\n 544 if (color)\n 545 {\n 546 if (length < 4)\n 547 continue;\n 548 entry=mw_hash[((length+MWHashA)*(code+MWHashB)) % HashSize];\n 549 }\n 550 else\n 551 {\n 552 if (length < 2)\n 553 continue;\n 554 entry=mb_hash[((length+MBHashA)*(code+MBHashB)) % HashSize];\n 555 }\n 556 if (!entry)\n 557 continue;\n 558 if ((entry->length != length) || (entry->code != code))\n 559 continue;\n  ```\n\n In the above code, we enter an unbounded for() loop at line 501, which terminates upon file EOF or other\n abnormal condition. lines 513-531 unpack a huffman encoded pixel one bit at a time. Once the first binary 1\n is encountered, the loop will always terminate until the total length of the code exceeds 13 or a\n corresponding entry in the huffman tables are found at lines 548 or 554.\n  \n In other words, we unpack the pixels and look them up in the huffman tables. Once we encounter a one, we\n terminate the loop and attempt to look up the symbol in the corresponding tables matching the symbol length\n and the symbol code. If we don't find a match, then we restart the loop and unpack another bit. This\n continues until a symbol is found or a sequence of 11 or more zeros or 13 or more bits is encountered.\n\n```  \n 560 switch (entry->id)\n 561 {\n 562 case TWId:\n 563 case TBId:\n 564 {\n 565 count+=entry->count;\n 566 if ((x+count) > (long) image->columns)\n 567 count=(long) image->columns-x;\n 568 if (count > 0)\n 569 {\n 570 if (color)\n 571 {\n 572 x+=count;\n 573 count=0;\n 574 }\n 575 else\n 576 for ( ; count > 0; count--)\n 577 scanline[x++]=1;\n 578 }\n 579 color=!color;\n 580 break;\n 581 }\n 582 case MWId:\n 583 case MBId:\n 584 case EXId:\n 585 {\n 586 count+=entry->count;\n 587 break;\n 588 }\n  ```\n\n When a symbol is found, we enter a jump table dependant upon the symbol type. The crux of the problem exists\n in this section. The bounds check at line 566: \"if ((x+count) > (long) image->columns)\" is insufficient due\n to the variables being signed, thus it becomes possible to:\n 1 Iterate across TWId or TBId symbols incrementing the value of x such that x is non-zero but less than\n image->columns\n 2 Provide repeated instance of MWid, MBId or EXId symbols to iteratively work the \"count\" variable into a\n value close to but not exceeding INT_MAX\n 3 Provide another TWId or TBId symbol causing an additive overflow at line 566.\n 4 Depending upon the state of the variable 'color', this will either result in:\n ⋅⋅4 The x variable becoming negative yielding an invalid offset at line 577; or\n ⋅⋅4 Resulting in an invalid value of count which exceeds the image->columns and thus bounding of scanline,\n resulting in an out-of-bounds write at lines 577 and 578\n\n```  \n 592 code=0;\n 593 length=0;\n 594 }\n [...]\n```  \n \n # Proof-of-Concept:\n  \n Attached is a simple C++ program that when build (make; assuming g++ is in your path) and run will output a\n file 'poc.fax' that can then be supplied to any code path that causes\n ReadImage()->ReadFAXImage()->HuffmanDecodeImage() to be executed. It works the 'x' variable up to a value of\n 64, then the count variable up to INT_MAX - 64, then provides one of the symbols with a count length of 0 to\n make x negative and then fetches a symbol that results in the out-of-bounds write.\n\n# Vendor Response\n\nJustin,\n\nThis problem (and a number of other issues observed in compress.c) are\naddressed by Mercurial changeset 16131:95abc2b694ce.\n\nThank you very much for your detailed report.\n\nBob\n\n## Impact\n\nExploitability:\n  \n At first blush, this appears to be a wild out-of-bounds write with relatively little control. However, the\n check at line 568 allows us a finer grained control over circumstances. Notably, it becomes possible to skip\n over uncontrolled writes and toggle the color variable, the user can then supply additional MWId, MBId or\n EXId symbols, causing the value of count to become non-negative, which in tandem with the color toggle\n allows arbitrary modification of the x variable which in turn allows for a finer controlled write. The only\n bounding is the maximum file size to be processed with each iteration taking approximately 1.3 megabytes of\n huffman codes which can be compressed and should compress down nicely.\n  \n In other words, you can set the value of x, then increment count into a negative value and toggle the color\n variable back then increment count until its value is sane/positive again, and then re-enter the TWId/TBId\n section thereby modifying the x variable again, then increment count into a negative and toggle color again\n and overall repeat. This would ultimately allow writes as fine grained as a single byte immediately after or\n immediately before the scanline buffer and within a certain range outside of that bounding. As this is heap\n memory, it is thought to readily lend itself to exploitability.\n  \n Finally, because this would allow for the modification of heap metadata, e.g. block sizes and similar,\n because both the encoded and decoded data is user controlled without any real constraints and because all\n code paths will trigger a free condition, exploitibility seems more a matter of academic interest than a\n legitimate question.\n  \n The specifics of this can be begrudingly worked out if required.",
  "weakness": {
    "id": 5,
    "name": "Heap Overflow"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [
    {
      "id": 744093,
      "file_name": "fax_poc.tar.gz",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/adXgmRem2cnCKduJE4JKREcR?response-content-disposition=attachment%3B%20filename%3D%22fax_poc.tar.gz%22%3B%20filename%2A%3DUTF-8%27%27fax_poc.tar.gz&response-content-type=application%2Fgzip&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ4S26OA6W%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T133951Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIBrwAoewzxY3bz1ssFSdtEyK39n4ige2HCt%2FqgWXMxo6AiEA8W9QZL7h8ed7oBtuSQFGPQDGjUswee0LimM2YHTA1jMqsgUIdhADGgwwMTM2MTkyNzQ4NDkiDIMSY8w9rHi0W5K3diqPBbjGizLrTlN6ZGbFF9LhBmPFJ1m5swtpZ7QtuQ1ecm6xRS32Vw6P29QnZ1nCvXxHRHo6hca4PRPlC%2F0SuWjzk0o8NKsd8UrMzywQ79MxoK3cqCgX8WV8kEyJZ1wthUKdW7fS3ASByTHh9EDJx35aAAaV%2FjyX21PDJbVpBrxSai%2BI8NCYDMrESdXzFg96JAx0%2FwVm%2BdX91kGoUyEspJy20Nir3f1bZWjC7MdtcCOSsjRRpflXb4gfaH%2BL1WT1rmstsNmGjj3W3W7TeYhR6pZtPFJdtb6k%2FghNKP4k29rXq2vgyXJX%2BVcohZ1zGAdsXYKgnKO2Y3m%2BPX7s9J%2BEwjIpNQnCTqqMY1fdtAuglpVQs9wOIOz5AsX%2F3fV3pu%2FvQSQRA8Du6Cj%2BeC4F1CXAi0KT8j%2B0b0OBcdCMFF7x0ZDWnp2IvcnhJbnULpfzrU3BcnLBK5G1w73sljokf7mqqRRV2mJeZ0Ksp5PbOgcxO2a9zF3%2F8KWFXZX25btNrQCkx2iy6DjaS4wWdbHTtaTyA9KPaMdPFCZK0C8QMd1EIcXXBkK42tdRHldBFv0Qtop0xhubZI7kmNI9gIAuHZhtoU%2F051v4TKLQUh2TAOI42M0%2BTEJLZph2o6AOjkFRtLNFt7YY1LhWRiyVjOtaBUNN8WQ3Qh3vWd2mGOGt3XUF8k06PdeLUGh8KHoKU7J50qkgwAmhpZgQn9UvombEZfjpL9rMdjKsr48SewAEp5ii613cBEjgvmV9GqfxRnaBt9%2BBnmZqq%2Bqdlb6QUuoAocNShZpYRVRCujWv0rbK5%2BJsewBiul9SD4qpCHDP0iLsOH3MbGI4L4Vl8HvxUyotCrHJVcTbSu85yQg3fmRmZR%2FKVxNQjZkwy8atrgY6sQF65KaBWFLOPDup9JZh9E6aRNnp6nOc2RJjfDBuEZqnqO%2FE0eIR6%2FMnB5jQvVkuHRSmXTStKVhFSTodnbxf6Jx%2FV%2Bb7oAvc4YN%2FjwysEYMAdJ7G1ipFcWKNk%2Fy8IJiu93NTzXgZ%2BUcmX9FJKhedbl1puxNoeG9%2FJnYsNGqtzqjFHuyw9oeW7ona11lhu%2Bwq%2BU434QKAOt%2FmsX3wWtY1amD8a%2F8TawrYCNcXdx0m%2F%2FsKhD8%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=014d509807b49c1e172a747702290d7ea341d8d0eadbfb68b5aaa38c2a1ac89a",
      "file_size": 3199,
      "type": "application/gzip",
      "moderated": null
    }
  ],
  "allow_singular_disclosure_at": "2021-08-22T03:53:57.845Z",
  "allow_singular_disclosure_after": -78227153.47320953,
  "singular_disclosure_allowed": true,
  "vote_count": 1,
  "voters": [
    "lucidh3x"
  ],
  "severity": {
    "rating": "critical",
    "score": 9.8,
    "author_type": "User",
    "metrics": {
      "attack_vector": "network",
      "attack_complexity": "low",
      "privileges_required": "none",
      "user_interaction": "none",
      "scope": "unchanged",
      "confidentiality": "high",
      "integrity": "high",
      "availability": "high"
    }
  },
  "structured_scope": {
    "databaseId": 84123,
    "asset_type": "OTHER",
    "asset_identifier": "IBB (Legacy)",
    "max_severity": "none"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
