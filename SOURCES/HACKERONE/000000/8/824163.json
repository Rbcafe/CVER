{
  "id": 824163,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC84MjQxNjM=",
  "url": "https://hackerone.com/reports/824163",
  "title": "Squid leaks previous content from reusable buffer",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "high",
  "readable_substate": "Resolved",
  "created_at": "2020-03-18T22:01:47.240Z",
  "submitted_at": "2020-03-18T22:01:47.240Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "jeriko_one",
    "url": "/jeriko_one",
    "profile_picture_urls": {
      "small": "/assets/avatars/default-25f7248a18bdf9e2dc8310319b148d66cff430fa0fade6c5f25fee1b8d7f27ed.png"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 54349,
    "url": "https://hackerone.com/ibb",
    "handle": "ibb",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ3I276FVZ%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T134022Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIBR%2Fcj4He1YNoxuqlCR8y8rqIukyINMyDPuGH4bBYx6SAiEA9rxAEFgc%2FY9ADMxq89WI%2F4YUHMXyjEPxPzJLolchOMcqsgUIdhADGgwwMTM2MTkyNzQ4NDkiDFBjNDAnQ2OT9fFEUCqPBdD%2BXXWBgaRxNEUUo6cEeoytD1eXvhIsF8BkIAolofhhkKHa%2FJ9rh00ejh6T8IepmFmzqyDA1to2vDIum2KthQ0U6K%2Fq21GMCUMZo7xXkyphPeZxTlJE8cbrBa9V7531H4caFbz7tu71hUjruj7poNeDwa5J2XkqEShNg6VTkYFYqW2p508BdQAm0fm%2BJSHq3faBYzcdc%2BIdgG0f6PUjEYh8ysP11Ro09SiXv3N3T6DptjJHKSv7KUv%2FZb54m8zxj0ho7JBJGg0PnntZNlzuUrPyB5o8m6NghY%2FGYTA8AM56YwOqBpjHb6CnraAhdaDe1bVoMVPvNpaoYIcwcd4aA5uVq%2F%2BMEFbgRAsaOaZwmVbJkgiy2He0wZ1y%2Bi038Z1fvfDUbGHaWHIvakM7EmAYLWhUjnVli%2B3NqZponfkOVtoUKkcIkHv%2FMcMGpAcK0LuL5c2PBD0kic3yPmgcNitophPyXa55qvUBwb0m1aYQTwhCX70%2B1MuBBNqQvAsVUygdhbSZflPVFLVYXYCw10pZBosqrbt33MeOhLAD8A8FNaf8XnRxoIDh3nC1b6UKs2zWAsQPsE7gNEmhUsXIocoqXYlZh%2FQZSSdnGUabitNEws3%2FzTErmpCZuC2pr4nC5OCy4AoCpAKYzhiaBnVjXyi1NhUFfB7kXutS3csu0Lk3ScNHi9nlMRK%2FSHZ%2BmmfQUxKvkUG6N76Rrx09p1D%2Brasm6BwCfo%2FSw7hRWxvXSZbCwxc3do9Mpm9IRFA7fgftyitVAMxs%2B8%2FYuoPx7yvUxg0bClyQ192xRI2lA%2B2Re%2FTICR8V2PH0zUKh00J8XQvEL4nx0dQPY1eX5ebqa0OrnmqUj5MM0BpBxhDPhte4fVZA92wwkMCtrgY6sQESsP34nDSGQ6%2FMJpkkUSZiwSB%2F4jJvcrOQGDnz8fYink0yrV9jUVthg%2F0T80d3eDYEK8OVRR2nDjVCUQg3IxtCiugMaPpFUdgVHqXf%2FGpaDapO5M8KW58NB4nk4LoOYgrk9ZTwWMl3jVREWlQWgRKb1D2x8jgp12%2B72xMOnvcfsjT5bTR2OBDEBsh2BamCCdP1z2L0lwJwCGwomgMutcDqcL1aIj%2F%2Fac5TUFnKnI3315E%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=80effef39b08282ac1137c24a78826928e768ab4ad04412b15f0e346ca456f69",
      "medium": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ3I276FVZ%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T134022Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIBR%2Fcj4He1YNoxuqlCR8y8rqIukyINMyDPuGH4bBYx6SAiEA9rxAEFgc%2FY9ADMxq89WI%2F4YUHMXyjEPxPzJLolchOMcqsgUIdhADGgwwMTM2MTkyNzQ4NDkiDFBjNDAnQ2OT9fFEUCqPBdD%2BXXWBgaRxNEUUo6cEeoytD1eXvhIsF8BkIAolofhhkKHa%2FJ9rh00ejh6T8IepmFmzqyDA1to2vDIum2KthQ0U6K%2Fq21GMCUMZo7xXkyphPeZxTlJE8cbrBa9V7531H4caFbz7tu71hUjruj7poNeDwa5J2XkqEShNg6VTkYFYqW2p508BdQAm0fm%2BJSHq3faBYzcdc%2BIdgG0f6PUjEYh8ysP11Ro09SiXv3N3T6DptjJHKSv7KUv%2FZb54m8zxj0ho7JBJGg0PnntZNlzuUrPyB5o8m6NghY%2FGYTA8AM56YwOqBpjHb6CnraAhdaDe1bVoMVPvNpaoYIcwcd4aA5uVq%2F%2BMEFbgRAsaOaZwmVbJkgiy2He0wZ1y%2Bi038Z1fvfDUbGHaWHIvakM7EmAYLWhUjnVli%2B3NqZponfkOVtoUKkcIkHv%2FMcMGpAcK0LuL5c2PBD0kic3yPmgcNitophPyXa55qvUBwb0m1aYQTwhCX70%2B1MuBBNqQvAsVUygdhbSZflPVFLVYXYCw10pZBosqrbt33MeOhLAD8A8FNaf8XnRxoIDh3nC1b6UKs2zWAsQPsE7gNEmhUsXIocoqXYlZh%2FQZSSdnGUabitNEws3%2FzTErmpCZuC2pr4nC5OCy4AoCpAKYzhiaBnVjXyi1NhUFfB7kXutS3csu0Lk3ScNHi9nlMRK%2FSHZ%2BmmfQUxKvkUG6N76Rrx09p1D%2Brasm6BwCfo%2FSw7hRWxvXSZbCwxc3do9Mpm9IRFA7fgftyitVAMxs%2B8%2FYuoPx7yvUxg0bClyQ192xRI2lA%2B2Re%2FTICR8V2PH0zUKh00J8XQvEL4nx0dQPY1eX5ebqa0OrnmqUj5MM0BpBxhDPhte4fVZA92wwkMCtrgY6sQESsP34nDSGQ6%2FMJpkkUSZiwSB%2F4jJvcrOQGDnz8fYink0yrV9jUVthg%2F0T80d3eDYEK8OVRR2nDjVCUQg3IxtCiugMaPpFUdgVHqXf%2FGpaDapO5M8KW58NB4nk4LoOYgrk9ZTwWMl3jVREWlQWgRKb1D2x8jgp12%2B72xMOnvcfsjT5bTR2OBDEBsh2BamCCdP1z2L0lwJwCGwomgMutcDqcL1aIj%2F%2Fac5TUFnKnI3315E%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=92b2f7b398198b73354981268bdcc131cd57565371fe07729bb6ea829aed2548"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Internet Bug Bounty",
      "twitter_handle": "",
      "website": "https://www.hackerone.com/internet-bug-bounty",
      "about": "The Internet Bug Bounty rewards security research into vulnerabilities impacting Open Source Software Projects."
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [
    "CVE-2019-12528"
  ],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2021-08-26T23:37:23.822Z",
  "bug_reporter_agreed_on_going_public_at": null,
  "team_member_agreed_on_going_public_at": "2021-07-27T23:37:23.103Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "## Summary:\nA malicious response to a FTP request can cause Squid to miscalculate the length of a string copying data past the terminating NULL. Due to Squid's memory pool the contents that is exposed could range from internal data, to other user's private Request/Response to Squid. \n\nThis exist in Squid-4.9 and Below and was fixed in Squid-4.10\nThis vulnerability was assigned CVE-2019-12528.\n\n## Steps To Reproduce:\nA custom config is should not be needed. \nI've attached a python script that returns the needed response to trigger this.\n\n1) Start Squid \n```\n./sbin/squid\n```\n\n2) Start your malicious FTP Server\n```\n./squid_leak.py 8080\n```\n\n3) Make a request to the FTP server via Squid.\n```\nprintf \"GET ftp://<ftp ip>:8080/ HTTP/1.1\\r\\n\\r\\n\" | nc <squid hostname> 3128\n```\n\n4) The FTP server should have sent the listing. A message from it saying\n```\n<- 226 Listing sent\n```\nShould be visible\n\nThe leaked data is now in the HTML that Squid has returned. The data will be under the line \n\n```<th nowrap=\"nowrap\"><a href=\"../\">Parent Directory</a> (<a href=\"/\">Root Directory</a>)</th>```\n\nWithin the following <tr>\n\nFor reference a normal response would look like \n\n```\n<tr class=\"entry\"><td colspan=\"5\">hi</td></tr>\n```\n\n## Analysis\nThe issue begins in Ftp::Gateway::parsingListing the relevant snippet being\n\n```\n    line = (char *)memAllocate(MEM_4K_BUF);\n    ++end;\n    s = sbuf;\n    s += strspn(s, crlf);\n\n    for (; s < end; s += strcspn(s, crlf), s += strspn(s, crlf)) {\n        debugs(9, 7, HERE << \"s = {\" << s << \"}\");\n        linelen = strcspn(s, crlf) + 1;\n\t\t<snip>\n        xstrncpy(line, s, linelen);\n\t\t<snip>\n\t\tif (htmlifyListEntry(line, html)) \n```\n\nA crucial thing to notice here is the following: \n- line is allocated with memAllocate(MEM_4K_BUF) this is what will lead us to reading previous content. Buffers allocated via this method aren't ever free'd, but are put back into their respective pools. Zeroing of the buffer is possible, but is not enabled for this type of memory.\n\nWithin ftpListParseParts (FtpGateway.cc) is where the root of the vulnerability exist. \nThis function can handle various formats for listings. \n\nA common procedure is done on all of them before that then. They are converted\ninto tokens by strtok.\n```\n    for (t = strtok(xbuf, w_space); t && n_tokens < MAX_TOKENS; t = strtok(NULL, w_space)) {\n        tokens[n_tokens] = xstrdup(t);\n        ++n_tokens;\n    }\n```\nPlease note that strok uses w_space as delimiters \n```\n\t#define w_space     \" \\t\\n\\r\"\n```\nThe listing format that we'll focus on is DOS format (FtpGateway.cc:648)\n\nFor listings that aren't directories the following code is executed:\n```\n        } else {\n            /* A file. Name begins after size, with a space in between */\n            snprintf(tbuf, 128, \" %s %s\", tokens[2], tokens[3]);\n            ct = strstr(buf, tbuf);\n\n            if (ct) {\n                ct += strlen(tokens[2]) + 2;\n            }\n        }\n\n        p->name = xstrdup(ct ? ct : tokens[3]);\n```\n\nSquid will put tokens[2] and tokens[3] in a temporary buffer with 2 spaces. It\nthen searches for this string in the original line setting ct to the start of\nthis string. It then increments ct by the length of tokens[2] + 2. What is\npointed to now is used as the name. \n\nThe false assumption here is that tokens will be separated by spaces in the\noriginal line.\n\nConsider the following example where \\t denotes a tab, and * is for repetition:\n\n```\n04-05-70 09:33PM\\tA*126 A*126\n```\n\nGoing through the referenced code path when snprintf is called tbuf will be\nfilled as: \" A*126\". Then when strstr is called, it'll find the token, but it\nwon't be token[2] it'll be token[3] as token[2] started with a tab. When it\nincrements by the length strlen(tokens[2]) + 2 it'll put ct past the\nterminating NULL byte of this line.\n\nThe contents is then copied into another buffer which will be displayed to the attacker\n\n p->name = xstrdup(ct ? ct : tokens[3]);\n\nSetting a breakpoint in we can confirm that it's leaking data\n\nConfirming that the tokens are 126:\n```\n(gdb) call (size_t)strlen(tokens[2])\n$2 = 126\n(gdb) call (size_t)strlen(tokens[3])\n$3 = 126\n```\nHere ct is set to the wrong token since it's looking for \" A\"\n```\nsnprintf(tbuf, 128, \" %s %s\", tokens[2], tokens[3]);\n(gdb) n\n675\t            ct = strstr(buf, tbuf);\n(gdb) call (size_t)strlen(tbuf)\n$4 = 127\n\n(gdb) p tbuf\n$5 = \" \", 'A' <repeats 126 times>\n\n(gdb) p ct\n$6 = 0x62100006918f \" \", 'A' <repeats 126 times>\n\n678\t                ct += strlen(tokens[2]) + 2;\n(gdb) call (size_t) strlen(tokens[2]) + 2\n$8 = 128\n```\nHere we see ct is now past the terminating NULL\n```\n(gdb) x/2xb ct - 1\n0x62100006920e:\t0x00\t0x66\n```\n\n## Impact\n\nAn attacker can leak sensitive information from the Squid process. This could include other user's Request and Response which could have headers, cookies, full bodies, and post data.",
  "weakness": {
    "id": 9,
    "name": "Buffer Over-read"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [
    {
      "id": 752579,
      "file_name": "squid_leak.py",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/pikHVsE8H47Lgk6WESZjJx8i?response-content-disposition=attachment%3B%20filename%3D%22squid_leak.py%22%3B%20filename%2A%3DUTF-8%27%27squid_leak.py&response-content-type=text%2Fx-python&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ3I276FVZ%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T134022Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIBR%2Fcj4He1YNoxuqlCR8y8rqIukyINMyDPuGH4bBYx6SAiEA9rxAEFgc%2FY9ADMxq89WI%2F4YUHMXyjEPxPzJLolchOMcqsgUIdhADGgwwMTM2MTkyNzQ4NDkiDFBjNDAnQ2OT9fFEUCqPBdD%2BXXWBgaRxNEUUo6cEeoytD1eXvhIsF8BkIAolofhhkKHa%2FJ9rh00ejh6T8IepmFmzqyDA1to2vDIum2KthQ0U6K%2Fq21GMCUMZo7xXkyphPeZxTlJE8cbrBa9V7531H4caFbz7tu71hUjruj7poNeDwa5J2XkqEShNg6VTkYFYqW2p508BdQAm0fm%2BJSHq3faBYzcdc%2BIdgG0f6PUjEYh8ysP11Ro09SiXv3N3T6DptjJHKSv7KUv%2FZb54m8zxj0ho7JBJGg0PnntZNlzuUrPyB5o8m6NghY%2FGYTA8AM56YwOqBpjHb6CnraAhdaDe1bVoMVPvNpaoYIcwcd4aA5uVq%2F%2BMEFbgRAsaOaZwmVbJkgiy2He0wZ1y%2Bi038Z1fvfDUbGHaWHIvakM7EmAYLWhUjnVli%2B3NqZponfkOVtoUKkcIkHv%2FMcMGpAcK0LuL5c2PBD0kic3yPmgcNitophPyXa55qvUBwb0m1aYQTwhCX70%2B1MuBBNqQvAsVUygdhbSZflPVFLVYXYCw10pZBosqrbt33MeOhLAD8A8FNaf8XnRxoIDh3nC1b6UKs2zWAsQPsE7gNEmhUsXIocoqXYlZh%2FQZSSdnGUabitNEws3%2FzTErmpCZuC2pr4nC5OCy4AoCpAKYzhiaBnVjXyi1NhUFfB7kXutS3csu0Lk3ScNHi9nlMRK%2FSHZ%2BmmfQUxKvkUG6N76Rrx09p1D%2Brasm6BwCfo%2FSw7hRWxvXSZbCwxc3do9Mpm9IRFA7fgftyitVAMxs%2B8%2FYuoPx7yvUxg0bClyQ192xRI2lA%2B2Re%2FTICR8V2PH0zUKh00J8XQvEL4nx0dQPY1eX5ebqa0OrnmqUj5MM0BpBxhDPhte4fVZA92wwkMCtrgY6sQESsP34nDSGQ6%2FMJpkkUSZiwSB%2F4jJvcrOQGDnz8fYink0yrV9jUVthg%2F0T80d3eDYEK8OVRR2nDjVCUQg3IxtCiugMaPpFUdgVHqXf%2FGpaDapO5M8KW58NB4nk4LoOYgrk9ZTwWMl3jVREWlQWgRKb1D2x8jgp12%2B72xMOnvcfsjT5bTR2OBDEBsh2BamCCdP1z2L0lwJwCGwomgMutcDqcL1aIj%2F%2Fac5TUFnKnI3315E%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=4411474dd9ba1978efab3f06494a7d56d80da68edab490e3bda93032089b3f1a",
      "file_size": 4372,
      "type": "text/x-python",
      "moderated": null
    }
  ],
  "allow_singular_disclosure_at": "2021-08-26T23:37:23.370Z",
  "allow_singular_disclosure_after": -77810578.76123513,
  "singular_disclosure_allowed": true,
  "vote_count": 12,
  "voters": [
    "n1m0",
    "tolga",
    "fqdn",
    "run_win",
    "ali",
    "akashhamal0x01",
    "sldwn",
    "acka",
    "ganeshsecure",
    "aseem0xff",
    "and 2 more..."
  ],
  "severity": {
    "rating": "high",
    "score": 8.8,
    "author_type": "User",
    "metrics": {
      "attack_vector": "network",
      "attack_complexity": "low",
      "privileges_required": "low",
      "user_interaction": "none",
      "scope": "unchanged",
      "confidentiality": "high",
      "integrity": "high",
      "availability": "high"
    }
  },
  "structured_scope": {
    "databaseId": 84124,
    "asset_type": "OTHER",
    "asset_identifier": "IBB (Legacy)",
    "max_severity": "none"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
