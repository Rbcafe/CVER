{
  "id": 227344,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMjczNDQ=",
  "url": "https://hackerone.com/reports/227344",
  "title": "CVE-2017-8798 - miniupnp getHTTPResponse chunked encoding integer signedness error",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "high",
  "readable_substate": "Resolved",
  "created_at": "2017-05-09T21:29:06.805Z",
  "submitted_at": "2017-05-09T21:29:06.805Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "hxd",
    "url": "/hxd",
    "profile_picture_urls": {
      "small": "/assets/avatars/default-25f7248a18bdf9e2dc8310319b148d66cff430fa0fade6c5f25fee1b8d7f27ed.png"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 54349,
    "url": "https://hackerone.com/ibb",
    "handle": "ibb",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQQ3BKZOEE%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T124148Z&X-Amz-Expires=1679&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIG6IenXByqkn3Q4DzIOoyCRmUa9piCrSguk1c5%2FILyJ7AiEAykcOsXd4dfj0MtryP7Ypqcz0EGqy2srC7Ahyju9P1wwqsgUIcBADGgwwMTM2MTkyNzQ4NDkiDNoh%2FatXkiXqzvRarSqPBSxRPdxDhM3ZWovfuUDFze8TKTTXyWnM%2BqLvvwol8L9J5VDQFkQXA7smucDX4AEp9WwjM1M5SoDxfIqGVNACAZ%2FhCWOou%2FjPGm5hXxkVid3k%2FfBEIUStu2OCGILQXKrFXckdXocqxibxJkp9FBscVVfy1z9spS224jk9a64wEyKkB%2FEqDONaGznbocoqfOWRO2gk3kN2mF%2FlFYwuvjMbBGI25CA0c8P0uDrdXv75mMgHiHzhQ2UA0io6mOBJRxlcl5iTWXpEwOcbqq7%2B5ONf7AQWMJlf044SZPS7ctrMSsbHt11897THGeHPEYn6tBP8I5Fnd6qJj2f%2FVMm2nAjyPv65mqH9IFrso33MbOg9OScFT8GcXL%2FSL9CsmuqI8DAuHV2TQ6tOcf60FFoK%2FNc8%2BH1opXPi5t84Wy8dXz0ShSZARezbri6JYCQuZaMmQWSTRbaOxgDpQUbmc2MtnSfbshwx0iX%2BKoAaAhWHkgNlastBKxxdkZZfKj3uPWL%2FAZpJ5vQ3aCiYuhMiLdSNoDq04UJUEE6U3x5bncELirAw9rSBGBlZ2LnTIizRqNNZcm4bzUeL8KfXYWONTy2NjqxuN2Pv%2FhvWs7ZeUu%2Bl5RyG%2BaglXVojqzVcfe0pYyyTxENUtLQnCxv1F6%2BFRPB1kbi%2FlMdY30Ih91ui923zixOr4x2bTvqsEUosHXQuAePevTEs9cXth9Tl9dEZ77qdYODIErVxnZKWIWL%2Bdg57Wo05wOYkPoMuK0ANx9QnIFRVpYN51rM3ygm3cI0FCy6O67TKyAzlM4W7pyg0gugDJWcmjphUjUsnNWj%2BZQCUHNlg0hrBypo%2BHXJ4oZgGe0%2F80G6Eur1xfPo2GRyn5qtYCGPsRlYw8qesrgY6sQGYbS8MxVrsunWUBMnltzktg6eAZ8fvxgC5j8%2BYmwaIMOuBsufYAl7nKraCTIkLFC7rGgVC8sqvqoXBLrYQFqgLumTDGfWJUNAVMAVtqNo%2BIL8JvOZD%2FTW4GOmqGMXOgQRmU1Wa7j36A2IvAe7wpP5z8dprPILpwsnYzL4pzdM%2FrRrGA5fhAddbNV%2BDoX4yqjS2RN%2BKe8v5EYqHMPr2TCLmUPcDm070amRAZC10%2F9gLePE%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=0a2c7e313971f8bdd2de6086faef361c8207a8e37c22893dfe76825880ff8609",
      "medium": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQQ3BKZOEE%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T124148Z&X-Amz-Expires=1679&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIG6IenXByqkn3Q4DzIOoyCRmUa9piCrSguk1c5%2FILyJ7AiEAykcOsXd4dfj0MtryP7Ypqcz0EGqy2srC7Ahyju9P1wwqsgUIcBADGgwwMTM2MTkyNzQ4NDkiDNoh%2FatXkiXqzvRarSqPBSxRPdxDhM3ZWovfuUDFze8TKTTXyWnM%2BqLvvwol8L9J5VDQFkQXA7smucDX4AEp9WwjM1M5SoDxfIqGVNACAZ%2FhCWOou%2FjPGm5hXxkVid3k%2FfBEIUStu2OCGILQXKrFXckdXocqxibxJkp9FBscVVfy1z9spS224jk9a64wEyKkB%2FEqDONaGznbocoqfOWRO2gk3kN2mF%2FlFYwuvjMbBGI25CA0c8P0uDrdXv75mMgHiHzhQ2UA0io6mOBJRxlcl5iTWXpEwOcbqq7%2B5ONf7AQWMJlf044SZPS7ctrMSsbHt11897THGeHPEYn6tBP8I5Fnd6qJj2f%2FVMm2nAjyPv65mqH9IFrso33MbOg9OScFT8GcXL%2FSL9CsmuqI8DAuHV2TQ6tOcf60FFoK%2FNc8%2BH1opXPi5t84Wy8dXz0ShSZARezbri6JYCQuZaMmQWSTRbaOxgDpQUbmc2MtnSfbshwx0iX%2BKoAaAhWHkgNlastBKxxdkZZfKj3uPWL%2FAZpJ5vQ3aCiYuhMiLdSNoDq04UJUEE6U3x5bncELirAw9rSBGBlZ2LnTIizRqNNZcm4bzUeL8KfXYWONTy2NjqxuN2Pv%2FhvWs7ZeUu%2Bl5RyG%2BaglXVojqzVcfe0pYyyTxENUtLQnCxv1F6%2BFRPB1kbi%2FlMdY30Ih91ui923zixOr4x2bTvqsEUosHXQuAePevTEs9cXth9Tl9dEZ77qdYODIErVxnZKWIWL%2Bdg57Wo05wOYkPoMuK0ANx9QnIFRVpYN51rM3ygm3cI0FCy6O67TKyAzlM4W7pyg0gugDJWcmjphUjUsnNWj%2BZQCUHNlg0hrBypo%2BHXJ4oZgGe0%2F80G6Eur1xfPo2GRyn5qtYCGPsRlYw8qesrgY6sQGYbS8MxVrsunWUBMnltzktg6eAZ8fvxgC5j8%2BYmwaIMOuBsufYAl7nKraCTIkLFC7rGgVC8sqvqoXBLrYQFqgLumTDGfWJUNAVMAVtqNo%2BIL8JvOZD%2FTW4GOmqGMXOgQRmU1Wa7j36A2IvAe7wpP5z8dprPILpwsnYzL4pzdM%2FrRrGA5fhAddbNV%2BDoX4yqjS2RN%2BKe8v5EYqHMPr2TCLmUPcDm070amRAZC10%2F9gLePE%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=8cb7316a10b8de410380530c67f230c9f5db7ddda88dad3d80dfc363d1559e1b"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Internet Bug Bounty",
      "twitter_handle": "",
      "website": "https://www.hackerone.com/internet-bug-bounty",
      "about": "The Internet Bug Bounty rewards security research into vulnerabilities impacting Open Source Software Projects."
    }
  },
  "has_bounty?": false,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [
    "CVE-2017-8798"
  ],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2019-11-12T23:48:49.780Z",
  "bug_reporter_agreed_on_going_public_at": null,
  "team_member_agreed_on_going_public_at": "2019-10-13T23:48:40.232Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "### Integer signedness error in miniupnpc [1]  allows remote attackers to cause a denial of service condition (access violation and heap corruption) via specially crafted HTTP response\n\nAn integer signedness error was found in miniupnp's `miniwget` allowing \nan unauthenticated remote entity typically located on the\nlocal network segment to trigger a heap corruption or an access violation\nin miniupnp's http response parser when processing a specially crafted\nchunked-encoded response to a request for the xml root description url.\n\n* affects\n * all versions >= `v1.4.20101221` (released 21/12/2010; `~6 years ago`)\n * all configurations as its a core part of the library\n* impact\n * DoS (access violation due to buffer overread memcpy)\n * Heap Overwrite (pot. race RCE in multithreaded envs)\n* requirements\n  * no user interaction, unauth, low complexity\n* how widespread is this software?\n * miniupnpc is compiled into a wide range of network applications and embedded device firmware.\n * blockchain clients: `bitcoind` and almost all forks, `CPP ethereum`, ...\n * p2p filesharing applications: `qBittorrent`, `Transmission`, ...\n * network device firmware: `dlink`, `linksys`, probably `synology` or anything that allows IGD management / portforwarding\n * numerous hits for `miniwget` on google or github.  closed source obviously not included but its likely to find this lib packed with embedded devices.\n* disclosure\n * provided detailed description, PoC and patch\n * status: fixed; within 8 days.\n\nThe vulnerable component is a HTTP file download method called \n`miniwget` (precisely `getHTTPResponse`) that fails to properly handle \ninvalid chunked-encoded HTTP responses. The root cause is a bounds check\nthat mistakenly casts an unsigned attacker-provided chunksize to signed \nint leading to an incorrect decision on the destination heap buffer size \nwhen copying data from the server response to an internal buffer. The \nattacker controls both the size of the internal buffer as well as the \nnumber of bytes to copy. In order for this attack to succeed, the number \nof bytes to copy must be negative.\n\nattacker controls:\n* `int content_length`\n* `unsigned int chunksize`\n* `bytestocopy` if `(int) chunksize` is negative (or at least < `n-i` ~ 1900 bytes)\n* length of `content_buf` if `bytestocopy` is negative\n\nIn the end, the attacker has almost full control of the following two methods\n* `realloc(content_buf, content_length)`\n* `memcpy(content_buf+x, http_response, chunksize)`\n\n\naffected methods (almost all exposed API):\n\n        basically all `miniwget*` and `UPNP_*` methods.\n        * getHTTPResponse (vulnerable)\n          * miniwget3\n           * miniwget2\n            * miniwget\n            * miniwget_getaddr\n             * UPNP_GetIGDFromUrl\n             * UPNP_GetValidIGD\n              * UPnP_selectigd\n          * UPNP_Get*\n          * UPNP_Check*\n          * UPNP_Delete*\n          * UPNP_Update*\n          * UPNP_Add*\n\n\nThis vulnerability is easily exploitable with an attacker being on the same network segment/multicast domain by answering SSDP discovery requests (1) (or sending notification requests) providing an URL to the attacker controlled webserver. Answering this request (2) makes upnp clients download a description file from that webserver (3)(4) in order to learn more about the capabilities of the Internet Gateway Device (IGD). By providing a negative chunk length in the chunked-encoded answer (4) to this request the malicious webserver triggers the vulnerability. This way one malicous client could exploit all other clients in the same multicast domain. (Funny sidenote: I had to implement a target ip filter otherwise the PoC would attract devices like a magnet and crash all of them)\n\n```\n      client (miniupnpc)                         server (poc.py)\n          |                                         |\n          |                                         |\n          | SSDP:  Discovery - M-SEARCH             |\n      1.  | --------------------------------------> |\n          |                                         |\n          | SSDP:  Reply - Location Header          |\n      2.  | <-------------------------------------- |\n          |                                         |\n          | SCPD:  GET (Location Header/xxxx.xml)   |\n      3.  | --------------------------------------> |\n          |                                         |\n          | SCPD:  HTTP chunked-encoded reply       |\n      4.  | <-------------------------------------- |\n          |                                         |\n\n```\n*Note*: the vulnerability is basically not bound to the adjacent network since `miniwget` could also be used to download arbitrary files on the internet. This is just the most common/typical vector, otherwise the CVSS score would be higher.\n\n##### Disclosure\n\ncoordinated disclosure and reported to the miniupnp project owner, provided `detailed vulnerability analysis`, a one-click exploit all `PoC` and a minimal `patch`. The patch was accepted with minor changes. Fixed within a few days of first contact (May 1st ->May 9th). \n\ndetails and the actual research material that was securely shared with the miniupnp project is going to be be pushed to the following github repository once vendors picked up the changes: https://github.com/tintinweb/pub/tree/master/pocs/cve-2017-8798\n\nVendor response [2] and Patch [3]\n\n❤ Thanks to miniupnp for treating this with priority. \n\n  [1] http://miniupnp.free.fr\n  [2] http://miniupnp.free.fr/files/changelog.php?file=miniupnpc-2.0.20170509.tar.gz\n  [3] https://github.com/miniupnp/miniupnp/commit/f0f1f4b22d6a98536377a1bb07e7c20e4703d229",
  "weakness": {
    "id": 15,
    "name": "Integer Overflow"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2019-11-12T23:48:40.348Z",
  "allow_singular_disclosure_after": -134225587.7887097,
  "singular_disclosure_allowed": true,
  "vote_count": 2,
  "voters": [
    "base_64",
    "spetr0x"
  ],
  "severity": {
    "rating": "high",
    "score": 7.1,
    "author_type": "User",
    "metrics": {
      "attack_vector": "adjacent",
      "attack_complexity": "low",
      "privileges_required": "none",
      "user_interaction": "none",
      "scope": "unchanged",
      "confidentiality": "none",
      "integrity": "low",
      "availability": "high"
    }
  },
  "structured_scope": {
    "databaseId": 84121,
    "asset_type": "OTHER",
    "asset_identifier": "IBB (Legacy)",
    "max_severity": "none"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
