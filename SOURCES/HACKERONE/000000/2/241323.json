{
  "id": 241323,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yNDEzMjM=",
  "url": "https://hackerone.com/reports/241323",
  "title": "woocommerce - prevent_caching() bug / bypass",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "medium",
  "readable_substate": "Resolved",
  "created_at": "2017-06-19T13:42:48.428Z",
  "submitted_at": "2017-06-19T13:42:48.428Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": true,
    "username": "b258ea62bf297b02afa9854",
    "url": "/b258ea62bf297b02afa9854",
    "profile_picture_urls": {
      "small": "/assets/avatars/default-25f7248a18bdf9e2dc8310319b148d66cff430fa0fade6c5f25fee1b8d7f27ed.png"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 111,
    "url": "https://hackerone.com/automattic",
    "handle": "automattic",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/000/111/7f89e1ea233f92916202521a069fdbfe9eced339_original.png/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/000/000/111/7f89e1ea233f92916202521a069fdbfe9eced339_original.png/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Automattic",
      "twitter_handle": "",
      "website": "https://automattic.com",
      "about": "WordPress.com, Jetpack, Texts, Akismet, Gravatar, WooCommerce, Crowdsignal, Tumblr and more!"
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": true,
  "disclosed_at": "2017-09-16T07:52:21.202Z",
  "bug_reporter_agreed_on_going_public_at": "2017-08-17T07:52:02.627Z",
  "team_member_agreed_on_going_public_at": null,
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "As guest visit the following links and look at the headers. Yup there are not caching headers in the response. \n(https://woocommerce.com/.cart/)[https://woocommerce.com/.cart/]\n(https://woocommerce.com/+cart/)[https://woocommerce.com/+cart/]\n(https://woocommerce.com/-cart/)[https://woocommerce.com/-cart/]\n\n```\naccept-ranges:bytes\nage:0\ncontent-encoding:gzip\ncontent-type:text/html; charset=UTF-8\ndate:Mon, 19 Jun 2017 13:25:20 GMT\nlink:<https://woocommerce.com/wp-json/>; rel=\"https://api.w.org/\"\nlink:<https://woocommerce.com/?p=18552>; rel=shortlink\nserver:nginx\nset-cookie:woocommerce_items_in_cart=1; path=/\nset-cookie:woocommerce_cart_hash=c670f81df612aa5e067bc7d1a33673da; path=/\nset-cookie:wp_woocommerce_session_241766cd983ad3375c92fb5411ecef50=159536bf377374fa447e91a16437e611%7C%7C1498051468%7C%7C1498047868%7C%7Cbfae081ff1a2c69f9e4feda8128c7579; expires=Wed, 21-Jun-2017 13:24:28 GMT; Max-Age=172748; path=/\nstatus:200\nx-cache:pass\nx-hacker:If you're reading this, you should visit automattic.com/jobs and apply to join the fun, mention this header.\nx-pingback:https://woocommerce.com/xmlrpc.php\nx-rq:vie1 87 24 3240\n```\nWhat happens?\n\nFunction `prevent_caching()` in the `class-wc-cache-helper.php` have the following line of code:\n```\nif ( stristr( trailingslashit( $_SERVER['REQUEST_URI'] ), $uri ) ) {\n```\nin order to protect the `cart`, `my-account` and `checkout` dynamic pages from being cached by caching wordpress plugins ( defines the caching constants ) or cloud proxies (sets no caching headers).\n\nBut from the wordpress itself we got the following e.g. pagename query param is passed trough `sanitize_title_with_dashes` and only thing left for successful exploitation/attack in case of woocomerce instance remains to defeat the `redirect_canonical` which is bypassed by `-`, `+` and `.` characters. This means that $_SERVER['REQUEST_URI'] will have this type of value `/+my-account/` and needle will be `/my-account/`  and this will return false ofc. :)\n\nThis way in case of existing caching plugin set up to cache the wordpress pages even for logged in users, woocommerce store that allows guests to buy products or some another cases of web setups cache  deception  attack is ready to go. \n\nFix: Don't rely on the `$_SERVER['REQUEST_URI']` param, but use it query object to get the pagename.",
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2017-09-16T07:52:02.687Z",
  "allow_singular_disclosure_after": -202279935.11606458,
  "singular_disclosure_allowed": true,
  "vote_count": 9,
  "voters": [
    "marcs0h",
    "sp1d3rs",
    "cuso4",
    "r3y",
    "eveeez",
    "khizer47",
    "alfredsaonoy",
    "muztahidultan1m",
    "japz"
  ],
  "severity": {
    "rating": "medium",
    "author_type": "User"
  },
  "structured_scope": null,
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
