{
  "id": 661051,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC82NjEwNTE=",
  "url": "https://hackerone.com/reports/661051",
  "title": "Message Authentication Codes calculated by the Default Encryption Module allow an attacker to silently overwrite blocks in a file",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "low",
  "readable_substate": "Resolved",
  "created_at": "2019-07-26T11:03:14.045Z",
  "submitted_at": "2019-07-26T11:03:14.045Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "yahe",
    "url": "/yahe",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/0lg7nic0d0quts8mwr9b7bqk56rl/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 13291,
    "url": "https://hackerone.com/nextcloud",
    "handle": "nextcloud",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/tnqlkt8d6fcch8hj8brdjp8nw864/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/tnqlkt8d6fcch8hj8brdjp8nw864/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Nextcloud",
      "twitter_handle": "nextclouders",
      "website": "https://nextcloud.com",
      "about": "Access, share and protect your files, calendars, contacts, communication & more at home and in your enterprise."
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [
    "CVE-2020-8133"
  ],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2020-11-05T07:59:48.349Z",
  "bug_reporter_agreed_on_going_public_at": null,
  "team_member_agreed_on_going_public_at": "2020-10-06T07:59:48.071Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "**First:** The default encryption module bundled with the Nextcloud Server creates SHA256-HMAC based message authentication codes for each individual 6072 byte-sized block of data. These are the steps to calculate the MAC:\n\n* Take the user password and harden it with SHA256-PBKDF2 (denoted as `$passPhrase` in \\[1\\]).\n* Concatenate `$passPhrase`, `$version` (which is the value `encrypted` from the `oc_filecache` table), `$position` (which is the zero-based index of the encrypted block within the file) and `\"a\"` and create a SHA512 hash of it (denoted as `$passPhrase` in \\[2\\]).\n* Most MACs of file blocks are created under the salt `hash('sha512', $passPhrase.$version.$position.\"a\", true)` with the exception of the last file block which uses the salt `hash('sha512', $passPhrase.$version.$position.\"end\".\"a\", true)`,\n* Finally create a SHA256-HMAC of the data under the salt `$passPhrase` (as seen in \\[3\\]).\n\n**Second:** An encrypted file uses the same file key (stored in the corresponding `fileKey` file) and envelope keys (stored in the corresponding `shareKey` files) as its stored file versions.\n\n**Third:** To prevent a file from being  truncated the last block uses a different salt (containing `\"end\"`). To prevent file blocks from being moved within a file each message authentication key contains the `$position` of the block within the file. To prevent file blocks from being moved between different versions of the same file each message authentication key contains the `$version` of the file.\n\n**Fourth:** However, the concatenation that is used to create message authentication key is ambiguous. It is e.g. not possible to differentiate between the block with `$position` 10 in `$version` 1 of a file (being `$passPhrase.\"1\".\"10\".\"a\"`) and the block with `$position` 0 in `$version` 11 of a file (being `$passPhrase.\"11\".\"0\".\"a\"`). This way the contents of a properly encrypted and signed file can be modified without breaking the signature check.\n\n**Fifth:** The following steps describe a simple proof of concept:\n\nCreate a file consisting of 6072 * 10 \"A\" + 6072 \"B\" + 1 \"1\":\n\n```\nphp -r 'print(str_repeat(\"A\", 6072*10).str_repeat(\"B\", 6072).\"1\");' >./collision.txt\n```\n\nUpload the file to Nextcloud and visit the folder in which Nextcloud stored the encrypted and signed version of the file `./collision.txt`. Create a backup of the encrypted version 1:\n\n```\ncp ./collision.txt ./collision.txt.1\n```\n\nOpen the file in Nextcloud text editor and create 11 versions. The easiest way to do this is to scroll to the end of the file, add a character, press CTRL+S twice to make sure that the version has been created and proceed until the file has reached version 11. This can be checked in the database by issuing the following query:\n\n```\nselect encrypted from oc_filecache where path = 'files/collision.txt';\n```\n\nDownload the file to have a sample of the currently valid version of the file. Then overwrite the file block with `$position` 0 of `./collision.txt` with the file block with `$position` 11 of `./collision.txt.1`.\n\n```\ndd if=./collision.txt.1 of=./collision.txt bs=8192 conv=notrunc skip=11 seek=1 count=1\n```\n\nDownload the file again. When comparing the first download of the file with the second download of the file you should see that the first block of the file has been modified without breaking the signature check.\n\n1) [apps/encryption/lib/Crypto/Crypt.php#L194](https://github.com/nextcloud/server/blob/a374d8837d6de459500e619cf608e0721ea14574/apps/encryption/lib/Crypto/Crypt.php#L194)\n2) [apps/encryption/lib/Crypto/Crypt.php#L505](https://github.com/nextcloud/server/blob/a374d8837d6de459500e619cf608e0721ea14574/apps/encryption/lib/Crypto/Crypt.php#L505)\n3) [apps/encryption/lib/Crypto/Crypt.php#L506](https://github.com/nextcloud/server/blob/a374d8837d6de459500e619cf608e0721ea14574/apps/encryption/lib/Crypto/Crypt.php#L506)\n\n## Impact\n\nAn attacker that has permanent access to the file storage like an administrator or external storage provider can learn how many versions of which files exist without needing access to the database by monitoring the created version files over time.\n\nSuch an attacker is able to modify the contents of files by overwriting certain file blocks with specific file blocks from earlier versions of the same files. This file modification is possible **without** having access to any encryption secrets like passwords or keys.\n\nThis attack works against master-key encrypted files as well as against user-key encrypted files.",
  "weakness": {
    "id": 57,
    "name": "Violation of Secure Design Principles"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [
    {
      "id": 539930,
      "file_name": "nextcloud_poc.mp4",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/539/930/61b8729f9104ed066d34b317a6b191c32d296a97/nextcloud_poc.mp4?response-content-disposition=attachment%3B%20filename%3D%22nextcloud_poc.mp4%22%3B%20filename%2A%3DUTF-8%27%27nextcloud_poc.mp4&response-content-type=video%2Fmp4&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQSQ564LXW%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T132546Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQDl76KVUFS0hN8YruFStxJXVErBlHnUq37TLzE6NJ4nVgIhANpbiTp%2BMBG4Nwb5E7dtwmMEX5oh%2FQf%2BDE1tYHw3IkRRKrIFCHUQAxoMMDEzNjE5Mjc0ODQ5IgysR5bYjXDNHPUxaW8qjwUn5sVCnmMuonjKnG%2FT4J4WQrTsBQX1SNmTEPNbtsQv5XcKQaoPHieXQdr%2B%2B1X5avNpXfOZbh0pZ6CXdrJ4yYa55f0HXkeQiH0zcQ0fif5j1pP8jC%2Blsq%2BD9fB7SzZQg6RmosBSYA4XGzLy8%2FPyGRLQ28yjB4W8KTl8fBM4CmJJFWLBmzWUBK2SOnDwMfsDL5%2BmafcYaKkz0yszM1cg3XozTAFLh8hmoIUAWpu77QkIzg0Ht8%2B93fM%2FYsZn5uKr6IpQ2U4pqWdLfB29cuQ%2Fcqg62XxGu%2BLk6jR1jXWEegWhMonWqQeGJPWbh8kEDYxBzUAidK12bSQGyMxonksvquoUumwsvEUzmQd%2BhHIBPGEfHEpImOlgzqswJwZ%2F4JNoWjfIUk3c2lvDijlThqGBqTQoB645h%2B4iprdRTJwkrRB74qIwzHH8cv8viZ7ZrieVZK6heyAtoEGA%2BZN6Yt1%2Fh3uEHlmtJnS1Vmef8OPs7HDSzKz4njXcD7iXOt625xzMEBsfshpisEQDc6V%2BgE%2BBXbdv%2FT4XaJkVUN7kUFRWxoez0R%2FafT55iChRzC%2FCCCtXPxRwQLswXHFkjSKPv6sVfuM5MRTBUP55DDIHcRMXtwEjecS03yT%2BLa3gpqGgU9vRMfcH0LWQdYklhl1sQ6N1w3UJ%2BzTVF7HEgKCpghOKhwVCK9huxD72fxZOO6FF5FJzK3DifWVeM1v32dnnKItdegNY3N8My9s4MQJ%2B3ECyboRUjyg2nm%2BDhuYrpgIelJVrUGgu74IzyiQ2A%2FCKjoDOYFSWGrm4y%2B2UnhJeZRlQds%2FlnTD4xuiMof7htaNeiZuyDqfi6JTbOSG%2FNqB7QSE2ezcJ75qQGAqDpKeqbVdeTC34MIa2ra4GOrABDubMC6LwabfeW3Qsfz2RgL7fTEyxJw929PcIhksJK3EmRE2rUVVoVGGm7fTwmneEB55wcJn7xtg4Rs3f5YiKxBbRlxeqJEXHdJJWWaOq%2BpG%2BMHzVFgbZYimMKoU39IYu2PyQrofnOmHZ%2FEB3I1PLguFv1fjZlzVTHUwnD4kRx2g5tTJLggeCKerD5uXmMSsk8WllCOp%2FdA8M69%2BsXGmqNNPZRG6tkFF%2FJPssbKNyXTU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=8e5aaa9b5834796ca505c5eed9595945dc0d8652c7e31af360bbbd9b777982d2",
      "file_size": 16580675,
      "type": "video/mp4",
      "moderated": null
    }
  ],
  "allow_singular_disclosure_at": "2020-11-05T07:59:48.180Z",
  "allow_singular_disclosure_after": -103267558.08571911,
  "singular_disclosure_allowed": true,
  "vote_count": 8,
  "voters": [
    "tess",
    "ali",
    "demonia",
    "4r75y4n4rch157",
    "joe_glueck",
    "papa_sm1rf",
    "helphen",
    "a21aqwqq"
  ],
  "severity": {
    "rating": "low",
    "score": 1.8,
    "author_type": "User",
    "metrics": {
      "attack_vector": "local",
      "attack_complexity": "high",
      "privileges_required": "high",
      "user_interaction": "required",
      "scope": "unchanged",
      "confidentiality": "none",
      "integrity": "low",
      "availability": "none"
    }
  },
  "structured_scope": {
    "databaseId": 13,
    "asset_type": "SOURCE_CODE",
    "asset_identifier": "nextcloud/server",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
