{
  "id": 195950,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xOTU5NTA=",
  "url": "https://hackerone.com/reports/195950",
  "title": "Use of uninitialized memory in unserialize()",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "medium",
  "readable_substate": "Resolved",
  "created_at": "2017-01-05T11:24:39.937Z",
  "submitted_at": "2017-01-05T11:24:39.937Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "rc0r",
    "url": "/rc0r",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/017/153/304e6c45c12b1b9dec0c6c0f2ebd67341d234566_original.png/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 54349,
    "url": "https://hackerone.com/ibb",
    "handle": "ibb",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQYNWCPB7L%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T123205Z&X-Amz-Expires=2827&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDbZonlQ6XZgqcJy52%2BgLeu7rc%2BcmnwL48Jd3jP8q5%2FnAIgBqR93Cql4TkH3OcEpzuPURjNMviKVAaN%2BZ5EJ93CKHMqsQUIcBADGgwwMTM2MTkyNzQ4NDkiDC6ruR9Bo4NPZ6hGziqOBTlv9ZKHmz6ju1OkdxDfdYMkEOLdYBFwxFeSW3uoBTkUPGqDZadsGRlOm%2FzVtXFfSNIYP7AeaBzFIeS8LcBh%2BgxgmY5hETW2LeYwB%2F3XW2H67p6e7bnzldnlj2tuACFxnKA6rcmcUQTXn4qVKPw%2FsgBonpbjVSLH1G3MhuwcdUrgeFjI7JHFzHMgd7%2BYjdjZMeFC5A7DM0sT8KjQAqMCvmyYUuytyZlFtZt%2BmkPDyj8xPC2BnGzGd8ViwG0oSBCmgyULo8%2BibDGvrMmOjHPDqqUa51uudsuIw3xXCU7yEl54SJO8XPwko%2FUDfNLlPnB%2BsrExqEFkzOUbRn8wytJZJbdlm4PKX7p1sguljWzLGzMthBAcUaMx563jGqM6UBzNW8J7ZvQGt%2B1a3uE51BbOuuys1pnhOCpDb5JVA%2F%2FnzxJBkW450qNxs7qEyti1abXcL80lTaRmG99RCoVXy4Z1np7gmDfekfXlXCBl86B94t2Ng9rjTnc7plMi%2BnjT5NpYRtvlD1UpwqSlpHw2LxzvZHpnEAjgW8aVgyKPoE6tQwMw2sgb02Lt0IOaTIVI9DmdZbb5FIIz5u0W7gGoxWgQ5yaRk5osuY5nK4GSs4uwAAb6e9hPfxePBU%2B3OK%2BLDM2L0ULVBqQLonfTFD4q0hygJNmtMZ93jUiC1uw5seAKU9RQaFXprCUTfTFtdiGuqhtRvHnqNI2%2BYtGwEaoPk45%2FBZHKWdUiA6zzx2Vh1ViwuP2bYU1TfleKuf4XSDTRnsL25sxpXHdWEdzp36j4m8m4N7y9V%2BDLGJL0W5laKN4XaBIRNCwRfNALochyxg%2FRqoYPvilO9klb%2Fo58doCSMcQFz%2B2dImB8vsUlC4TfkCpPPjC7payuBjqxAUz7jVGh5dF5HDYPCV1aK6vLNtHQn48iZT2lveCprzWjOASVNejwySv8S0Qz3%2BorxxSB4hGPZkqz36geF8d9lQ8aLh18bVe6qUL5yM5i2yxVkHovo80Uf9FwD0IrvwxhBv2vzB%2BEuch1dctBkoyLtJS470n%2BuD%2F%2BwCLVUXoH1ljlX3lPqEb2nvs0Eo4v6pGR4x8y4bHoxAxkfJRPNJ4ut4mAE9vidBtOStAITUN8HDLywA%3D%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=444e7057cc059de2b73e9f408ce70e50f4117419ee271f73add19d6eb0de47a8",
      "medium": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQYNWCPB7L%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T123205Z&X-Amz-Expires=2827&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDbZonlQ6XZgqcJy52%2BgLeu7rc%2BcmnwL48Jd3jP8q5%2FnAIgBqR93Cql4TkH3OcEpzuPURjNMviKVAaN%2BZ5EJ93CKHMqsQUIcBADGgwwMTM2MTkyNzQ4NDkiDC6ruR9Bo4NPZ6hGziqOBTlv9ZKHmz6ju1OkdxDfdYMkEOLdYBFwxFeSW3uoBTkUPGqDZadsGRlOm%2FzVtXFfSNIYP7AeaBzFIeS8LcBh%2BgxgmY5hETW2LeYwB%2F3XW2H67p6e7bnzldnlj2tuACFxnKA6rcmcUQTXn4qVKPw%2FsgBonpbjVSLH1G3MhuwcdUrgeFjI7JHFzHMgd7%2BYjdjZMeFC5A7DM0sT8KjQAqMCvmyYUuytyZlFtZt%2BmkPDyj8xPC2BnGzGd8ViwG0oSBCmgyULo8%2BibDGvrMmOjHPDqqUa51uudsuIw3xXCU7yEl54SJO8XPwko%2FUDfNLlPnB%2BsrExqEFkzOUbRn8wytJZJbdlm4PKX7p1sguljWzLGzMthBAcUaMx563jGqM6UBzNW8J7ZvQGt%2B1a3uE51BbOuuys1pnhOCpDb5JVA%2F%2FnzxJBkW450qNxs7qEyti1abXcL80lTaRmG99RCoVXy4Z1np7gmDfekfXlXCBl86B94t2Ng9rjTnc7plMi%2BnjT5NpYRtvlD1UpwqSlpHw2LxzvZHpnEAjgW8aVgyKPoE6tQwMw2sgb02Lt0IOaTIVI9DmdZbb5FIIz5u0W7gGoxWgQ5yaRk5osuY5nK4GSs4uwAAb6e9hPfxePBU%2B3OK%2BLDM2L0ULVBqQLonfTFD4q0hygJNmtMZ93jUiC1uw5seAKU9RQaFXprCUTfTFtdiGuqhtRvHnqNI2%2BYtGwEaoPk45%2FBZHKWdUiA6zzx2Vh1ViwuP2bYU1TfleKuf4XSDTRnsL25sxpXHdWEdzp36j4m8m4N7y9V%2BDLGJL0W5laKN4XaBIRNCwRfNALochyxg%2FRqoYPvilO9klb%2Fo58doCSMcQFz%2B2dImB8vsUlC4TfkCpPPjC7payuBjqxAUz7jVGh5dF5HDYPCV1aK6vLNtHQn48iZT2lveCprzWjOASVNejwySv8S0Qz3%2BorxxSB4hGPZkqz36geF8d9lQ8aLh18bVe6qUL5yM5i2yxVkHovo80Uf9FwD0IrvwxhBv2vzB%2BEuch1dctBkoyLtJS470n%2BuD%2F%2BwCLVUXoH1ljlX3lPqEb2nvs0Eo4v6pGR4x8y4bHoxAxkfJRPNJ4ut4mAE9vidBtOStAITUN8HDLywA%3D%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=365477657bd08181e83b5f1855f6cd116f297efc019371a15c7c885d048e2a52"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Internet Bug Bounty",
      "twitter_handle": "",
      "website": "https://www.hackerone.com/internet-bug-bounty",
      "about": "The Internet Bug Bounty rewards security research into vulnerabilities impacting Open Source Software Projects."
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [
    "CVE-2017-5340"
  ],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2017-06-01T18:41:51.251Z",
  "bug_reporter_agreed_on_going_public_at": null,
  "team_member_agreed_on_going_public_at": "2017-06-01T18:41:44.660Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "The following is a copy of the bug report at https://bugs.php.net/bug.php?id=73832\n\n# Description\n\nThere was found a bug showing that PHP uses uninitialized memory during\ncalls to `unserialize()`. As the following report shows, the payload supplied\nto `unserialize()` may control this uninitialized memory region and thus may\nbe used to trick PHP into operating on faked objects and calling attacker\ncontrolled destructor function pointers. The supplied proof of concept exploit\npractically demonstrates the issue by executing arbitrary code solely by\npassing a specially crafted string to `unserialize()`. Even though this\nparticular demo exploit only works locally this flaw is very likely to also\nallow for remote code execution.\n\nThis bug was found using `afl-fuzz` / `afl-utils`.\n\n\n# Analysis\n\nThe following shows a short gdb dump of the flaw in a custom-built PHP (git\nmaster on 40727d7ce9) with debugging symbols ([1], [2]):\n\n    $ gdb ./sapi/cli/php\n    gdb> r test.php payload.master\n    [...]\n    Fatal error: Possible integer overflow in memory allocation (2736264714 * 32 + 32) in test.php on line 6\n\n    Program received signal SIGSEGV, Segmentation fault.\n    gdb> i r\n    rax            0x7ffff7fb673c\t140737353836348\n    rbx            0x3030303030303030\t3472328296227680304\n    rcx            0xf6d9\t63193\n    rdx            0x1cb8c30\t30116912\n    rsi            0x0\t0\n    rdi            0x3030303030303030\t3472328296227680304\n    rbp            0x30303030\t0x30303030\n    rsp            0x7fffffffc080\t0x7fffffffc080\n    r8             0x7ffff7fb6740\t140737353836352\n    r9             0x1cb4d00\t30100736\n    r10            0xeb\t235\n    r11            0x206\t518\n    r12            0x1c96ad8\t29977304\n    r13            0x30303030\t808464432\n    r14            0x7ffff167be00\t140737243495936\n    r15            0x3030303030303030\t3472328296227680304         << !!!\n    rip            0x10b63d7\t0x10b63d7 <zend_hash_destroy+327>\n    eflags         0x10202\t[ IF RF ]\n    cs             0x33\t51\n    ss             0x2b\t43\n    ds             0x0\t0\n    es             0x0\t0\n    fs             0x0\t0\n    gs             0x0\t0\n    gdb> x/i $rip\n    => 0x10b63d7 <zend_hash_destroy+327>:\tcallq  *%r15\n    gdb> bt\n    #0  0x00000000010b63d7 in zend_hash_destroy (ht=<optimized out>) at Zend/zend_hash.c:1233\n    #1  0x00000000010b7914 in zend_array_destroy (ht=0x7ffff167be00) at Zend/zend_hash.c:1293\n    #2  0x000000000106f59e in _zval_dtor_func (p=0x7ffff167be00) at Zend/zend_variables.c:43\n    #3  0x00000000010b708e in i_zval_ptr_dtor (zval_ptr=<optimized out>) at Zend/zend_variables.h:49\n    #4  zend_array_destroy (ht=<optimized out>) at Zend/zend_hash.c:1303\n    #5  0x000000000106f59e in _zval_dtor_func (p=0x7ffff167bce8) at Zend/zend_variables.c:43\n    #6  0x00000000010b708e in i_zval_ptr_dtor (zval_ptr=<optimized out>) at Zend/zend_variables.h:49\n    #7  zend_array_destroy (ht=<optimized out>) at Zend/zend_hash.c:1303\n    [...]\n    #83 0x000000000106f59e in _zval_dtor_func (p=0x7ffff1656540) at Zend/zend_variables.c:43\n    #84 0x00000000010b708e in i_zval_ptr_dtor (zval_ptr=<optimized out>) at Zend/zend_variables.h:49\n    #85 zend_array_destroy (ht=<optimized out>) at Zend/zend_hash.c:1303\n    #86 0x000000000106f59e in _zval_dtor_func (p=0x7ffff1656428) at Zend/zend_variables.c:43\n    #87 0x00000000010b7323 in i_zval_ptr_dtor (zval_ptr=<optimized out>) at Zend/zend_variables.h:49\n    #88 zend_array_destroy (ht=<optimized out>) at Zend/zend_hash.c:1307\n    #89 0x0000000001137a3d in zend_object_std_dtor (object=0x7ffff165c960) at Zend/zend_objects.c:60\n    #90 0x0000000001147fdf in zend_objects_store_free_object_storage (objects=<optimized out>) at Zend/zend_objects_API.c:99\n    #91 0x000000000103ce3b in shutdown_executor () at Zend/zend_execute_API.c:359\n    #92 0x0000000001073599 in zend_deactivate () at Zend/zend.c:997\n    #93 0x0000000000f27ff1 in php_request_shutdown (dummy=<optimized out>) at main/main.c:1873\n    #94 0x0000000001355e25 in do_cli (argc=<optimized out>, argv=<optimized out>) at sapi/cli/php_cli.c:1161\n    #95 0x00000000013533d5 in main (argc=<optimized out>, argv=<optimized out>) at sapi/cli/php_cli.c:1387\n\nSome more in-depth debugging walk through follows:\n \n    $ gdb ./sapi/cli/php\n    gdb> b zend_hash_destroy\n    gdb> ign 1 2\n    gdb> r test.php payload.master\n    gdb> p ht\n    $6 = (HashTable *) 0x7ffff167be00\n    gdb> p *ht\n    $7 = {\n      gc = {\n        refcount = 0, \n        u = {\n          v = {\n            type = 1 '\\001', \n            flags = 0 '\\000', \n            gc_info = 32768\n          }, \n          type_info = 2147483649\n        }\n      }, \n      u = {\n        v = {\n          flags = 18 '\\022', \n          nApplyCount = 0 '\\000', \n          nIteratorsCount = 0 '\\000', \n          consistency = 0 '\\000'\n        }, \n        flags = 18\n      }, \n      nTableMask = 808464432, \n      arData = 0x3030303030303030, \n      nNumUsed = 808464432, \n      nNumOfElements = 808464432, \n      nTableSize = 808464432, \n      nInternalPointer = 808464432, \n      nNextFreeElement = 3472328296227680304, \n      pDestructor = 0x3030303030303030\n    }\n    gdb> awatch *0x7ffff167be00\n    gdb> dis 1\n    gdb> r\n    Hardware access (read/write) watchpoint 2: *0x7ffff167be00\n    Value = 808464432\n    0x00007ffff5103d44 in __memmove_sse2_unaligned_erms () from /usr/lib/libc.so.6\n    gdb> x/20x 0x00007ffff167be00\n    0x7ffff167be00:\t0x30303030\t0x30303030\t0x30303030\t0x30303030\n    0x7ffff167be10:\t0x30303030\t0x30303030\t0x30303030\t0x30303030\n    0x7ffff167be20:\t0x30303030\t0x30303030\t0x30303030\t0x30303030\n    0x7ffff167be30:\t0x30303030\t0x30303030\t0x30303030\t0x30303030\n    0x7ffff167be40:\t0x30303030\t0x30303030\t0x30303030\t0x30303030\n    gdb> c // (multiple times)\n    [...]\n    Hardware access (read/write) watchpoint 2: *0x7ffff167be00\n\n    Value = -244859336\n    0x0000000000fdcacb in zend_mm_alloc_small (size=<optimized out>, heap=<optimized out>, bin_num=<optimized out>) at Zend/zend_alloc.c:1261\n    1261\t\t\theap->free_slot[bin_num] = p->next_free_slot;\n    >>> bt\n    #0  0x0000000000fdcacb in zend_mm_alloc_small (size=<optimized out>, heap=<optimized out>, bin_num=<optimized out>) at Zend/zend_alloc.c:1261\n    #1  _emalloc_56 () at Zend/zend_alloc.c:2336\n    #2  0x000000000107f6f7 in _array_init (arg=0x7ffff16673c0, size=2736264714) at Zend/zend_API.c:1060\n    #3  0x0000000000e23888 in php_var_unserialize_internal (rval=<optimized out>, p=<optimized out>, max=<optimized out>, var_hash=<optimized out>) at ext/standard/var_unserializer.re:788\n\nFrom the above backtrace one can see PHP tries to allocate memory for a\n`zend_array` of very large length corresponding to `a:9000111000000010:{...`\nin `payload.master` ([2]).\nThis allocation fails a bit later because of an integer overflow in the size\nparameter that is detected in `zend_hash_check_size()` called from\n`_zend_hash_init()`. As soon as this overflow is detected, PHP starts to\nshut down. At this point the contents of the partially initialized `zend_array`\nlook as follows:\n\n    gdb> c\n    Fatal error: Possible integer overflow in memory allocation (2736264714 * 32 + 32) in test.php on line 6\n    Hardware access (read/write) watchpoint 2: *0x7ffff167be00\n\n    Value = 1\n    0x00000000010b6f6e in i_zval_ptr_dtor (zval_ptr=<optimized out>) at Zend/zend_variables.h:48\n    48\t\t\tif (!--GC_REFCOUNT(ref)) {\n    gdb> x/16x 0x00007ffff167be00\n    0x7ffff167be00:\t0x00000001\t0x00008007\t0x00000012\t0x30303030\n    0x7ffff167be10:\t0x30303030\t0x30303030\t0x30303030\t0x30303030\n    0x7ffff167be20:\t0x30303030\t0x30303030\t0x30303030\t0x30303030\n    0x7ffff167be30:\t0x30303030\t0x30303030\t0xf167be70\t0x00007fff \n\nDuring shutdown PHP attempts to destroy its internal objects as well as the\ncorrupted array shown above. Therefore at some point the arrays own destructor\ngets called from `zend_hash_destroy()` which was overwritten with user supplied\ncontents:\n \n```c\nZEND_API void ZEND_FASTCALL zend_hash_destroy(HashTable *ht)\n{\n// ...\n1231 \t\t\t\tif (HT_IS_WITHOUT_HOLES(ht)) {\n1232 \t\t\t\t\tdo {\n1233 \t\t\t\t\t\tht->pDestructor(&p->val);\n1234 \t\t\t\t\t} while (++p != end);\n1235 \t\t\t\t} else {\n// ...\n```\n\n\n# PoC\n\nThe following PoC exploit was developed for PHP 7.0.14 shipped with the\nArchlinux (x64) distribution:\n\n    $ uname -a\n    Linux box01 4.8.13-1-ARCH #1 SMP PREEMPT Fri Dec 9 07:24:34 CET 2016 x86_64 GNU/Linux\n    $ php --version\n    PHP 7.0.14 (cli) (built: Dec  7 2016 17:11:27) ( NTS )\n    Copyright (c) 1997-2016 The PHP Group\n    Zend Engine v3.0.0, Copyright (c) 1998-2016 Zend Technologies\n\nFor the PoC `exploit.py` ([3]) to work you'll need the PHP test script\n`test.php` ([1]) as well as the master payload file `payload.master` ([2])\nto be placed in the same directory.\nThe PoC contains ROP gadgets for php-7.0.13-* and php-7.0.14 of Arch linux.\nUncomment them as needed.\n\n    $ python exploit.py\n    [............... <gnome-calculator pops open!> ......]\n\nUpon success `gnome-calculator` should be executed. You may want to replace\n`gnome-calculator` with sth. else like, f.e. `touch a` in `epxloit.py` in case\nyou want to test this without `gnome-calculator` present.\n\n\n# References\n\n[1](http://hlt99.blinkenshell.org/php/gfhd8763lkjdg3149nop1qyt/test.php)\n[2](http://hlt99.blinkenshell.org/php/gfhd8763lkjdg3149nop1qyt/payload.master)\n[3](http://hlt99.blinkenshell.org/php/gfhd8763lkjdg3149nop1qyt/exploit.py)\n\n\n# PHP versions known to be affected\n\n7.0.13 (Arch Linux)\n7.0.13-* (Arch Linux)\n7.0.14 (Arch Linux)\nmaster on Github (as of commit 40727d7ce9)\n\nVersions prior to 7.0.13 have not been tested.\n\n\n\n# Reporters\n\nrc0r <hlt99@blinkenshell.org>\nHenri Salo from Nixu Corporation\n\n\n# Thanks\n\nA very big thank you goes to Kapsi internet-käyttäjät ry for providing\nvaluable fuzzing resources!",
  "weakness": {
    "id": 70,
    "name": "Code Injection"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2017-07-01T18:41:44.738Z",
  "allow_singular_disclosure_after": -208893020.715402,
  "singular_disclosure_allowed": true,
  "vote_count": 3,
  "voters": [
    "eveeez",
    "virgindad",
    "spetr0x"
  ],
  "severity": {
    "rating": "medium",
    "author_type": "Team"
  },
  "structured_scope": {
    "databaseId": 84120,
    "asset_type": "OTHER",
    "asset_identifier": "PHP",
    "max_severity": "none"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
