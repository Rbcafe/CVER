{
  "id": 361341,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zNjEzNDE=",
  "url": "https://hackerone.com/reports/361341",
  "title": "Unsafe deserialization in Libera Pay allows to escalate a SQL injection to Remote Command Execution",
  "state": "Closed",
  "substate": "resolved",
  "readable_substate": "Resolved",
  "created_at": "2018-06-03T13:37:46.400Z",
  "submitted_at": "2018-06-03T13:37:46.400Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "kapytein",
    "url": "/kapytein",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/36yjb4mltb4jebgvw3esuaw059a0/ede8cd84a64d5392a2bb88ecb598721116469c27c015c2caa77148f11e211d58"
    },
    "is_me?": false,
    "cleared": true,
    "verified": true,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 28411,
    "url": "https://hackerone.com/liberapay",
    "handle": "liberapay",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/028/411/c0a012abdcef38b417e29616505b1a3b4ed87b81_original./d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/000/028/411/c0a012abdcef38b417e29616505b1a3b4ed87b81_original./5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
    },
    "permissions": [],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Liberapay",
      "twitter_handle": "liberapay",
      "website": "https://liberapay.com",
      "about": "An open source platform designed to facilitate recurrent donations."
    }
  },
  "has_bounty?": false,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2018-06-04T17:42:54.585Z",
  "bug_reporter_agreed_on_going_public_at": "2018-06-04T17:42:54.496Z",
  "team_member_agreed_on_going_public_at": "2018-06-04T17:30:23.624Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "Hello.\n\nThere isn't a direct vulnerability, however a SQL injection would easily be escalated to a Remote Code Execution. I can't directly exploit it due to the restriction on team names (it does not accept hexdecimal values). I, however, submit this issue in advance and will attempt to escalate this issue further, if possible together with you.\n\n**Vulnerability details**\n\nThe vulnerability relies in the serializer & deserializier used for notifications of users. It is using [pickles](https://github.com/liberapay/liberapay.com/blob/8546e2212f08f0d0ad71008ccf679744c3e8fb81/liberapay/utils/__init__.py#L370), which is known to be unsafe. You can basically craft any object, and pickles will happily execute the object. This allows unsafe deserialization, which could lead to Remote Code Execution.\n\nIn this case, as far as I have seen, it is used for notifications. As far as I have seen, the deserializer is only used to render notifications, in `render_notifications`, as seen [here](https://github.com/liberapay/liberapay.com/blob/8546e2212f08f0d0ad71008ccf679744c3e8fb81/liberapay/models/participant.py#L1083). \n\n```python\n  for id, event, notif_context, is_new, ts in notifs:\n            try:\n                notif_context = deserialize(notif_context)\n```\nThe `render_notifications` function is then used on the notifications template page, as seen here:\n\n```\n\n# NOTE: don't factor the render_notifications() call here, it'll break escaping\n\n[---] application/json via json_dump\nparticipant.render_notifications(state)\n\n[---] text/html\n% extends \"templates/base.html\"\n```\n\nThere is no other place where the deserializer is used, as far as I have seen. The serializer is used in the `notify` function, as seen [here](https://github.com/liberapay/liberapay.com/blob/9ad0dc79183b052df4e1ca5f23914450991f6888/liberapay/models/participant.py#L1010), thus, in the future, whenever unrestrictive input is taken from the user into this function, it will directly allow Remote Code Execution.\n\n**Proof of Concept**\n1. Invite an user into your team.\n2. Update the context of the notification in the table notifications, by running the SQL query:\n\nUPDATE notifications SET context = E'\\\\x80027d710028580400000061736432710158030000006c6f6c71025801000000627103580500000033303030307104580100000063710563706f7369780a73797374656d0a7106580c000000736c656570203530303030307107857108527109752e' WHERE id = 43;`\n\n3. Log in as the user who is invited to your team, browse to notifications and notices that the sleep command was used (basically, it will hang).\n\n## Impact\n\nThis could allow remote code execution if a SQL injection is escalated.",
  "weakness": {
    "id": 52,
    "name": "Deserialization of Untrusted Data"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2018-07-04T17:30:23.719Z",
  "allow_singular_disclosure_after": -177104104.8474515,
  "singular_disclosure_allowed": true,
  "vote_count": 16,
  "voters": [
    "europa",
    "kapytein",
    "emitrani",
    "savitar0x01",
    "apapedulimu",
    "edoverflow",
    "eveeez",
    "dz_samir",
    "ifrahiman",
    "grampae",
    "and 6 more..."
  ],
  "structured_scope": {
    "databaseId": 8927,
    "asset_type": "SOURCE_CODE",
    "asset_identifier": "https://github.com/liberapay/liberapay.com",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "id": 7614,
      "category": "researcher",
      "content": "This issue is only exploitable in case of a SQL injection. In the first case, I thought that this was not exploitable due to the fact that there were certain username restrictions. I removed them, took a closer look, and later noticed that this was not exploitable because of other reasons, as further explained in my second comment on this report.\n\nI visualized my observations, which made me conclude that this is not exploitable.\n{F305081}",
      "user": {
        "id": 193843,
        "username": "kapytein",
        "name": "Nadir<b>",
        "bio": "",
        "cleared": true,
        "verified": true,
        "website": null,
        "location": "The Netherlands",
        "created_at": "2017-08-22T12:31:00.275Z",
        "url": "https://hackerone.com/kapytein",
        "hackerone_triager": false,
        "hackerone_employee": false,
        "user_type": "hacker",
        "profile_picture_urls": {
          "small": "https://profile-photos.hackerone-user-content.com/variants/36yjb4mltb4jebgvw3esuaw059a0/ede8cd84a64d5392a2bb88ecb598721116469c27c015c2caa77148f11e211d58",
          "medium": "https://profile-photos.hackerone-user-content.com/variants/36yjb4mltb4jebgvw3esuaw059a0/fd3465a1d18de709ef6a7a4daaffea9f69b778e9708be2cc15159c7bef911a89",
          "xtralarge": "https://profile-photos.hackerone-user-content.com/variants/36yjb4mltb4jebgvw3esuaw059a0/d7b0d969b6320751e1c58b9e3efff1e228054ee3d8eade5c51c4c79b25513a9c"
        }
      },
      "can_view?": true,
      "can_create?": false,
      "attachments": []
    }
  ]
}
